function setCookie(n,t,i){var r=new Date,u;r.setTime(r.getTime()+i*864e5);u="expires="+r.toGMTString();document.cookie=n+"="+t+";"+u+";path=/"}function getCookie(n){var u=n+"=",f=document.cookie,r,i,t;try{f=decodeURIComponent(document.cookie)}catch(e){console.log(e)}for(r=f.split(";"),i=0;i<r.length;i++){for(t=r[i];t.charAt(0)==" ";)t=t.substring(1);if(t.indexOf(u)==0)return t.substring(u.length,t.length)}}function GetNumber(n){return parseFloat(n.toString().replace(/,/g,""))}function LoadPage(){var n=document.getElementById("all_invoice"),t=n.scrollTop,i=$("#all_invoice").height(),r=$(document).height(),u=$("#nofify-footer-bar").height();t+i>=r-u+x&&(x+=200,window.GetInvoice())}function DeleteFile(n){n.remove()}function CheckFile(n){function a(n){return n<1048576?Math.round(n/1024)+" KB":Math.round(n/1048576)+" MB"}var f=[],o=".xls,.xlsx,.doc,.docx,.pdf, .txt, .xml".split(","),i,e,r,l,u,t;if(n.length>0){for(i=0,e=10485760,t=0;t<n.length;t++){var s=n[t].name,h=s.substr(s.lastIndexOf(".")),c=!1;for(r=0;r<o.length;r++)if(l=o[r],h.toLowerCase()==l){c=!0;break}if(!c)return alert("Bạn không được chọn file định dạng "+h),!1;if(u=n[t].size,u>e)return alert("File <b>"+n[t].name+"<\/b> có dung lượng <b>"+a(u)+"<\/b>. Bạn không được chọn file có dung lượng lớn hơn <b>10 MB<\/b>."),!1;i=i+u}for(t=0;t<f.length;t++)i=i+f[t].size;if(i>e)return alert("Tổng dung lượng các file bạn đã chọn là <b>"+a(i)+"<\/b>. Bạn không được Attach file có tổng dung lượng lớn hơn <b>10 MB<\/b>."),!1;for(t=0;t<n.length;t++)f.push(n[t]);return!0}}function AjaxRequest(n,t,i,r,u,f,e){$.ajax({url:n==undefined?"":n,data:t==undefined?"":JSON.stringify(t),type:i==undefined?"POST":i,async:r==undefined?!0:r,contentType:"application/json; charset=utf-8",dataType:u==undefined?"json":u,success:function(n){if(n.hasOwnProperty("rs")&&n.hasOwnProperty("msg"))if(n.rs)f!==undefined&&typeof f=="function"&&f(n);else{if(e!==undefined&&typeof e=="function"){e(n);return}alert(n.msg)}else f!==undefined&&typeof f=="function"&&f(n)},error:function(n,t){if(e!==undefined&&typeof e=="function"&&e(),n.status==403||n.status==500){alert("Đã hết phiên làm việc. Bạn bấm <b>Đăng nhập lại<\/b> để trở về trang đăng nhập.");return}console.log(n);var i=n.responseText!=undefined?n.responseText:t;alert("Có lỗi xảy ra. Xin vui lòng thử lại sau hoặc thông báo với quản trị (Error: "+i+").")}})}function splitArr(n,t){return n.slice(t*50,(t+1)*50)}function See_more_invoice(){$("#id1").css("display","none");$("#id2").css("display","block")}function Collapse_invoice(){$("#id2").css("display","none");$("#id1").css("display","block")}function See_more_invoice_wating(){$("#id3").css("display","none");$("#id4").css("display","block")}function Collapse_invoice_wating(){$("#id4").css("display","none");$("#id3").css("display","block")}function ChangeSizeIframe(){frames.$("body").style.fontSize="11px"}function See_more_Pro(){$("#id1").css("display","none");$("#id2").css("display","block")}function Collapse_Pro(){$("#id2").css("display","none");$("#id1").css("display","block")}function See_more_Cus(){$("#id1").css("display","none");$("#id2").css("display","block")}function Collapse_Cus(){$("#id2").css("display","none");$("#id1").css("display","block")}function setSelectedValueDropdown(n,t){var i;n===2?(i=$("#ddlMeter option:first"),i&&i.length>0&&(i.html(t),i.attr("value",t))):n===4&&(i=$("#ddlMeter2 option:first"),i&&i.length>0&&(i.html(t),i.attr("value",t)))}function xoa_dau(n){return n=n.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g,"a"),n=n.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g,"e"),n=n.replace(/ì|í|ị|ỉ|ĩ/g,"i"),n=n.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g,"o"),n=n.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g,"u"),n=n.replace(/ỳ|ý|ỵ|ỷ|ỹ/g,"y"),n=n.replace(/đ/g,"d"),n=n.replace(/À|Á|Ạ|Ả|Ã|Â|Ầ|Ấ|Ậ|Ẩ|Ẫ|Ă|Ằ|Ắ|Ặ|Ẳ|Ẵ/g,"A"),n=n.replace(/È|É|Ẹ|Ẻ|Ẽ|Ê|Ề|Ế|Ệ|Ể|Ễ/g,"E"),n=n.replace(/Ì|Í|Ị|Ỉ|Ĩ/g,"I"),n=n.replace(/Ò|Ó|Ọ|Ỏ|Õ|Ô|Ồ|Ố|Ộ|Ổ|Ỗ|Ơ|Ờ|Ớ|Ợ|Ở|Ỡ/g,"O"),n=n.replace(/Ù|Ú|Ụ|Ủ|Ũ|Ư|Ừ|Ứ|Ự|Ử|Ữ/g,"U"),n=n.replace(/Ỳ|Ý|Ỵ|Ỷ|Ỹ/g,"Y"),n.replace(/Đ/g,"D")}function CheckDate(n,t,i,r){var f={messErrorForCustomer:"",messErrorForCoder:"",result:!0},u;return n===undefined||n.length==0?r&&(f.result=!1,f.messErrorForCustomer=t+" không được để trống",f.messErrorForCoder=t+" không được để trống"):(n.indexOf("-")!=-1&&n.replace("-","/"),u=n.split("/"),(parseInt(u[0])>31||parseInt(u[0])<0||parseInt(u[1])>12||parseInt(u[1])<0||u[1].length>2||u[0].length>2||u[2].length>4||u[1].length<0||u[0].length<0||u[2].length<0)&&(f.result=!1,f.messErrorForCustomer="Ngày không đúng định dạng dd/mm/yyyy",f.messErrorForCoder="Ngày không đúng định dạng dd/mm/yyyy")),f}function compareDates(n,t,i){var r={messErrorForCustomer:"",messErrorForCoder:"",result:!0},u=t.split("/"),f=n.split("/"),e=new Date(u[2]+"-"+u[1]+"-"+u[0]),o=new Date(f[2]+"-"+f[1]+"-"+f[0]),s=new Date(o).getTime(),h=new Date(e).getTime(),c=h-s;return c<0&&(r.result=!1,r.messErrorForCustomer=i,r.messErrorForCoder=i),r}function FormatDateTimeFromAjax(n,t){var i=new Date(parseInt(n.replace(/(^.*\()|([+-].*$)/g,"")));return FormatDateTime(i,t)}function FormatDateTime(n,t){var i=n.getDate(),r=n.getMonth()+1,u=n.getHours(),f=n.getMinutes(),e=n.getSeconds();return t.replace("dd",i<10?"0"+i:i).replace("MM",r<10?"0"+r:r).replace("yyyy",n.getFullYear()).replace("HH",u<10?"0"+u:u).replace("mm",f<10?"0"+f:f).replace("ss",e<10?"0"+e:e)}function ConvertDateShowToDate(n){var t=n.split("/");if(t.length==3){var i=Number(t[2]),r=Number(t[1]),u=Number(t[0]);return i+"-"+r+"-"+u}}function AddDaysToDate(n,t){var i=new Date(n).getTime()+t*864e5;return new Date(i)}function formatMoney(n,t,i,r){t=isNaN(t=Math.abs(t))?2:t;i=typeof i=="undefined"?".":i;r=typeof r=="undefined"?",":r;var e=n<0?"-":"",f=String(parseInt(n=Math.abs(Number(n)||0).toFixed(t))),u=(u=f.length)>3?u%3:0;return e+(u?f.substr(0,u)+r:"")+f.substr(u).replace(/(\decSep{3})(?=\decSep)/g,"$1"+r)+(t?i+Math.abs(n-f).toFixed(t).slice(2):"")}function formatMoney(n,t=2,i=".",r=","){try{t=Math.abs(t);t=isNaN(t)?2:t;const e=n<0?"-":"";let u=parseInt(n=Math.abs(Number(n)||0).toFixed(t)).toString(),f=u.length>3?u.length%3:0;return e+(f?u.substr(0,f)+r:"")+u.substr(f).replace(/(\d{3})(?=\d)/g,"$1"+r)+(t?i+Math.abs(n-u).toFixed(t).slice(2):"")}catch(u){console.log(u)}}function AjaxRequest(n,t,i,r,u,f,e){LoadingShow();$.ajax({url:n==undefined?"":n,data:t==undefined?"":JSON.stringify(t),type:i==undefined?"POST":i,async:r==undefined?!0:r,contentType:"application/json; charset=utf-8",dataType:u==undefined?"json":u,success:function(n){if(n.hasOwnProperty("rs")&&n.hasOwnProperty("msg"))if(n.rs)f!==undefined&&typeof f=="function"&&f(n);else{if(e!==undefined&&typeof e=="function"){e(n);return}alert(n.msg)}else f!==undefined&&typeof f=="function"&&f(n)},error:function(n,t){if(e!==undefined&&typeof e=="function"&&e(),n.status==403||n.status==500){alert("Đã hết phiên làm việc. Bạn bấm <b>Đăng nhập lại<\/b> để trở về trang đăng nhập.");return}console.log(n);var i=n.responseText!=undefined?n.responseText:t;alert("Có lỗi xảy ra. Xin vui lòng thử lại sau hoặc thông báo với quản trị (Error: "+i+").")}})}function AjaxRequest(n,t,i,r,u,f,e){LoadingShow();$.ajax({url:n==undefined?"":n,data:t==undefined?"":JSON.stringify(t),type:i==undefined?"POST":i,async:r==undefined?!0:r,contentType:"application/json; charset=utf-8",dataType:u==undefined?"json":u,success:function(n){if(n.hasOwnProperty("rs")&&n.hasOwnProperty("msg"))if(n.rs)f!==undefined&&typeof f=="function"&&f(n);else{if(e!==undefined&&typeof e=="function"){e(n);return}alert(n.msg)}else f!==undefined&&typeof f=="function"&&f(n);LoadingHide()},error:function(n,t){if(LoadingHide(),e!==undefined&&typeof e=="function"&&e(),n.status==403||n.status==500){alert("Đã hết phiên làm việc. Bạn bấm <b>Đăng nhập lại<\/b> để trở về trang đăng nhập.");return}console.log(n);var i=n.responseText!=undefined?n.responseText:t;alert("Có lỗi xảy ra. Xin vui lòng thử lại sau hoặc thông báo với quản trị (Error: "+i+").")}})}function CheckFile(n){function a(n){return n<1048576?Math.round(n/1024)+" KB":Math.round(n/1048576)+" MB"}var f=[],o=".xls,.xlsx".split(","),i,e,r,l,u,t;if(n.length>0){for(i=0,e=5242880,t=0;t<n.length;t++){var s=n[t].name,h=s.substr(s.lastIndexOf(".")),c=!1;for(r=0;r<o.length;r++)if(l=o[r],h.toLowerCase()==l){c=!0;break}if(!c)return alert("Bạn không được chọn file định dạng "+h),!1;if(u=n[t].size,u>e)return alert("File <b>"+n[t].name+"<\/b> có dung lượng <b>"+a(u)+"<\/b>. Bạn không được chọn file có dung lượng lớn hơn <b>5 MB<\/b>."),!1;i=i+u}for(t=0;t<f.length;t++)i=i+f[t].size;if(i>e)return alert("Tổng dung lượng các file bạn đã chọn là <b>"+a(i)+"<\/b>. Bạn không được Attach file có tổng dung lượng lớn hơn <b>5 MB<\/b>."),!1;for(t=0;t<n.length;t++)f.push(n[t]);return!0}}function DeleteFile(n){n.remove()}function CheckFile(n){function a(n){return n<1048576?Math.round(n/1024)+" KB":Math.round(n/1048576)+" MB"}var f=[],o=".xls,.xlsx,.doc,.docx,.pdf, .txt, .xml".split(","),i,e,r,l,u,t;if(n.length>0){for(i=0,e=10485760,t=0;t<n.length;t++){var s=n[t].name,h=s.substr(s.lastIndexOf(".")),c=!1;for(r=0;r<o.length;r++)if(l=o[r],h.toLowerCase()==l){c=!0;break}if(!c)return alert("Bạn không được chọn file định dạng "+h),!1;if(u=n[t].size,u>e)return alert("File <b>"+n[t].name+"<\/b> có dung lượng <b>"+a(u)+"<\/b>. Bạn không được chọn file có dung lượng lớn hơn <b>10 MB<\/b>."),!1;i=i+u}for(t=0;t<f.length;t++)i=i+f[t].size;if(i>e)return alert("Tổng dung lượng các file bạn đã chọn là <b>"+a(i)+"<\/b>. Bạn không được Attach file có tổng dung lượng lớn hơn <b>10 MB<\/b>."),!1;for(t=0;t<n.length;t++)f.push(n[t]);return!0}}function xoa_dau(n){return n=n.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g,"a"),n=n.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g,"e"),n=n.replace(/ì|í|ị|ỉ|ĩ/g,"i"),n=n.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g,"o"),n=n.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g,"u"),n=n.replace(/ỳ|ý|ỵ|ỷ|ỹ/g,"y"),n=n.replace(/đ/g,"d"),n=n.replace(/À|Á|Ạ|Ả|Ã|Â|Ầ|Ấ|Ậ|Ẩ|Ẫ|Ă|Ằ|Ắ|Ặ|Ẳ|Ẵ/g,"A"),n=n.replace(/È|É|Ẹ|Ẻ|Ẽ|Ê|Ề|Ế|Ệ|Ể|Ễ/g,"E"),n=n.replace(/Ì|Í|Ị|Ỉ|Ĩ/g,"I"),n=n.replace(/Ò|Ó|Ọ|Ỏ|Õ|Ô|Ồ|Ố|Ộ|Ổ|Ỗ|Ơ|Ờ|Ớ|Ợ|Ở|Ỡ/g,"O"),n=n.replace(/Ù|Ú|Ụ|Ủ|Ũ|Ư|Ừ|Ứ|Ự|Ử|Ữ/g,"U"),n=n.replace(/Ỳ|Ý|Ỵ|Ỷ|Ỹ/g,"Y"),n.replace(/Đ/g,"D")}function InputLimiter(n,t){var u="",i,r;return u=t=="Letters"?" ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz":t=="Numbers"?"1234567890":t=="NameCharacters"?" ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-.'":t=="NameCharactersAndNumbers"?"1234567890 ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-'":t=="09az"?"1234567890ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz":t,i=document.all?parseInt(n.keyCode):parseInt(n.which),i!=13&&i!=8&&i!=0?n.ctrlKey==!1&&n.altKey==!1?(r=u.indexOf(String.fromCharCode(i))!=-1,r||Beep(),r):!0:!0}function ReadNumber(n){var t=JSON.stringify({number:parseFloat(n),kindOfMoney:"VND"});$.ajax({type:"POST",url:"/Receipt/ReadNumberToWords",contentType:"application/json; charset=utf-8;",dataType:"json",processData:!0,data:t,success:function(n){$("#AmountInWords").html(n.data)},error:function(){LoadingHide()}})}function UpdateFormat(n,t){t===undefined&&(t=ParseVietnameseNumber($(n).val()),t===!1&&(t=$(n).val()));t=FormatVietnameseNumber(t);t!==!1&&$(n).val(t);ReadNumber(ParseVietnameseNumber($(n).val()))}function ParseVietnameseNumber(n){if(!ValidateVietnameseNumber(n))return!1;var t=n.toString().replace(/\./g,"").replace(/\,/g,".");return(n=parseFloat(t),isNaN(n))?!1:n}function ValidateVietnameseNumber(n){var r,t,u;if(n===undefined||(n=n.toString(),r=n.split(","),r.length>2)||r.length==2&&r[1].indexOf(".")>=0)return!1;for(i=0;i<r.length;i++)if(r[i].length==0)return!1;if(t=n.split("."),t.length==1)return!isNaN(t[0].replace(/\,/g,"."));for(i=0;i<t.length;i++)if(t[i].length==0||(u="first",i>0&&i<t.length-1?u="middle":i>0&&i==t.length-1&&(u="last"),!CheckPartVietnameseNumber(u,t[i])))return!1;return!0}function CheckPartVietnameseNumber(n,t){var i=t.indexOf(","),r;if(n=="first"){if(t.length>3||i>=0)return!1}else if(n=="middle"){if(t.length!=3||i>=0)return!1}else if(n=="last"){if(r=t.split(","),r[0].length!=3)return!1;t=t.replace(",",".")}else return!1;return!isNaN(t)}function Comma(n){n+="";n=n.replace(".","");n=n.replace(".","");n=n.replace(".","");n=n.replace(".","");n=n.replace(".","");n=n.replace(".","");x=n.split(",");x1=x[0];x2=x.length>1?","+x[1]:"";for(var t=/(\d+)(\d{3})/;t.test(x1);)x1=x1.replace(t,"$1.$2");return x1+x2}function replaceAll(n,t,i){var r=n.toString().split(t);return r.join(i)}function formatCurrency(n){var t=n%1;if(t>0)return n.formatMoney(2,",",".")}function formatCurrency(n,t){var i=n%1;return i>0?n.formatMoney(t,",","."):n.formatMoney(0,",",".")}function FormatVietnameseNumber(n){var r,t,i;if(isNaN(n))return!1;for(r=n.toString().split("."),n="",t=r[0];t.length>0;)i=t.length-3,i<0&&(i=0),n.length>0&&(n="."+n),n=t.substring(i)+n,t=t.substring(0,i);return r.length>1&&(n=n+","+r[1]),n}function Beep(){var n=new Audio("data:audio/wav;base64,//uQRAAAAWMSLwUIYAAsYkXgoQwAEaYLWfkWgAI0wWs/ItAAAGDgYtAgAyN+QWaAAihwMWm4G8QQRDiMcCBcH3Cc+CDv/7xA4Tvh9Rz/y8QADBwMWgQAZG/ILNAARQ4GLTcDeIIIhxGOBAuD7hOfBB3/94gcJ3w+o5/5eIAIAAAVwWgQAVQ2ORaIQwEMAJiDg95G4nQL7mQVWI6GwRcfsZAcsKkJvxgxEjzFUgfHoSQ9Qq7KNwqHwuB13MA4a1q/DmBrHgPcmjiGoh//EwC5nGPEmS4RcfkVKOhJf+WOgoxJclFz3kgn//dBA+ya1GhurNn8zb//9NNutNuhz31f////9vt///z+IdAEAAAK4LQIAKobHItEIYCGAExBwe8jcToF9zIKrEdDYIuP2MgOWFSE34wYiR5iqQPj0JIeoVdlG4VD4XA67mAcNa1fhzA1jwHuTRxDUQ//iYBczjHiTJcIuPyKlHQkv/LHQUYkuSi57yQT//uggfZNajQ3Vmz+Zt//+mm3Wm3Q576v////+32///5/EOgAAADVghQAAAAA//uQZAUAB1WI0PZugAAAAAoQwAAAEk3nRd2qAAAAACiDgAAAAAAABCqEEQRLCgwpBGMlJkIz8jKhGvj4k6jzRnqasNKIeoh5gI7BJaC1A1AoNBjJgbyApVS4IDlZgDU5WUAxEKDNmmALHzZp0Fkz1FMTmGFl1FMEyodIavcCAUHDWrKAIA4aa2oCgILEBupZgHvAhEBcZ6joQBxS76AgccrFlczBvKLC0QI2cBoCFvfTDAo7eoOQInqDPBtvrDEZBNYN5xwNwxQRfw8ZQ5wQVLvO8OYU+mHvFLlDh05Mdg7BT6YrRPpCBznMB2r//xKJjyyOh+cImr2/4doscwD6neZjuZR4AgAABYAAAABy1xcdQtxYBYYZdifkUDgzzXaXn98Z0oi9ILU5mBjFANmRwlVJ3/6jYDAmxaiDG3/6xjQQCCKkRb/6kg/wW+kSJ5//rLobkLSiKmqP/0ikJuDaSaSf/6JiLYLEYnW/+kXg1WRVJL/9EmQ1YZIsv/6Qzwy5qk7/+tEU0nkls3/zIUMPKNX/6yZLf+kFgAfgGyLFAUwY//uQZAUABcd5UiNPVXAAAApAAAAAE0VZQKw9ISAAACgAAAAAVQIygIElVrFkBS+Jhi+EAuu+lKAkYUEIsmEAEoMeDmCETMvfSHTGkF5RWH7kz/ESHWPAq/kcCRhqBtMdokPdM7vil7RG98A2sc7zO6ZvTdM7pmOUAZTnJW+NXxqmd41dqJ6mLTXxrPpnV8avaIf5SvL7pndPvPpndJR9Kuu8fePvuiuhorgWjp7Mf/PRjxcFCPDkW31srioCExivv9lcwKEaHsf/7ow2Fl1T/9RkXgEhYElAoCLFtMArxwivDJJ+bR1HTKJdlEoTELCIqgEwVGSQ+hIm0NbK8WXcTEI0UPoa2NbG4y2K00JEWbZavJXkYaqo9CRHS55FcZTjKEk3NKoCYUnSQ0rWxrZbFKbKIhOKPZe1cJKzZSaQrIyULHDZmV5K4xySsDRKWOruanGtjLJXFEmwaIbDLX0hIPBUQPVFVkQkDoUNfSoDgQGKPekoxeGzA4DUvnn4bxzcZrtJyipKfPNy5w+9lnXwgqsiyHNeSVpemw4bWb9psYeq//uQZBoABQt4yMVxYAIAAAkQoAAAHvYpL5m6AAgAACXDAAAAD59jblTirQe9upFsmZbpMudy7Lz1X1DYsxOOSWpfPqNX2WqktK0DMvuGwlbNj44TleLPQ+Gsfb+GOWOKJoIrWb3cIMeeON6lz2umTqMXV8Mj30yWPpjoSa9ujK8SyeJP5y5mOW1D6hvLepeveEAEDo0mgCRClOEgANv3B9a6fikgUSu/DmAMATrGx7nng5p5iimPNZsfQLYB2sDLIkzRKZOHGAaUyDcpFBSLG9MCQALgAIgQs2YunOszLSAyQYPVC2YdGGeHD2dTdJk1pAHGAWDjnkcLKFymS3RQZTInzySoBwMG0QueC3gMsCEYxUqlrcxK6k1LQQcsmyYeQPdC2YfuGPASCBkcVMQQqpVJshui1tkXQJQV0OXGAZMXSOEEBRirXbVRQW7ugq7IM7rPWSZyDlM3IuNEkxzCOJ0ny2ThNkyRai1b6ev//3dzNGzNb//4uAvHT5sURcZCFcuKLhOFs8mLAAEAt4UWAAIABAAAAAB4qbHo0tIjVkUU//uQZAwABfSFz3ZqQAAAAAngwAAAE1HjMp2qAAAAACZDgAAAD5UkTE1UgZEUExqYynN1qZvqIOREEFmBcJQkwdxiFtw0qEOkGYfRDifBui9MQg4QAHAqWtAWHoCxu1Yf4VfWLPIM2mHDFsbQEVGwyqQoQcwnfHeIkNt9YnkiaS1oizycqJrx4KOQjahZxWbcZgztj2c49nKmkId44S71j0c8eV9yDK6uPRzx5X18eDvjvQ6yKo9ZSS6l//8elePK/Lf//IInrOF/FvDoADYAGBMGb7FtErm5MXMlmPAJQVgWta7Zx2go+8xJ0UiCb8LHHdftWyLJE0QIAIsI+UbXu67dZMjmgDGCGl1H+vpF4NSDckSIkk7Vd+sxEhBQMRU8j/12UIRhzSaUdQ+rQU5kGeFxm+hb1oh6pWWmv3uvmReDl0UnvtapVaIzo1jZbf/pD6ElLqSX+rUmOQNpJFa/r+sa4e/pBlAABoAAAAA3CUgShLdGIxsY7AUABPRrgCABdDuQ5GC7DqPQCgbbJUAoRSUj+NIEig0YfyWUho1VBBBA//uQZB4ABZx5zfMakeAAAAmwAAAAF5F3P0w9GtAAACfAAAAAwLhMDmAYWMgVEG1U0FIGCBgXBXAtfMH10000EEEEEECUBYln03TTTdNBDZopopYvrTTdNa325mImNg3TTPV9q3pmY0xoO6bv3r00y+IDGid/9aaaZTGMuj9mpu9Mpio1dXrr5HERTZSmqU36A3CumzN/9Robv/Xx4v9ijkSRSNLQhAWumap82WRSBUqXStV/YcS+XVLnSS+WLDroqArFkMEsAS+eWmrUzrO0oEmE40RlMZ5+ODIkAyKAGUwZ3mVKmcamcJnMW26MRPgUw6j+LkhyHGVGYjSUUKNpuJUQoOIAyDvEyG8S5yfK6dhZc0Tx1KI/gviKL6qvvFs1+bWtaz58uUNnryq6kt5RzOCkPWlVqVX2a/EEBUdU1KrXLf40GoiiFXK///qpoiDXrOgqDR38JB0bw7SoL+ZB9o1RCkQjQ2CBYZKd/+VJxZRRZlqSkKiws0WFxUyCwsKiMy7hUVFhIaCrNQsKkTIsLivwKKigsj8XYlwt/WKi2N4d//uQRCSAAjURNIHpMZBGYiaQPSYyAAABLAAAAAAAACWAAAAApUF/Mg+0aohSIRobBAsMlO//Kk4soosy1JSFRYWaLC4qZBYWFRGZdwqKiwkNBVmoWFSJkWFxX4FFRQWR+LsS4W/rFRb/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////VEFHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAU291bmRib3kuZGUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMjAwNGh0dHA6Ly93d3cuc291bmRib3kuZGUAAAAAAAAAACU=");n.play()}function See_more_meter(){$("#id1").css("display","none");$("#id2").css("display","block")}function Collapse_meter(){$("#id2").css("display","none");$("#id1").css("display","block")}function parseCSSText(n){var t=n.replace(/\/\*(.|\s)*?\*\//g," ").replace(/\s+/g," "),i={},[,f,e]=t.match(/ ?(.*?) ?{([^}]*)}/)||[,,t],o=n=>n.replace(/\W+\w/g,n=>n.slice(-1).toUpperCase()),s=e.split(";").map(n=>n.split(":").map(n=>n&&n.trim())),r,u;for([r,u]of s)i[o(r)]=u;return{cssText:n,ruleName:f,style:i}}function getCSS(n){var t=[];for(let i in n){let r=i+" {";for(let t in n[i])r+=t+":"+n[i][t]+";";r+="}";t.push(r)}return t.join("\n")}function reszieableLogo(){var n=$(".ui-icon-gripsmall-diagonal-se");n.css("position","absolute");n.css("width","8");n.css("height","8");n.css("background","#1492e6");n.css("right","-5px");n.css("bottom","-5px");n.css("cursor","se-resize");n.css("border","1px solid #fff")}function setResizable(){$(".logo").resizable({maxWidth:250,start:function(){$(this).data("dragging",!0)},stop:function(n){setTimeout(function(){$(n.target).data("dragging",!1)},1)}});$(".logo").draggable({start:function(){$(this).data("dragging",!0)},stop:function(n,t){var i=$("td-logo-company");i.width(t.helper.width()+t.position.left);setTimeout(function(){$(n.target).data("dragging",!1)},1)},drag:function(n,t){var i=$(n.target),r=POSITION_LOGO.Left;r==POSITION_LOGO.Left?(i.width()+t.position.left>=150&&(t.position.left=150-i.width()),t.position.left<0&&(t.position.left=0)):(t.position.left<-30&&(t.position.left=-30),t.position.left>0&&(t.position.left=0));Math.abs(t.position.top)+i.height()/2>80&&(t.position.top=t.position.top<0?i.height()/2-80:80-i.height()/2)}})}app.controller("RootController",["$scope","$rootScope","$http","CommonFactory","$interval","$timeout","$location","permissions",function(n,t,i,r,u,f,e,o){function k(){var n=JSON.stringify({});r.PostDataAjax("/Account/RefreshSession",n,function(n){n?n.rs||(u.cancel(stopRequest),window.location.href.indexOf("Account/Login")===-1&&(window.location.href="/Account/Login")):alert("Lỗi không nhận được phản hồi - RefreshSession (js) ")})}var c="/Root/",a,v,y,p,w;LoadingShow();angular.element(function(){t.GetFormCode();f(function(){t.GetEnterpriseInfo();n.LoadDashboard();t.GetSymbolCode();t.GetPaymentStatus();t.GetInvoiceStatus();t.GetPaymentMethod();t.GetQuantityUnit()},1500)});n.$on("$routeChangeSuccess",function(){gtag("config","UA-154152339-1",{page_path:e.path()})});t.CurrentURL=e.absUrl();t.OpenImportInvoiceModal=function(){$(".import-invoice").modal("show")};t.OpenImportProductModal=function(){$(".import-product").modal("show")};t.OpenImportCustomerModal=function(){$(".import-customer").modal("show")};t.OpenPreviewInvoiceModal=function(){$(".modal-preview-invoice").modal("show")};t.OpenImportMeterModal=function(){$(".import-meter").modal("show")};n.LoadDashboard=function(){var t=JSON.stringify({});r.PostDataAjax("/Invoice/LoadDashboard",t,function(t){t?t.rs&&(n.TotalMoneyPaied=t.TotalMoneyPaied,n.TotalMoneyNotApproval=t.TotalMoneyNotApproval,n.TotalInvoiceSigned=t.totalInvoiceSigned):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetProvince")})};t.GetCurrencyUnit=function(){var n=c+"GetCurrencyUnit",i=JSON.stringify({});r.PostDataAjax(n,i,function(n){n?n.rs?t.ListCurrencyUnit=n.result:t.ErrorMessage=n.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetCurrencyUnit")})};t.GetCategory=function(){var n=c+"GetCategory",i=JSON.stringify({});r.PostDataAjax(n,i,function(n){n?n.rs?t.ListCategory=n.result:t.ErrorMessage=n.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetCategory")})};t.GetInvoiceStatus=function(){if(!t.ListInvoiceStatus){var n=c+"GetInvoiceStatus",i=JSON.stringify({});r.PostDataAjax(n,i,function(n){n?n.rs?(t.ListInvoiceStatus=n.result,t.ListReceiptStatus=n.result):t.ErrorMessage=n.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetInvoiceStatus")})}};t.GetInvoiceType=function(){if(!t.ListInvoiceType){var n=c+"GetInvoiceType",i=JSON.stringify({});r.PostDataAjax(n,i,function(n){n?n.rs?t.ListInvoiceType=n.result:t.ErrorMessage=n.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetInvoiceType")})}};t.GetPaymentMethod=function(){var n=c+"GetPaymentMethod",i=JSON.stringify({});r.PostDataAjax(n,i,function(n){n?n.rs?(t.ListPaymentMethod=n.result,t.ListPaymentStatus=n.result):t.ErrorMessage=n.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetPaymentMethod")})};t.GetPaymentStatus=function(){if(!t.ListPaymentStatus){var n=c+"GetPaymentStatus",i=JSON.stringify({});r.PostDataAjax(n,i,function(n){n?n.rs?t.ListPaymentStatus=n.result:t.ErrorMessage=n.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetPaymentStatus")})}};t.GetQuantityUnit=function(){var n=c+"GetQuantityUnit",i=JSON.stringify({});r.PostDataAjax(n,i,function(n){n?n.rs?t.ListQuantityUnit=n.result:t.ErrorMessage=n.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetQuantityUnit")})};t.GetFormCode=function(){if(!t.ListFormCode){var n=c+"GetFormCode",i=JSON.stringify({});r.PostDataAjax(n,i,function(n){n?n.rs?t.ListFormCode=n.result:t.ErrorMessage=n.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetFormCode")})}};t.GetSymbolCode=function(){if(!t.ListSymbolCode){var n=c+"GetSymbolCode",i=JSON.stringify({});r.PostDataAjax(n,i,function(n){n?n.rs?t.ListSymbolCode=n.result:t.ErrorMessage=n.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetSymbolCode")})}};t.GetRoleDetailByCurrentUser=function(){var n=[],i=JSON.stringify({});r.PostDataAjax("/Account/GetRoleDetailByCurrentUser",i,function(i){i?i.rs&&(i.result.forEach(function(t){n.push(t.toString())}),t.CURRENT_USER_ROLE=n,o.setPermissions(n)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetRoleDetailByCurrentUser")})};t.GetRoleDetailByCurrentUser();t.GetEnterpriseInfo=function(){var i=JSON.stringify({});$.ajax({url:"/Settings/GetEnterpriseInfo",type:"POST",headers:{"X-Requested-With":"Novaon-DS","Token-String":"","Device-UUID":""},timeout:6e4,cache:!0,crossDomain:!0,contentType:"application/json; charset=utf-8;",dataType:"json",data:i,processData:!0,async:!1,tryCount:0,retryLimit:3,success:function(i){i?i.rs?(t.Enterprise=i.Company,t.UserInfo=i.User):(n.ErrorMessage=i.msg,alert(i.msg)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SettingsController - GetUserInfo")},error:function(){alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SettingsController - GetUserInfo")}})};var l=new Date,s=new Date,h=new Date,b=l.getDay();s.setDate(l.getDate()-b);h.setDate(s.getDate()+6);a=s.getFullYear()+"-"+(s.getMonth()+1)+"-"+s.getDate()+";"+h.getFullYear()+"-"+(h.getMonth()+1)+"-"+h.getDate();s.setDate(s.getDate()-7);h.setDate(h.getDate()-7);v=s.getFullYear()+"-"+(s.getMonth()+1)+"-"+s.getDate()+";"+h.getFullYear()+"-"+(h.getMonth()+1)+"-"+h.getDate();y=new Date(l.getFullYear(),l.getMonth()+1,0).getDate();s=new Date(l.getFullYear(),l.getMonth(),1);h=new Date(l.getFullYear(),l.getMonth(),y);p=s.getFullYear()+"-"+(s.getMonth()+1)+"-"+s.getDate()+";"+h.getFullYear()+"-"+(h.getMonth()+1)+"-"+h.getDate();h.setDate(s.getDate()-1);s=new Date(h.getFullYear(),h.getMonth(),1);w=s.getFullYear()+"-"+(s.getMonth()+1)+"-"+s.getDate()+";"+h.getFullYear()+"-"+(h.getMonth()+1)+"-"+h.getDate();n.Timepickers={value:a,Options:[{id:1,value:a,text:"Tuần này"},{id:2,value:v,text:"Tuần trước"},{id:3,value:p,text:"Tháng này"},{id:4,value:w,text:"Tháng trước"},{id:5,value:"5",text:"Tùy chọn"}]};n.clickButton=null;n.popupAlert=function(t){var i=$(t.currentTarget),f=i.width(),s=i.height(),e=i.offset(),r=$(i.attr("data-popup")),h=e.top+s+16,u=e.left,o;r.hasClass("flyout-right")?u-=f/2-7:r.hasClass("flyout-left")&&(u-=r.width()-f-10);r.css({top:h,left:u});o=$(".flyout-overview");$(".flyout-open").removeClass("flyout-open");i.is(n.clickButton)?n.clickButton=null:(i.addClass("flyout-open"),r.addClass("flyout-open"),o.addClass("flyout-open"),n.clickButton=i)};$(document).on("click",function(t){var i=$(t.target),r=i.closest(".flyout-button"),u=i.closest(".flyout-view");i.hasClass("flyout-button")||i.hasClass("flyout-view")||r.length?u.length&&setTimeout(function(){$(".flyout-open").removeClass("flyout-open");n.clickButton=null},300):($(".flyout-open").removeClass("flyout-open"),n.clickButton=null)});t.ToggleShowMore=function(n){$(n).fadeToggle(300)};t.SelectAll=function(n,t){var i=n.filter(function(n){return n.ISSELECTED==t});i.length>0&&i.forEach(function(n){n.ISSELECTED=!t})};$(function(){var n=$(".datepicker");n.datepicker({dateFormat:"dd/mm/yy"});SetVietNameInterface(n)});$(function(){$('[data-toggle="tooltip"]').tooltip()});$(function(){function t(t,f,o,s,h){var c,y,l,w,p,v,a;if(f||(f=i),o||(o=e),s||(s=u),c=document,!c.getElementById("modalContainer")){y=c.getElementsByTagName("body")[0].appendChild(c.createElement("div"));y.id="modalContainer";y.style.height=c.documentElement.scrollHeight+"px";l=y.appendChild(c.createElement("div"));l.id="alertBox";c.all&&!window.opera&&(l.style.top=document.documentElement.scrollTop+"px");l.style.left=(c.documentElement.scrollWidth-l.offsetWidth)/2+"px";l.style.visiblity="visible";w=l.appendChild(c.createElement("h1"));w.appendChild(c.createTextNode(f));var b=l.appendChild(c.createElement("p")),k=new RegExp("\n","g");b.innerHTML=t;h?(p=l.appendChild(c.createElement("div")),p.className="btnGroup",v=p.appendChild(c.createElement("button")),v.id="cancelBtnAlert",v.className="btn btn-light",v.appendChild(c.createTextNode(o)),v.href="#",v.onclick=function(){return n(),h(!1),!1},a=p.appendChild(c.createElement("button")),a.className="btn btn-success",a.appendChild(c.createTextNode(s)),a.href="#",a.onclick=function(){return n(),h(!0),!1}):(a=l.appendChild(c.createElement("button")),a.id="closeBtnAlert",a.className="btn btn-success",a.appendChild(c.createTextNode(r)),a.href="#",a.onclick=function(){return n(),!1});l.style.display="block"}}$(".main-sidebar ul.sidebar-menu li").click(function(){var n=$(this);$(".main-sidebar ul.sidebar-menu li").removeClass("active");n.hasClass("treeview")||$("body").removeClass("sidebar-open");n.addClass("active")});$(".full-overlay").click(function(){$(".sidebar-open").removeClass("sidebar-open");setTimeout(function(){$(".full-overlay").css({opacity:0});$(".full-overlay").css("z-index",-1)},300)});$(document).on("click",function(n){var t=$(n.target),i=t.closest(".flyout-button"),r=t.closest(".flyout-view");t.hasClass("flyout-button")||t.hasClass("flyout-view")||i.length?r.length&&setTimeout(function(){$(".flyout-open").removeClass("flyout-open")},300):$(".flyout-open").removeClass("flyout-open")});var i="THÔNG BÁO",r="Đồng ý",u="Đồng ý",e="Bỏ qua",n=function(){document.getElementsByTagName("body")[0].removeChild(document.getElementById("modalContainer"))};document.getElementById&&(window.alert=function(n){t(n,null)},window.confirm=function(n,i,r,u,f){t(n,i,r,u,f)});f(function(){var n=localStorage.getItem("novaon_comcode");n&&$("#show-checked_"+n.trim()).addClass("selected")})});stopRequest=u(k,6e5);t.USER_ROLE={THEM_MOI_HOA_DON:1,CAP_NHAT_HOA_DON:2,KY:3,XEM_HOA_DON:4,GUI_EMAIL:5,NGHIEP_VU_HOA_DON:6,IMPORT_EXCEL_HOA_DON:7,THEM_DAI_CHO:8,KY_DAI_CHO:9,THEM_MOI_KHACH_HANG:10,CHINH_SUA_KHACH_HANG:11,IMPORT_EXCEL_KHACH_HANG:12,THEM_MOI_HANG_HOA:13,CHINH_SUA_HANG_HOA:14,IMPORT_EXCEL_HANG_HOA:15,LOC:16,TAI_XUONG:17,CAP_NHAT_THONG_TIN_NGUOI_DUNG:18,PHAN_QUYEN_NGUOI_DUNG:19,THEM_MAU_HOA_DON:20};t.cleanAccents=function(n){return n=n.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g,"a"),n=n.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g,"e"),n=n.replace(/ì|í|ị|ỉ|ĩ/g,"i"),n=n.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g,"o"),n=n.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g,"u"),n=n.replace(/ỳ|ý|ỵ|ỷ|ỹ/g,"y"),n=n.replace(/đ/g,"d"),n=n.replace(/À|Á|Ạ|Ả|Ã|Â|Ầ|Ấ|Ậ|Ẩ|Ẫ|Ă|Ằ|Ắ|Ặ|Ẳ|Ẵ/g,"A"),n=n.replace(/È|É|Ẹ|Ẻ|Ẽ|Ê|Ề|Ế|Ệ|Ể|Ễ/g,"E"),n=n.replace(/Ì|Í|Ị|Ỉ|Ĩ/g,"I"),n=n.replace(/Ò|Ó|Ọ|Ỏ|Õ|Ô|Ồ|Ố|Ộ|Ổ|Ỗ|Ơ|Ờ|Ớ|Ợ|Ở|Ỡ/g,"O"),n=n.replace(/Ù|Ú|Ụ|Ủ|Ũ|Ư|Ừ|Ứ|Ự|Ử|Ữ/g,"U"),n=n.replace(/Ỳ|Ý|Ỵ|Ỷ|Ỹ/g,"Y"),n=n.replace(/Đ/g,"D"),n=n.replace(/\u0300|\u0301|\u0303|\u0309|\u0323/g,""),n.replace(/\u02C6|\u0306|\u031B/g,"")};t.SelectedCompany=function(n){var u,t,i;LoadingShow();u=localStorage.getItem("novaon_comcode");localStorage.setItem("novaon_comcode",n);t="/AjaxMethod/ResetSessionData";i=JSON.stringify({comTaxCode:n});r.PostDataAjax(t,i,function(n){n?(n.rs||alert(result.msg),window.location.reload()):alert("Lỗi không nhận được phản hồi - RefreshSession (js) ")});LoadingHide()};t.ChooseUsingInvoiceType=function(n,t){var f,i,u;LoadingShow();f=localStorage.getItem("novaon_comcode_usinginvoicetype");localStorage.setItem("novaon_comcode_usinginvoicetype",n);i="/AjaxMethod/SaveChangeUsingInvoiceType";u=JSON.stringify({typeid:n,typename:t});r.PostDataAjax(i,u,function(n){n?(n.rs||alert(result.msg),window.location.reload()):alert("Lỗi không nhận được phản hồi - RefreshSession (js) ")});LoadingHide()}}]);app.controller("HomeController",["$scope","$timeout","CommonFactory","$rootScope",function(n,t,i,r){var e="/Home/",o,u,s,f;n.ActiveTab=1;LoadingShow();angular.element(function(){LoadingHide()});n.DashboardType={value:"1",Options:[{value:"1",text:"Dashboard"},{value:"2",text:"Video"}]};n.ChangeDashboard=function(t){n.DashboardType.value=t};n.CheckEnterpriseInfor=function(){(!0&&r.UserInfo.EMAIL.includes("demo")||r.Enterprise.COMTAXCODE!=="0106579683-999")&&(r.Enterprise.ISFREETRIAL!==!0||getCookie("NovaonFreeTrial")!==!1&&getCookie("NovaonFreeTrial")!==undefined)||($(".modal-onboarding").modal("show"),n.Enterprise.COMTAXCODE="",n.Enterprise.COMNAME="",n.Enterprise.COMADDRESS="",n.Enterprise.COMPHONENUMBER="",n.Enterprise.COMEMAIL="",n.Enterprise.COMACCOUNTNUMBER="",n.Enterprise.COMBANKNAME="",n.Enterprise.COMLEGALNAME="",n.Enterprise.TAXDEPARTEMENTCODE="",n.Enterprise.TAXDEPARTEMENT="")};n.SetActiveTab=t=>{n.ActiveTab=n.ActiveTab+t};n.SaveEnterpriseInfo=function(){if(!n.Enterprise.COMTAXCODE){alert("Vui lòng nhập mã số thuế doanh nghiệp.");return}if(!n.Enterprise.COMNAME){alert("Vui lòng nhập tên doanh nghiệp.");return}if(!n.Enterprise.COMADDRESS){alert("Vui lòng nhập địa chỉ doanh nghiệp.");return}var t=e+"AddEnterpriseInfoFreeVersion",u=JSON.stringify({enterprise:n.Enterprise}),f=function(f){if(!f)return!1;i.PostDataAjax(t,u,function(t){t?t.rs?(alert("Cập nhật thông tin doanh nghiệp thành công!"),r.Enterprise.ISFREETRIAL=!0,setCookie("NovaonFreeTrial",!0,90)):alert('Doanh nghiệp với mã số thuế <b class="text-danger">'+n.Enterprise.COMTAXCODE+"<\/b> đã tồn tại."):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SaveEnterpriseInfo")})};confirm("Bạn có thực sự chắc chắn những thông tin trên đúng với doanh nghiệp của bạn? Bạn chỉ có thể cập nhật thông tin này <b class='text-danger'>1 lần duy nhất<\/b>.","Thông báo","Không","Có",f)};n.LoadInfoByTaxcode=function(){if(r.Enterprise.COMTAXCODE!=null&&r.Enterprise.COMTAXCODE!=""){var n="https://app.meinvoice.vn/Other/GetCompanyInfoByTaxCode?taxCode="+r.Enterprise.COMTAXCODE;$("#loadTaxinfo").load(n,function(n){var u=JSON.parse(n),i={};u.Data!=""&&(i=JSON.parse(u.Data));t(function(){i.companyName?(r.Enterprise.COMADDRESS=i.address,r.Enterprise.COMNAME=i.companyName.toUpperCase()):(r.Enterprise.COMNAME=null,r.Enterprise.COMADDRESS=null)})})}else r.Enterprise.COMNAME=null,r.Enterprise.COMADDRESS=null};n.ShowDateTimePopup=function(){$("#dateTimePopUp").dialog({modal:!0,resizable:!1,width:450,height:200,open:function(){$(this).dialog("option","title","Lọc theo thời gian")},beforeClose:function(){n.Timepickers.value=n.Timepickers.Options[0].value;t(function(){$("select.cb-select-time").selectpicker("refresh")},500)}})};n.LoadDashboard=function(){var r=n.Timepickers.value,o,s;n.Timepickers.value==5&&(r=moment(n.FROMTIME).format("YYYY-MM-DD")+";"+moment(n.TOTIME).format("YYYY-MM-DD"));o=e+"GetInvoice";s=JSON.stringify({dateRange:r});i.PostDataAjax(o,s,function(i){i&&(i.rs&&(n.TotalMoneyBeforVAT=i.TotalMoneyBeforVAT,n.TotalMoneyAfterVAT=i.TotalMoneyAfterVAT,n.TotalMoneyVAT=i.TotalMoneyVAT,t(function(){var n=[],t=[],r=[],e=[],o=[],s=[],h=[];i.chartData!=null&&(i.chartData.forEach(function(i){n.push(i.Date);t.push(i.BeforVAT);r.push(i.AfterVAT);e.push(i.VAT);o.push(i.CountUse);s.push(i.CountCancel);h.push(i.CountReplace)}),u.updateOptions({xaxis:{categories:n}}),u.updateSeries([{data:t},{data:r},{data:e}],!0),f.updateOptions({xaxis:{categories:n}}),f.updateSeries([{data:o},{data:s},{data:h}],!0))},100)),n.CheckEnterpriseInfor())})};n.LoadData=function(){n.Timepickers.value==5&&n.ShowDateTimePopup();n.LoadDashboard()};t(function(){$("select.cb-select-time").selectpicker()});o={chart:{height:350,type:"area",zoom:{enabled:!1}},dataLabels:{enabled:!0,formatter:function(n){return n.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,")}},stroke:{curve:"smooth",width:2},series:[{name:"Doanh thu trước thuế",data:[]},{name:"Doanh thu sau thuế",data:[]},{name:"Tiền thuế",data:[]}],colors:["#2CA01C","#3797D3","#24BAB5"],markers:{size:4},xaxis:{type:"datetime",categories:[]},tooltip:{x:{format:"dd/MM/yy"},y:{formatter:function(n){return n.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,")+" VND"}}},legend:{horizontalAlign:"center",position:"top"}};u=new ApexCharts(document.querySelector("#chart"),o);u.render();s={chart:{height:350,type:"bar",stacked:!0,zoom:{enabled:!1}},series:[{name:"Số hoá đơn sử dụng",data:[]},{name:"Số hoá đơn huỷ",data:[]},{name:"Số hoá đơn thay thế",data:[]}],xaxis:{type:"datetime",categories:[]},legend:{horizontalAlign:"center",position:"top"},fill:{opacity:1},tooltip:{y:{formatter:function(n){return n+" đơn"}}}};f=new ApexCharts(document.querySelector("#chart2"),s);f.render();n.SetDatepikerFromTime=function(){$("#pk_fromtime_home").datepicker({dateFormat:"yy-mm-dd",maxDate:new Date});SetVietNameInterface($("#pk_fromtime_home"))};n.SetDatepikerToTime=function(){var t=n.FROMTIME;$("#pk_totime_home").datepicker("option","minDate",t);$("#pk_totime_home").datepicker({dateFormat:"yy-mm-dd",minDate:new Date(t)});SetVietNameInterface($("#pk_totime_home"))}}]);app.controller("AccountController",["$scope","$timeout","CommonFactory","$http",function(){}]);app.controller("LogoutController",["$scope",function(){}]);app.controller("InvoiceController",["$scope","$rootScope","$timeout","CommonFactory","$location","$window","$sce",function(n,t,i,r,u,f){var e="/Invoice/",o;angular.element(function(){n.IsHSM=f.localStorage.getItem("novaon_kyso_hsm")});t.ListInvoiceChecked=[];n.Invoice={};n.LoadCookie_Invoice=function(){var t=getCookie("Novaon_InvoiceManagement");t?n.cookie=JSON.parse(t):(n.cookie={FieldID:!0,FieldBillDate:!0,FieldBillType:!0,FieldCustomer:!0,FieldFormCode:!0,FieldSymbolCode:!0,FieldNumber:!0,FieldInvoiceStatus:!0,FieldReferenceCode:!0,FieldPaymentStatus:!1,FieldTotalPayment:!0,FieldCustomerID:!0,FieldConsignmentID:!1,FieldExchangeRate:!1,FieldExchange:!1,FieldInvoiceNote:!1,FieldEmailPartner:!1,RowNum:10},setCookie("Novaon_InvoiceManagement",JSON.stringify(n.cookie),30))};n.Check=function(t,i){(n.cookie[i]=i=="RowNum"?t:!t,setCookie("Novaon_InvoiceManagement",JSON.stringify(n.cookie),30),i=="RowNum")&&(n.Tab.Wating?n.GetInvoiceWait(n.currentpage):n.GetInvoice(n.currentpage))};t.Tab={All:!0,Cancel:!1,Tranfer:!1,Change:!1,Replace:!1,ReleaseError:!1,Delete:!1,Wating:!1};t.InvoiceTabClick=function(t){n.Tab.All=!1;n.Tab.Cancel=!1;n.Tab.Tranfer=!1;n.Tab.Change=!1;n.Tab.Replace=!1;n.Tab.ReleaseError=!1;n.Tab.Delete=!1;n.Tab.Wating=!1;n.Filter={};n.ListInvoice=[];switch(t){case 1:n.Tab.All=!0;n.Filter={};n.GetInvoice(1);break;case 2:n.Tab.Cancel=!0;n.Filter={};n.GetInvoiceByStatus(INVOICE_TYPE.Cancel_Invoice,1,REPORT_TYPE.Cancel);break;case 3:n.Tab.Tranfer=!0;n.Filter.INVOICETYPE=4;n.GetInvoice(1);break;case 4:n.Tab.Change=!0;n.Filter={};n.GetInvoiceByStatus(INVOICE_TYPE.Modifield_Invoice,1,REPORT_TYPE.Change);break;case 5:n.Tab.Replace=!0;n.Filter={};n.GetInvoiceByStatus(INVOICE_TYPE.Replace_Invoice,1,REPORT_TYPE.Cancel);break;case 6:n.Tab.ReleaseError=!0;n.Filter={};n.GetInvoiceReleaseError(1);break;case 7:n.Tab.Delete=!0;n.Filter={};n.GetInvoiceDelete(1);break;case 8:n.Tab.Wating=!0;n.Filter={};n.GetInvoiceWait(1);break;default:n.Tab.All=!0}$(".dropdown-menu").removeClass("show")};t.ReloadInvoice=function(){u.path().toString().includes("/quan-ly-hoa-don")&&(n.Tab.Change?n.GetInvoiceByStatus(INVOICE_TYPE.Modifield_Invoice,1,REPORT_TYPE.Change):n.Tab.Replace?n.GetInvoiceByStatus(INVOICE_TYPE.Replace_Invoice,1,REPORT_TYPE.Cancel):n.Tab.Cancel?n.GetInvoiceByStatus(INVOICE_TYPE.Cancel_Invoice,1,REPORT_TYPE.Cancel):n.Tab.Wating?n.GetInvoiceWait(n.currentpage):n.Tab.Delete?n.GetInvoiceDelete(n.currentpage):n.Tab.ReleaseError?n.GetInvoiceReleaseError(n.currentpage):(n.ListInvoice=[],n.GetInvoice(n.currentpage)))};f.ReloadInvoice=function(){t.ReloadInvoice()};n.GetInvoice=function(t){var o,r,f,u;if(n.Filter||(n.Filter={}),n.Filter.TIME=="5"){if(n.FROMTIME=moment(n.FROMTIME).format("YYYY-MM-DD"),n.TOTIME=moment(n.TOTIME).format("YYYY-MM-DD"),n.FROMTIME>n.TOTIME){toastr.warning("Ngày bắt đầu phải nhỏ hơn ngày kết thúc");return}n.Filter.TIME=n.FROMTIME+";"+n.TOTIME;n.FROMTIME&&n.TOTIME||(n.Filter.TIME=n.Timepickers.Options[0].value)}if(parseInt(n.Filter.FROMNUMBER)>parseInt(n.Filter.TONUMBER)){toastr.warning("Số hóa đơn bắt đầu phải nhỏ hơn số hóa đơn kết thúc");return}n.LoadCookie_Invoice();(!t||t<=0)&&(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;o=e+"GetInvoice";n.cookie.RowNum||(n.cookie.RowNum=10);n.ListInvoice=[];n.TotalPages=1;n.TotalRow=1;successCallback=function(t){if(n.cookie.RowNum>=500){let i=t.result,r=i.splice(0,50);n.ListInvoice=r;n.$apply();setTimeout(()=>{function t(r){let u=i.splice(0,50);n.ListInvoice=n.ListInvoice.concat(u);n.$apply();r&&setTimeout(()=>{t(r-1)},25)}t(20)},450)}else i(function(){n.ListInvoice=t.result},n.cookie.RowNum*.5);n.TotalPages=t.TotalPages;n.TotalRow=t.TotalRow;n.FROMTIME="";n.TOTIME=""};AjaxRequest(o,{form:n.Filter,currentPage:n.currentpage,itemPerPage:n.cookie.RowNum},"POST",!0,"json",successCallback);n.FilterApply=[];for(r in n.Filter)n.Filter[r]!=null&&(f={key:r,value:n.Filter[r]},r=="INVOICESTATUS"&&(u=n.ListInvoiceStatus.filter(function(t){return t.INVOICESTATUSID==n.Filter[r]}),f.value=u[0].INVOICESTATUSNAME),r=="TIME"&&(u=n.Timepickers.Options.filter(function(t){return t.value==n.Filter[r]}),u.length>0&&(f.value=u[0].value)),r=="FORMCODE"&&(u=n.ListFormCode.filter(function(t){return t.FORMCODE==n.Filter[r]}),f.value=u[0].FORMCODE),r=="PAYMENTSTATUS"&&(u=n.ListPaymentStatus.filter(function(t){return t.ID.toString()===n.Filter[r]}),f.value=u[0].PAYMENTSTATUS),r=="SYMBOLCODE"&&(u=n.ListSymbolCode.filter(function(t){return t.SYMBOLCODE==n.Filter[r]}),f.value=u[0].SYMBOLCODE),n.FilterApply.push(f))};n.GetInvoiceWait=function(t){var o,r,f,u;n.Filter||(n.Filter={});n.Filter.TIME=="5"&&(n.FROMTIME=moment(n.FROMTIME).format("YYYY-MM-DD"),n.TOTIME=moment(n.TOTIME).format("YYYY-MM-DD"),n.Filter.TIME=n.FROMTIME+";"+n.TOTIME,n.FROMTIME&&n.TOTIME||(n.Filter.TIME=n.Timepickers.Options[0].value));n.LoadCookie_Invoice();(!t||t<=0)&&(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;o=e+"GetInvoiceWating";n.cookie.RowNum||(n.cookie.RowNum=10);n.ListInvoice=[];n.TotalPages=1;n.TotalRow=1;successCallback=function(t){if(n.cookie.RowNum>=500){let i=t.result,r=i.splice(0,50);n.ListInvoice=r;n.$apply();setTimeout(()=>{function t(r){let u=i.splice(0,50);n.ListInvoice=n.ListInvoice.concat(u);n.$apply();r&&setTimeout(()=>{t(r-1)},25)}t(20)},450)}else i(function(){n.ListInvoice=t.result},n.cookie.RowNum*.5);n.TotalPages=t.TotalPages;n.TotalRow=t.TotalRow;n.FROMTIME="";n.TOTIME=""};AjaxRequest(o,{form:n.Filter,currentPage:n.currentpage,itemPerPage:n.cookie.RowNum},"POST",!0,"json",successCallback);n.FilterApply=[];for(r in n.Filter)n.Filter[r]!=null&&(f={key:r,value:n.Filter[r]},r=="INVOICESTATUS"&&(u=n.ListInvoiceStatus.filter(function(t){return t.INVOICESTATUSID==n.Filter[r]}),f.value=u[0].INVOICESTATUS),r=="TIME"&&(u=n.Timepickers.Options.filter(function(t){return t.value==n.Filter[r]}),u.length>0&&(f.value=u[0].value)),r=="FORMCODE"&&(u=n.ListFormCode.filter(function(t){return t.FORMCODE==n.Filter[r]}),f.value=u[0].FORMCODE),r=="PAYMENTSTATUS"&&(u=n.ListPaymentStatus.filter(function(t){return t.ID.toString()===n.Filter[r]}),f.value=u[0].PAYMENTSTATUS),r=="SYMBOLCODE"&&(u=n.ListSymbolCode.filter(function(t){return t.SYMBOLCODE==n.Filter[r]}),f.value=u[0].SYMBOLCODE),n.FilterApply.push(f))};n.GetInvoiceReleaseError=function(t){var o,s,i,f,u;n.Filter||(n.Filter={});n.Filter.TIME=="5"&&(n.FROMTIME=moment(n.FROMTIME).format("YYYY-MM-DD"),n.TOTIME=moment(n.TOTIME).format("YYYY-MM-DD"),n.Filter.TIME=n.FROMTIME+";"+n.TOTIME,n.FROMTIME&&n.TOTIME||(n.Filter.TIME=n.Timepickers.Options[0].value));n.LoadCookie_Invoice();t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;o=e+"GetInvoiceReleaseError";s=JSON.stringify({form:n.Filter,currentPage:n.currentpage,itemPerPage:n.cookie.RowNum});n.ListInvoice=[];n.TotalPages=1;n.TotalRow=1;LoadingShow();r.PostDataAjax(o,s,function(t){t?t.rs?(n.ListInvoice=t.result,n.TotalPages=t.TotalPages,n.TotalRow=t.TotalRow,n.FROMTIME="",n.TOTIME=""):n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetInvoice");LoadingHide()});n.IsLoading=!1;n.FilterApply=[];for(i in n.Filter)n.Filter[i]!=null&&(f={key:i,value:n.Filter[i]},i=="INVOICESTATUS"&&(u=n.ListInvoiceStatus.filter(function(t){return t.INVOICESTATUSID==n.Filter[i]}),f.value=u[0].INVOICESTATUS),i=="TIME"&&(u=n.Timepickers.Options.filter(function(t){return t.value==n.Filter[i]}),u.length>0&&(f.value=u[0].TIME)),i=="FORMCODE"&&(u=n.ListFormCode.filter(function(t){return t.FORMCODE==n.Filter[i]}),f.value=u[0].FORMCODE),i=="PAYMENTSTATUS"&&(u=n.ListPaymentStatus.filter(function(t){return t.PAYMENTSTATUS==n.Filter[i]}),f.value=u[0].PAYMENTSTATUS),i=="SYMBOLCODE"&&(u=n.ListSymbolCode.filter(function(t){return t.SYMBOLCODE==n.Filter[i]}),f.value=u[0].SYMBOLCODE),n.FilterApply.push(f))};n.GetInvoiceDelete=function(t){var o,s,i,f,u;n.Filter||(n.Filter={});n.Filter.TIME=="5"&&(n.FROMTIME=moment(n.FROMTIME).format("YYYY-MM-DD"),n.TOTIME=moment(n.TOTIME).format("YYYY-MM-DD"),n.Filter.TIME=n.FROMTIME+";"+n.TOTIME,n.FROMTIME&&n.TOTIME||(n.Filter.TIME=n.Timepickers.Options[0].value));n.LoadCookie_Invoice();t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;o=e+"GetInvoiceDelete";s=JSON.stringify({form:n.Filter,currentPage:n.currentpage,itemPerPage:n.cookie.RowNum===null?100:n.cookie.RowNum});n.ListInvoice=[];n.TotalPages=1;n.TotalRow=1;LoadingShow();r.PostDataAjax(o,s,function(t){t?t.rs?(n.ListInvoice=t.result,n.TotalPages=t.TotalPages,n.TotalRow=t.TotalRow,n.FROMTIME="",n.TOTIME=""):n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetInvoice");LoadingHide()});n.FilterApply=[];for(i in n.Filter)n.Filter[i]!=null&&(f={key:i,value:n.Filter[i]},i=="INVOICESTATUS"&&(u=n.ListInvoiceStatus.filter(function(t){return t.INVOICESTATUSID==n.Filter[i]}),f.value=u[0].INVOICESTATUS),i=="TIME"&&(u=n.Timepickers.Options.filter(function(t){return t.value==n.Filter[i]}),u.length>0&&(f.value=u[0].TIME)),i=="FORMCODE"&&(u=n.ListFormCode.filter(function(t){return t.FORMCODE==n.Filter[i]}),f.value=u[0].FORMCODE),i=="PAYMENTSTATUS"&&(u=n.ListPaymentStatus.filter(function(t){return t.PAYMENTSTATUS==n.Filter[i]}),f.value=u[0].PAYMENTSTATUS),i=="SYMBOLCODE"&&(u=n.ListSymbolCode.filter(function(t){return t.SYMBOLCODE==n.Filter[i]}),f.value=u[0].SYMBOLCODE),n.FilterApply.push(f))};n.RemoveFilter=function(i){for(var r in n.Filter)if(r==i.key){n.Filter[r]=null;break}t.ReloadInvoice()};n.SeleteRow=function(t,i,r,u){var f=t.filter(function(n){return n.ISSELECTED==!0});if(i){const i=n.ListInvoiceChecked.indexOf(u);i>-1&&n.ListInvoiceChecked.splice(i,1);r=!1;t.forEach(function(n){n.ID===u&&(n.ISSELECTED=r)})}else n.ListInvoiceChecked.push(u),f.length==t.length-1?r=!0:t.forEach(function(n){n.ID===u&&(n.ISSELECTED=!0)});n.SetCountInvoiceSelected()};n.SelectAllInvoice=function(t,i){var r=t.filter(function(n){return n.ISSELECTED==i});r.length>0&&r.forEach(function(n){n.ISSELECTED=!i});n.SetCountInvoiceSelected()};n.SetCountInvoiceSelected=function(){var t=n.ListInvoice.filter(function(n){return n.ISSELECTED==!0});t&&t.length>0?($("#invoice-seleced-sign").show(),$("#invoice-seleced-sign").html("("+t.length+" HĐ đã chọn)")):($("#invoice-seleced-sign").html(""),$("#invoice-seleced-sign").hide());t&&t.length>0?($("#invoice-seleced-sign-waiting").show(),$("#invoice-seleced-sign-waiting").html("("+t.length+" HĐ đã chọn)")):($("#invoice-seleced-sign-waiting").html(""),$("#invoice-seleced-sign-waiting").hide())};n.Sign=function(n){LoadingShow();Sign(n)};n.SignMultipleInvoice=function(t,i){var u,r,f,e;if(n.ListInvoiceChecked=[],t)LoadingShow(),SignMultiple("");else{if(u=n.ListInvoice.filter(function(n){return n.INVOICESTATUS==2&&n.ISSELECTED===!0}),u&&u.length>0){toastr.warning("Hóa đơn với mẫu số <b style='color: #222;'>"+u[0].FORMCODE+"/"+u[0].SYMBOLCODE+"<\/b> đã được phát hành.");return}if(r=n.ListInvoice.filter(function(n){return n.ISSELECTED==!0}),r&&r.length===0){toastr.warning("Bạn chưa chọn hóa đơn phát hành.");return}if(r&&Object.keys(r).length>0){for(f=0;f<r.length;f++)n.ListInvoiceChecked.push(r[f].ID);e=n.ListInvoiceChecked.join(";");LoadingShow();i?SignMultiple(e,!0):SignMultiple(e,!1)}}};n.BackgroundJobSignInvoice=function(){var r=$.connection.signlRConf,u=sessionStorage.getItem("userNameSS"),i;$.connection.hub.qs={username:u};i=0;r.client.newMessageReceivedSignInvoice=function(r){var u,f,e;i=i+1;console.log(i);r.currentRow===r.totalRow?(u="Phát hành thành công <b>"+r.currentRow+"/"+r.totalRow+"<\/b> hóa đơn.",$(".invoiceResult").html("Hoàn Thành"),$("#progressTab").hide(),toastr.success(u),i=0,f=function(i){if(i)return n.UpdateAfterSigning(),!1;n.UpdateAfterSigning();t.ReloadInvoice()},confirm(u+"<br> Bạn có muốn làm mới dữ liệu không?","Phát hành hóa đơn","Có","Không",f)):($("#progressTab").show(),e=Math.floor(r.currentRow/r.totalRow*100),$(".invoiceResult").html("Đang phát hành hóa đơn: "+e+"%"))};$.connection.hub.start().done(function(){$("#progressTab").hide()})};n.BackgroundJobSignInvoice();n.UpdateAfterSigning=function(){var n=JSON.stringify({});r.PostDataAjax("/Home/UpdateAfterSigning",n,function(n){n?n.rs?console.log(n.msg):console.log(n.msg):console.log(n.msg)})};n.MergingPdfFile=function(){var t,r,i,u,f;if(n.ListInvoiceChecked=[],t=n.ListInvoice.filter(function(n){return n.ISSELECTED==!0}),t&&t.length===0){toastr.warning("Bạn chưa chọn hóa đơn cần in.");return}if(r=n.ListInvoice.filter(function(n){return n.INVOICESTATUS==1&&n.ISSELECTED===!0}),r&&r.length>0){toastr.warning("Hệ thống không hỗ trợ in hàng loạt với hóa đơn chưa phát hành.");return}if(t&&Object.keys(t).length>0){for(i=0;i<t.length;i++)n.ListInvoiceChecked.push(t[i].ID);u=n.ListInvoiceChecked.join(";");f=e+"MergingPdfFile";successCallback=function(n){toastr.success(n.msg);window.open("Uploads/"+n.msg+"?v="+(new Date).getTime())};AjaxRequest(f,{idInvoices:u},"POST",!0,"json",successCallback)}};n.ReMergingPdfFile=function(){var t,i,r;for(n.ListInvoiceChecked=[],t=0;t<n.ListInvoice.length;t++)n.ListInvoiceChecked.push(n.ListInvoice[t].ID);i=n.ListInvoiceChecked.join(";");r=e+"ReMergingPdfFile";successCallback=function(n){toastr.success(n.msg)};AjaxRequest(r,{idInvoices:i},"POST",!0,"json",successCallback)};n.RemoveInvoice=function(i){var u=function(u){var f,s,o;if(!u)return!1;if(n.ListInvoiceChecked=[],i)n.ListInvoiceChecked.push(i);else{if(f=n.ListInvoice.filter(function(n){return n.ISSELECTED==!0}),f&&f.length===0){toastr.warning("Bạn chưa chọn hóa đơn cần xóa.");return}if(s=n.ListInvoice.filter(function(n){return n.INVOICESTATUS!==1&&n.ISSELECTED===!0}),s&&s.length>0){toastr.warning("Bạn không được xóa hóa đơn ở trạng thái <b style='color: #222;'>Đã phát hành<\/b>.");return}if(f&&Object.keys(f).length>0)for(o=0;o<f.length;o++)n.ListInvoiceChecked.push(f[o].ID)}var h=n.ListInvoiceChecked.join(";"),c=e+"RemoveInvoice",l=JSON.stringify({idInvoices:h});LoadingShow();r.PostDataAjax(c,l,function(n){n&&n.rs?(toastr.success(n.msg),t.ReloadInvoice()):toastr.warning(n.msg);LoadingHide()})};confirm("Bạn có thực sự muốn xóa các Hóa đơn đã chọn không?","Thông báo","Không","Có",u)};n.OpenModalUpdatePaymentStatus=function(){$("#modal_choose_paymentstatus").dialog({width:"350px",modal:!0,resizable:!1,show:{effect:"drop",duration:300},hide:{effect:"drop",duration:200},create:function(){$("#modal_choose_paymentstatus").show()}})};n.UpdatePaymentStatus=function(i){var u=function(u){var f,o;if(!u)return!1;if(n.ListInvoiceChecked=[],i)n.ListInvoiceChecked.push(i);else{if(f=n.ListInvoice.filter(function(n){return n.ISSELECTED==!0}),f&&f.length===0){toastr.warning("Bạn chưa chọn hóa đơn cần cập nhật.");return}if(f&&Object.keys(f).length>0)for(o=0;o<f.length;o++)n.ListInvoiceChecked.push(f[o].ID)}var s=n.ListInvoiceChecked.join(";"),h=e+"UpdatePaymentStatus",c=JSON.stringify({idInvoices:s,paymentStatus:n.PAYMENTSTATUS});LoadingShow();r.PostDataAjax(h,c,function(n){n&&n.rs?(toastr.success(n.msg),t.ReloadInvoice()):toastr.warning(n.msg);LoadingHide()});$("#modal_choose_paymentstatus").dialog("close")};confirm("Bạn có thực sự muốn cập nhật các hóa đơn đã chọn không?","Thông báo","Không","Có",u)};n.OpenModalUpdatePartner=function(){$("#modal_update_partner").dialog({width:"550px",height:160,modal:!0,resizable:!1,show:{effect:"drop",duration:500},hide:{effect:"drop",duration:500},create:function(){$("#modal_update_partner").show()},open:function(){$(".ui-dialog-content").css("overflow","visible")}})};n.SuggestUser=function(){var i=t.SelectedUser;i&&(n.User.CUSID=i.CUSID)};n.UpdatePartner=function(i){var u=function(u){var f,o;if(!u)return!1;if(n.ListInvoiceChecked=[],i)n.ListInvoiceChecked.push(i);else{if(f=n.ListInvoice.filter(function(n){return n.ISSELECTED==!0}),f&&f.length===0){toastr.warning("Bạn chưa chọn hóa đơn cần cập nhật.");return}if(f&&Object.keys(f).length>0)for(o=0;o<f.length;o++)n.ListInvoiceChecked.push(f[o].ID)}var s=n.ListInvoiceChecked.join(";"),h=e+"UpdatePartner",c=JSON.stringify({idInvoices:s,partnerEmail:n.User.EMAIL});LoadingShow();r.PostDataAjax(h,c,function(n){n&&n.rs?(toastr.success(n.msg),t.ReloadInvoice()):toastr.warning(n.msg);LoadingHide()});$("#modal_update_partner").dialog("close")};confirm("Bạn có thực sự muốn cập nhật các hóa đơn đã chọn không?","Thông báo","Không","Có",u)};n.DownloadInvoiceExcel=function(t){var i,r;if(n.ListInvoiceChecked=[],t)n.ListInvoiceChecked.push(t);else{if(i=n.ListInvoice.filter(function(n){return n.ISSELECTED==!0}),i&&i.length===0){toastr.warning("Bạn chưa chọn hóa đơn cần export.");return}if(i&&Object.keys(i).length>0)for(r=0;r<i.length;r++)n.ListInvoiceChecked.push(i[r].ID)}var u=n.ListInvoiceChecked.join(";"),f=e+"DownloadInvoiceExcel",o={idInvoices:u},s=$.fileDownload(f,{httpMethod:"POST",data:o})};n.RecoverInvoice=function(i){var u=function(u){var f,o;if(!u)return!1;if(n.ListInvoiceChecked=[],i)n.ListInvoiceChecked.push(i);else{if(f=n.ListInvoice.filter(function(n){return n.ISSELECTED==!0}),f&&f.length===0){toastr.warning("Bạn chưa chọn hóa đơn cần phục hồi.");return}if(f&&Object.keys(f).length>0)for(o=0;o<f.length;o++)n.ListInvoiceChecked.push(f[o].ID)}var s=n.ListInvoiceChecked.join(";"),h=e+"RecoverInvoice",c=JSON.stringify({idInvoices:s});LoadingShow();r.PostDataAjax(h,c,function(n){n&&n.rs?(toastr.success(n.msg),t.ReloadInvoice()):toastr.warning(n.msg);LoadingHide()})};confirm("Bạn có thực sự muốn phục hồi Hóa đơn đã chọn không?","Thông báo","Không","Có",u)};n.LoadDashboard=function(){var t=JSON.stringify({});r.PostDataAjax("/Invoice/LoadDashboard",t,function(t){t?t.rs&&(n.TotalMoneyPaied=t.TotalMoneyPaied,n.TotalMoneyNotApproval=t.TotalMoneyNotApproval,n.TotalInvoiceSigned=t.totalInvoiceSigned):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetProvince")})};$(".dropdown-menu").find("form").click(function(n){n.stopPropagation()});n.PreviewReferenceInvoice=function(n){window.open("NOVAON_FOLDER"+n+"?v="+(new Date).getTime())};n.PreviewInvoice=function(n,t){if(t===!1){var i=e+"CreateFilePdfToView",u=JSON.stringify({invoiceId:n});LoadingShow();r.PostDataAjax(i,u,function(n){n&&n.rs?window.open("NOVAON_FOLDER"+n.msg+"?v="+(new Date).getTime()):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - PreviewInvoice");LoadingHide()})}else window.open("NOVAON_FOLDER"+n+"?v="+(new Date).getTime())};t.InvocieTYPE=2;n.DownloadInvoice=function(n){var i="",u="";t.InvocieTYPE==1?(i=e+"InvoiceConvert",u=JSON.stringify({invoice:n})):(i=e+"CreateFilePdfToView",u=JSON.stringify({invoiceID:n.ID}));LoadingShow();r.PostDataAjax(i,u,function(t){if(t&&t.rs){var i=document.createElement("a");i.href="NOVAON_FOLDER"+t.msg+"?v="+(new Date).getTime();i.download="ONFINANCE_INVOICE_HOA_DON_"+n.COMTAXCODE+"_"+n.FORMCODE+"_"+n.SYMBOLCODE+"_"+n.NUMBER+".pdf";i.dispatchEvent(new MouseEvent("click"))}else alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - DownloadInvoice");LoadingHide()})};n.PreviewModifiedReport=function(n){window.open("NOVAON_FOLDER"+n.MODIFIEDLINK+"?v="+(new Date).getTime())};n.PreviewCancelReport=function(n){window.open("NOVAON_FOLDER"+n.CANCELLINK+"?v="+(new Date).getTime())};n.ConvertInv=function(i){var o=confirm("Sau khi chuyển sang hóa đơn chuyển đổi. Hóa đơn chỉ được phép in một lần duy nhất. Bạn có thực sự muốn chuyển đổi hóa đơn ?"),u,f;o&&(n.IsLoading=!0,u=e+"UpdateConvertInvoice",f=JSON.stringify({invoice:i}),r.PostDataAjax(u,f,function(n){n?n.rs?(alert("Thành công!"),t.ReloadInvoice()):alert(n.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js)")}),n.IsLoading=!1)};n.GetInvoiceByStatus=function(t,i,u){var h,c,f,s,o;n.Filter||(n.Filter={});n.LoadCookie_Invoice();i||(i=1);i>n.TotalPages&&(i=n.TotalPages);n.currentpage=i;h=e+"GetInvoiceByStatus";c=JSON.stringify({form:n.Filter,type:t,intpage:i,reportType:u});n.ListInvoice=[];n.TotalPages=1;n.TotalRow=1;LoadingShow();r.PostDataAjax(h,c,function(t){t?t.rs?(n.ListInvoice=t.result,n.TotalPages=t.TotalPages,n.TotalRow=t.TotalRow):n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetInvoice");LoadingHide()});n.FilterApply=[];for(f in n.Filter)n.Filter[f]!=null&&(s={key:f,value:n.Filter[f]},f=="TIME"&&(o=n.Timepickers.Options.filter(function(t){return t.value==n.Filter[f]}),s.value=o[0].TIME),f=="FORMCODE"&&(o=n.ListFormCode.filter(function(t){return t.FORMCODE==n.Filter[f]}),s.value=o[0].FORMCODE),f=="SYMBOLCODE"&&(o=n.ListSymbolCode.filter(function(t){return t.SYMBOLCODE==n.Filter[f]}),s.value=o[0].SYMBOLCODE),n.FilterApply.push(s))};n.GetInvoiceWaiting=function(t){t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;var i=e+"GetInvoiceNumerWaiting",u=JSON.stringify({currentPage:n.currentpage,itemPerPage:10});LoadingShow();r.PostDataAjax(i,u,function(t){t?t.rs?(n.ListInvoiceWaiting=t.result,n.TotalPages=t.TotalPages,n.TotalRow=t.TotalRow):n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetInvoice");LoadingHide()})};t.ReloadGetNumber=function(){n.GetNumber(n.FormNumber.CURRENTPAGE)};n.GetNumber=function(t){n.FormNumber={};t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.FormNumber.ITEMPERPAGE=10;n.FormNumber.CURRENTPAGE=t;var i=e+"GetNumber",u=JSON.stringify({form:n.FormNumber});LoadingShow();n.ListNumber=[];r.PostDataAjax(i,u,function(t){t?t.rs?(n.ListNumber=t.result,n.TotalPages=t.TotalPages,n.TotalRow=t.TotalRow):alert(t.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetNumber");LoadingHide()})};n.uploadFile=function(n){var t,e,r,u,f;if(LoadingShow(),$("#div-file-active").show(),t=n.target.files,e=CheckFile(t),e)for(r=0;r<t.length;r++)u=t[r],f=new FileReader,f.onloadend=function(n){i(function(){var t=n.target.result.split(",")[1];$("#file-selected").append('<span class="has-tag-attment-file" name = "'+u.name+'" rel= "'+t+'" onclick="DeleteFile(this)">'+u.name+'<img src="/Images/close.png"><\/span>');LoadingHide()},100)},f.readAsDataURL(u);else LoadingHide()};n.ConfirmChange=function(n){if(n.IDTEMP>0){var i=function(t){if(!t)return!1;window.open("NOVAON_FOLDER"+n.SIGNLINKTEMP)};return confirm("Hóa đơn này đã được lập hóa đơn điều chỉnh. Bạn có muốn xem hóa đơn điều chỉnh đã lập không?","Hóa đơn điều chỉnh","Không","Xem hóa đơn",i),!1}t.ModalInvoice(n,2);$(".modal-invoice").modal("show")};n.CancelInvoiceConfirm=function(n){if(n.CANCELREASON!=null&&n.CANCELREASON.trim()!="")t.ModalCancelInvoice(n),$(".modal-cancel-invoice").modal("show");else{var i=function(i){i?(t.IsUpdateCancelReport=!1,t.ModalCancelReport(null,n),$(".modal-cancel-report").modal("show")):(t.ModalCancelInvoice(n),$(".modal-cancel-invoice").modal("show"))};confirm("Bạn có muốn lập biên bản hủy cho hóa đơn này không?","Hóa đơn xóa bỏ","Không","Có",i)}};n.ReplaceInvoiceConfirm=function(n){var f=n.NUMBER,r=n.FORMCODE,u=n.SYMBOLCODE,i;n.INVOICETYPE==3?n.IDTEMP>0&&n.IDTEMP>n.ID?(i=function(t){if(!t)return!1;window.open("NOVAON_FOLDER"+n.SIGNLINKTEMP)},confirm("Hóa đơn <strong><"+r+" - "+u+" - "+("0000000"+f).slice(-7)+"><\/strong> đã được lập hóa đơn thay thế <strong><"+r+" - "+u+" - Chưa cấp số><\/strong>. Bạn có muốn xem không?","Hóa đơn thay thế","Không","Có",i)):(t.ModalInvoice(n,6),$(".modal-invoice").modal("show")):(i=function(i){if(i)t.ModalCancelInvoice(n),$(".modal-cancel-invoice").modal("show");else return!1},confirm("Để lập được hóa đơn thay thế cho hóa đơn <strong><"+r+" - "+u+" - "+("0000000"+f).slice(-7)+"><\/strong> bạn cần thực hiện xóa bỏ hóa đơn này trước. Bạn có muốn thực hiện xóa bỏ hóa đơn không?","Hóa đơn xóa bỏ","Không","Có",i))};n.ModifiedInvoiceConfirm=function(n){var i;if(n.CHANGEREASON!=null&&n.CHANGEREASON.trim()!=""){if(n.IDTEMP>0)return i=function(t){if(!t)return!1;window.open("NOVAON_FOLDER"+n.SIGNLINKTEMP)},confirm("Hóa đơn này đã được lập hóa đơn điều chỉnh. Bạn có muốn xem hóa đơn điều chỉnh đã lập không?","Hóa đơn điều chỉnh","Không","Xem hóa đơn",i),!1;t.ModalInvoice(n,5);$(".modal-invoice").modal("show")}else if(i=function(i){if(i)t.IsUpdateModifiedReport=!1,t.ModalModifiedReport(null,n),$(".modal-modified-report").modal("show");else{if(n.IDTEMP>0){var r=function(t){if(!t)return!1;window.open("NOVAON_FOLDER"+n.SIGNLINKTEMP)};return confirm("Hóa đơn này đã được lập hóa đơn điều chỉnh. Bạn có muốn xem hóa đơn điều chỉnh đã lập không?","Hóa đơn điều chỉnh","Không","Xem hóa đơn",r),!1}t.ModalInvoice(n,5);$(".modal-invoice").modal("show")}},n.ISEXISTMODIFIEDREPORT!="1")confirm("Bạn có muốn lập biên bản điều chỉnh cho hóa đơn này không?","Hóa đơn điểu chỉnh","Không","Có",i);else{if(n.IDTEMP>0)return i=function(t){if(!t)return!1;window.open("NOVAON_FOLDER"+n.SIGNLINKTEMP)},confirm("Hóa đơn này đã được lập hóa đơn điều chỉnh. Bạn có muốn xem hóa đơn điều chỉnh đã lập không?","Hóa đơn điều chỉnh","Không","Xem hóa đơn",i),!1;t.ModalInvoice(n,5);$(".modal-invoice").modal("show")}};n.OpenModalCancelReport=function(u){if(n.Report={},u.ISEXISTCANCELREPORT=="1"){t.IsUpdateCancelReport=!0;var f=e+"GetReportByInvoiceIdReportType",o=JSON.stringify({invoiceId:u.ID,reportType:u.ISEXISTCANCELREPORT});LoadingShow();r.PostDataAjax(f,o,function(t){t?t.rs?n.Report=t.result:alert(t.msg):(LoadingHide,alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetReportByInvoiceIdReportType"));LoadingHide()});i(function(){t.ModalCancelReport(n.Report,u);$(".modal-cancel-report").modal("show")},200)}else t.IsUpdateCancelReport=!1,i(function(){t.ModalCancelReport(n.Report,u);$(".modal-cancel-report").modal("show")},200)};n.OpenModalModifiedReport=function(u){if(n.Report={},u.ISEXISTMODIFIEDREPORT=="2"){t.IsUpdateModifiedReport=!0;var f=e+"GetReportByInvoiceIdReportType",o=JSON.stringify({invoiceId:u.ID,reportType:u.ISEXISTMODIFIEDREPORT});LoadingShow();r.PostDataAjax(f,o,function(t){t?(LoadingHide(),t.rs?n.Report=t.result:alert(t.msg)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetReportByInvoiceIdReportType");LoadingHide()});i(function(){t.ModalModifiedReport(n.Report,u);$(".modal-modified-report").modal("show")},200)}else t.IsUpdateModifiedReport=!1,i(function(){t.ModalModifiedReport(n.Report,u);$(".modal-modified-report").modal("show")},200)};n.DownloadReleaseDocument=function(n){var t=e+"DownloadReleaseDocument",i={numberBO:n},r=$.fileDownload(t,{httpMethod:"POST",data:i})};n.DownloadReleaseDocumentXML=function(n){var t=e+"DownloadReleaseDocumentXML",i={numberBO:n},r=$.fileDownload(t,{httpMethod:"POST",data:i})};n.DownloadIssuedDocument=function(n){var t=e+"DownloadIssuedReleaseDocument",i={numberBO:n},r=$.fileDownload(t,{httpMethod:"POST",data:i})};n.DownloadReleaseInvoiceTemplate=function(n){var t=e+"DownloadReleaseInvoiceTemplate",r={numberBO:n},u=$.fileDownload(t,{httpMethod:"POST",data:r,prepareCallback:function(){LoadingShow()}});i(function(){LoadingHide()},3e3)};n.DownloadConvertibleInvoiceTemplate=function(n){var t=e+"DownloadConvertibleInvoiceTemplate",r={numberBO:n},u=$.fileDownload(t,{httpMethod:"POST",data:r,prepareCallback:function(){LoadingShow()}});i(function(){LoadingHide()},3e3)};n.DownloadDiscountInvoiceTemplate=function(n){var t=e+"DownloadDiscountInvoiceTemplate",r={numberBO:n},u=$.fileDownload(t,{httpMethod:"POST",data:r,prepareCallback:function(){LoadingShow()}});i(function(){LoadingHide()},3e3)};n.PreviewInvoiceTemplate=function(t){n.GlobalInvoiceToViewTemplate=t;var i=e+"PreviewInvoiceTemplate",u=JSON.stringify({numberBO:t,isConvert:!1});LoadingShow();r.PostDataAjax(i,u,function(t){t?t.rs?n.ShowPopupFileView(t.msg):(n.ErrorMessage=t.msg,alert(t.msg)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - PreviewInvoiceTemplate");LoadingHide()})};f.PreviewInvoiceTemplate=function(t){var i=e+"PreviewInvoiceTemplate",u=JSON.stringify({numberBO:n.GlobalInvoiceToViewTemplate,isConvert:t});LoadingShow();r.PostDataAjax(i,u,function(t){t?t.rs?$("#frViewFileInvoice").attr("src",t.msg):(n.ErrorMessage=t.msg,alert(t.msg)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - PreviewInvoiceTemplate");LoadingHide()})};n.ModalSendEmail=function(t){$("#modal_send_email").dialog({width:"45%",modal:!0,resizable:!1,show:{effect:"drop",duration:500},hide:{effect:"drop",duration:500},create:function(){$("#modal_send_email").show()}});$("#file-selected").html("");n.GetEmailHistory(t.ID);n.Invoice={};angular.copy(t,n.Invoice);t.CUSEMAIL&&t.CUSEMAIL.trim()!==""||(t.CUSEMAIL=t.CUSEMAILSEND);n.Invoice.RECIEVEREMAIL=t.CUSEMAIL};n.SendEmail=function(){var f,i,o,c;if(!n.Invoice.RECIEVEREMAIL)return alert("Vui nhập vào email người nhận!!"),!1;for(f=n.Invoice.RECIEVEREMAIL.split(","),i=0;i<f.length;i++)if(!validation.isEmailAddress(f[i].trim()))return alert("Vui lòng nhập đúng định dạng email "+(i+1)),!1;n.Invoice.CUSBUYER=n.Invoice.RECIEVERNAME;n.Invoice.CUSEMAIL=n.Invoice.RECIEVEREMAIL;var s=[],h=[],u=$("#file-selected .has-tag-attment-file");if(u.length>0)for(i=0;i<u.length;i++)h.push(u[i].getAttribute("rel")),s.push(u[i].getAttribute("name"));o="";o=n.Invoice.INVOICETYPE===3?e+"SendCancelEmail":e+"SendEmail";c=JSON.stringify({invoice:n.Invoice,imgBase64:JSON.stringify(h),fileNames:s.join(";")});LoadingShow();r.PostDataAjax(o,c,function(n){n?n.rs?(toastr.success(n.msg),$("#modal_send_email").dialog("close"),t.ReloadInvoice()):toastr.error(n.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SendEmail");LoadingHide()})};n.OpenSendMultipleEmail=function(){var t,r,u;if(n.ListInvoiceChecked=[],t=n.ListInvoice.filter(function(n){return n.ISSELECTED==!0}),t&&t.length===0){toastr.warning("Bạn chưa chọn hóa đơn cần gửi email.");return}r=n.ListInvoice.filter(function(n){return n.INVOICETYPE!==3&&n.ISSELECTED===!0});r&&r.length>0&&(u=function(r){if(!r)return!1;if(t=t.filter(function(n){return n.INVOICETYPE!==3}),n.INVOICEQUANTITIES=t.length,t.length>50)return toastr.error("Số lượng email tối đa không quá 50.","Cảnh báo"),!1;$("#modal_send_multiple_email").dialog({width:"1200px",modal:!0,resizable:!1,show:{effect:"drop",duration:500},hide:{effect:"drop",duration:500},create:function(){$("#modal_send_multiple_email").show()}});i(function(){t.forEach(n=>{n.CUSEMAIL&&n.CUSEMAIL.trim()!==""||(n.CUSEMAIL=n.CUSEMAILSEND)});angular.copy(t,n.ListInvoiceChecked)},100)},confirm("Chương trình chỉ thực hiện gửi các hóa đơn đã phát hành và chưa bị xóa bỏ?","Lưu ý gửi mail","Không","Đồng ý",u))};n.SendMultipleEmail=function(){var t=e+"SendMultipleEmail",i=JSON.stringify({invoices:n.ListInvoiceChecked});LoadingShow();r.PostDataAjax(t,i,function(n){n?(n.rs?(toastr.success(n.msg),$("#modal_send_multiple_email").dialog("close")):toastr.error(n.msg),LoadingHide()):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SendMultipleEmail")})};n.CurrentItem={};n.EditTemplate=function(n){t.EditingTemplate=n;document.location.href="/#/mau-hoa-don/"+btoa(n.TEMPLATEPATH)};n.OpenModalUploadFileReport=function(t){n.CurrentInvoiceFileReport=t;$("#modal_upload_file_report").dialog({width:"550px",height:250,modal:!0,resizable:!1,show:{effect:"drop",duration:300},hide:{effect:"drop",duration:300},create:function(){$("#modal_upload_file_report").show()},open:function(){$(".ui-dialog-content").css("overflow","visible")}})};$("#frmUploadFileReport").fileupload({autoUpload:!1,add:function(r,u){var f,u,o;LoadingShow();f=new FormData;u=u.files[0];f.append("file0",u);f.append("currentItem",n.CurrentInvoiceFileReport.ID);f.append("comTaxCode",n.CurrentInvoiceFileReport.COMTAXCODE);o=e+"UploadFileReport";$.ajax({type:"POST",url:o,contentType:!1,processData:!1,data:f,success:function(r){i(function(){r.rs?(n.CurrentItem.ATTACHMENTFILELINK=r.id,t.ReloadInvoice(),toastr.success(r.msg),$("#modal_upload_file_report").dialog("close")):toastr.error(r.msg);LoadingHide()},10)},error:function(){alert("Lỗi không thể tải lên file: "+u.name);LoadingHide()}})}});n.DownloadFileReport=function(n){var t=e+"DownloadFileReport",i={invoiceId:n.ID},r=$.fileDownload(t,{httpMethod:"POST",data:i})};n.RemoveFileReport=function(i){var u=e+"RemoveFileReport",f=JSON.stringify({invoice:i});LoadingShow();r.PostDataAjax(u,f,function(i){i?i.rs?(toastr.success(i.msg),t.ReloadInvoice()):(toastr.error(i.msg),n.ErrorMessage=i.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - RemoveFileReport");LoadingHide()})};n.ExportExcel=function(){var t=e+"ExportExcel",i={form:n.Filter};$.fileDownload(t,{httpMethod:"POST",data:i})};n.GetEmailHistory=function(t){n.ListEmailHistory=[];var i=e+"GetEmailHistoryByInvoiceId",u=JSON.stringify({id:t});LoadingShow();r.PostDataAjax(i,u,function(t){t?t.rs?n.ListEmailHistory=t.result:n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetEmailHistory");LoadingHide()})};LoadingHide();n.IsGridViewDisplay=getCookie("NovaonIsGridView");n.IsGridViewDisplay===undefined?(setCookie("NovaonIsGridView",0,30),n.IsGridViewDisplay=getCookie("NovaonIsGridView")):n.IsGridViewDisplay==="1"&&$("#left-mainnavi").css("width")==="230px"&&$("#sidebar").trigger("click");n.CloseSideBar=function(){n.IsGridViewDisplay===undefined&&setCookie("NovaonIsGridView",1,30);n.IsGridViewDisplay!==undefined&&(n.IsGridViewDisplay==="1"?setCookie("NovaonIsGridView",0,30):setCookie("NovaonIsGridView",1,30));n.IsGridViewDisplay=getCookie("NovaonIsGridView");$("#sidebar").trigger("click")};n.QuickviewInvoice=function(i){t.InvocieTYPE=2;n.CurrentActive=i.ID;n.CurrentInvoice=i;var u=e+"QuickviewInvoice",f=JSON.stringify({invoiceId:i.ID});LoadingShow();r.PostDataAjax(u,f,function(n){n&&n.rs?$("#iframe_templateViewInvoice").attr("src",n.data):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - QuickviewInvoice");LoadingHide()})};n.QuickviewInvoiceConvert=function(i){t.InvocieTYPE=1;n.CurrentActive=i.ID;n.CurrentInvoice=i;var u=e+"QuickviewInvoiceConvert",f=JSON.stringify({invoice:i});LoadingShow();r.PostDataAjax(u,f,function(n){n&&n.rs?(toastr.options={timeOut:"2000"},toastr.success("Chuyển đổi thành công!"),$("#iframe_templateViewInvoice").attr("src",n.data)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - QuickviewInvoiceConvert");LoadingHide()})};t.NOTE="";t.SendZalo=function(n){if(!n.CUSPHONENUMBER){toastr.warning("Số điện thoại là bắt buộc");return}var i=e+"SendZalo",u=JSON.stringify({invoice:n,note:t.NOTE});LoadingShow();r.PostDataAjax(i,u,function(t){t?t.rs?toastr.success("Gửi thành công tới zalo có số "+n.CUSPHONENUMBER):toastr.warning(t.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SendZalo");LoadingHide()})};n.ModalSendZalo=function(n){$("#modal_send_zalo").dialog({width:"45%",modal:!0,resizable:!1,show:{effect:"drop",duration:500},hide:{effect:"drop",duration:500},create:function(){$("#modal_send_zalo").show()}});$("#file-selected").html("");t.Invoice={};angular.copy(n,t.Invoice);var i=e+"GetHistoryZalo",u=JSON.stringify({invoice:n});LoadingShow();r.PostDataAjax(i,u,function(n){n?n.rs?t.ListHistoryZaloUser=n.result:(toastr.warning(n.msg),t.ListHistoryZaloUser=null):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetHistoryZalo");LoadingHide()})};t.DateFormatZalo=function(n){var t=new Date(n),i=t.getMonth()+1,r=t.getDate(),u=t.getFullYear(),f=t.getHours(),e=t.getMinutes(),o=t.getSeconds();return r+"/"+i+"/"+u+" lúc "+f+" : "+e+" : "+o};t.OpenSendMultipleZalo=function(){var r,u,f;if(n.ListInvoiceChecked=[],r=n.ListInvoice.filter(function(n){return n.ISSELECTED==!0}),r&&r.length===0){toastr.warning("Bạn chưa chọn hóa đơn cần gửi tin.");return}u=n.ListInvoice.filter(function(n){return n.INVOICETYPE!==3&&n.ISSELECTED===!0});u&&u.length>0&&(f=function(n){if(!n)return!1;r=r.filter(function(n){return n.INVOICETYPE!==3});t.INVOICEQUANTITIES=r.length;$("#modal_send_multiple_zalo").dialog({width:"1200px",modal:!0,resizable:!1,show:{effect:"drop",duration:500},hide:{effect:"drop",duration:500},create:function(){$("#modal_send_multiple_zalo").show()}});i(function(){r.forEach(n=>{n.CUSPHONENUMBER&&n.CUSPHONENUMBER.trim()!==""||(n.CUSPHONENUMBER=n.CUSPHONENUMBER)});angular.copy(r,t.ListInvoiceChecked)},100)},confirm("Chương trình chỉ thực hiện gửi các hóa đơn đã phát hành và chưa bị xóa bỏ?","Lưu ý gửi tin","Không","Đồng ý",f))};t.SendMultipleZalo=function(){var n=e+"SendMultipleZalo",i=JSON.stringify({invoices:t.ListInvoiceChecked});LoadingShow();r.PostDataAjax(n,i,function(n){n?(n.rs?(toastr.success(n.msg),$("#modal_send_multiple_zalo").dialog("close")):toastr.error(n.msg),LoadingHide()):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SendMultipleZalo")})};n.SetdateFromtime=function(){moment($("#pk_fromtime").val()).format("yy-mm-dd")};n.SetDatepikerFromTime=function(){$("#pk_fromtime").datepicker({dateFormat:"yy-mm-dd",maxDate:new Date});SetVietNameInterface($("#pk_fromtime"));$("#pk_fromtime").datepicker({dateFormat:"dd/mm/yy",maxDate:new Date});SetVietNameInterface($("#pk_fromtime"));$("#pk_fromtime_quickview").datepicker({dateFormat:"yy-mm-dd",maxDate:new Date});SetVietNameInterface($("#pk_fromtime_quickview"));$("#pk_fromtime").datepicker({dateFormat:"dd/mm/yy",maxDate:new Date});SetVietNameInterface($("#pk_fromtime_quickview"));$("#pk_fromtime_wating").datepicker({dateFormat:"yy-mm-dd",maxDate:new Date});SetVietNameInterface($("#pk_fromtime-wating"));$("#pk_fromtime_wating").datepicker({dateFormat:"dd/mm/yy",maxDate:new Date});SetVietNameInterface($("#pk_fromtime_wating"));$("#pk_fromtime_delete").datepicker({dateFormat:"yy-mm-dd",maxDate:new Date});SetVietNameInterface($("#pk_fromtime-delete"));$("#pk_fromtime_delete").datepicker({dateFormat:"dd/mm/yy",maxDate:new Date});SetVietNameInterface($("#pk_fromtime_delete"));$("#pk_fromtime_error").datepicker({dateFormat:"yy-mm-dd",maxDate:new Date});SetVietNameInterface($("#pk_fromtime-error"));$("#pk_fromtime_error").datepicker({dateFormat:"dd/mm/yy",maxDate:new Date});SetVietNameInterface($("#pk_fromtime_error"))};n.SetDatepikerToTime=function(){var f=n.TOTIME,t,i,r,u;$("#pk_totime").datepicker("option","minDate",f);$("#pk_totime").datepicker({dateFormat:"yy-mm-dd",minDate:new Date(f)});SetVietNameInterface($("#pk_totime"));f=n.TOTIME;$("#pk_totime").datepicker("option","minDate",f);$("#pk_totime").datepicker({dateFormat:"dd/mm/yy",minDate:new Date(f)});SetVietNameInterface($("#pk_totime"));t=n.TOTIME;$("#pk_totime_quickview").datepicker("option","minDate",t);$("#pk_totime_quickview").datepicker({dateFormat:"yy-mm-dd",minDate:new Date(t)});SetVietNameInterface($("#pk_totime_quickview"));t=n.TOTIME;$("#pk_totime_quickview").datepicker("option","minDate",t);$("#pk_totime_quickview").datepicker({dateFormat:"dd/mm/yy",minDate:new Date(t)});SetVietNameInterface($("#pk_totime_quickview"));i=n.TOTIME;$("#pk_totime_wating").datepicker("option","minDate",i);$("#pk_totime_wating").datepicker({dateFormat:"yy-mm-dd",minDate:new Date(i)});SetVietNameInterface($("#pk_totime_wating"));i=n.TOTIME;$("#pk_totime_wating").datepicker("option","minDate",i);$("#pk_totime_wating").datepicker({dateFormat:"dd/mm/yy",minDate:new Date(i)});SetVietNameInterface($("#pk_totime_wating"));r=n.TOTIME;$("#pk_totime_delete").datepicker("option","minDate",r);$("#pk_totime_delete").datepicker({dateFormat:"yy-mm-dd",minDate:new Date(r)});SetVietNameInterface($("#pk_totime_delete"));r=n.TOTIME;$("#pk_totime_delete").datepicker("option","minDate",r);$("#pk_totime_delete").datepicker({dateFormat:"dd/mm/yy",minDate:new Date(r)});SetVietNameInterface($("#pk_totime_error"));u=n.TOTIME;$("#pk_totime_error").datepicker("option","minDate",u);$("#pk_totime_error").datepicker({dateFormat:"yy-mm-dd",minDate:new Date(u)});SetVietNameInterface($("#pk_totime_error"));u=n.TOTIME;$("#pk_totime_error").datepicker("option","minDate",u);$("#pk_totime_error").datepicker({dateFormat:"dd/mm/yy",minDate:new Date(u)});SetVietNameInterface($("#pk_totime_delete"))};n.column="";n.reverse=!1;n.sortColumn=function(t){n.column=t;n.reverse?(n.reverse=!1,n.reverseclass="arrow-up_h"):(n.reverse=!0,n.reverseclass="arrow-down_h")};n.sortClass=function(t){return n.column==t?n.reverse?"arrow-down_h":"arrow-up_h":""};i(function(){$("select.cb-select-time").selectpicker();$(".selectpicker").selectpicker()});$('[data-toggle="tooltip"]').tooltip({content:function(){return $(this).prop("title")},position:{my:"center top+15",at:"left bottom"}});n.RemovedInvoice=function(i){var u=function(u){var f,o;if(!u)return!1;if(n.ListInvoiceChecked=[],i)n.ListInvoiceChecked.push(i);else{if(f=n.ListInvoice.filter(function(n){return n.ISSELECTED==!0}),f&&f.length===0){toastr.warning("Bạn chưa chọn hóa đơn cần xóa.");return}if(f&&Object.keys(f).length>0)for(o=0;o<f.length;o++)n.ListInvoiceChecked.push(f[o].ID)}var s=n.ListInvoiceChecked.join(";"),h=e+"RemovedInvoice",c=JSON.stringify({ids:s});LoadingShow();r.PostDataAjax(h,c,function(n){n&&n.rs?(toastr.success(n.msg),t.ReloadInvoice()):toastr.warning(n.msg);LoadingHide()})};confirm("Bạn có thực sự muốn xóa các hóa đơn đã chọn không ?<br/><b class ='text-danger'>Chọn xóa sẽ không thể khôi phục lại được, nên cân nhắc trước khi xóa<\/b>","Thông báo","Không","Có",u)};n.RemovedAllInvoice=function(){var n=function(n){if(!n)return!1;var i=e+"RemovedAllInvoice",u=JSON.stringify({});LoadingShow();r.PostDataAjax(i,u,function(n){n&&n.rs?(toastr.success(n.msg),t.ReloadInvoice()):toastr.warning(n.msg);LoadingHide()})};confirm("Bạn có thực sự muốn xóa tất cả các hóa đơn không?<br/><b class ='text-danger'>Chọn xóa sẽ không thể khôi phục lại được, nên cân nhắc trước khi xóa<\/b>","Thông báo","Không","Có",n)};n.ModalConvertInvoice=function(t){$("#modal_convert_invoice").dialog({width:"20%",modal:!0,resizable:!1,show:{effect:"drop",direction:"right",duration:300},hide:{effect:"fade",duration:200},create:function(){$("#modal_convert_invoice").show()}});angular.copy(t,n.Invoice)};n.ConvertInvoices=function(){var t=e+"InvoiceConvert",i=JSON.stringify({invoice:n.Invoice});LoadingShow();r.PostDataAjax(t,i,function(t){t?t.rs?(toastr.options={timeOut:"2000"},toastr.success("Chuyển đổi thành công!"),$("#modal_convert_invoice").dialog("close"),n.PreviewReferenceInvoice(t.data)):(n.ErrorMessage=t.msg,alert(t.msg)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - InvoiceConvert");LoadingHide()})};o=1;f.GetInvoice=function(){n.cookie.RowNum>=n.TotalRow||(n.cookie.RowNum=n.cookie.RowNum+10,n.Tab.All===!0&&n.Check(n.cookie.RowNum,"RowNum"),n.Tab.Wating===!0&&n.Check(n.cookie.RowNum,"RowNum"),n.Tab.Cancel===!0&&n.GetInvoiceByStatus(3,1+o,1),n.Tab.Change===!0&&n.GetInvoiceByStatus(5,1+o,2),n.Tab.Delete===!0&&n.GetInvoiceDelete(1+o),n.Tab.Replace===!0&&n.GetInvoiceByStatus(6,1+o,4))};n.ChangeFontSize=function(){n.template.style[".bg"]["font-size"]=n.template.fontSize};n.ShowPopupFileView=function(n){$("#popupViewInvoice").dialog({modal:!0,resizable:!0,width:"900px",open:function(){var t,i;$("#frViewFileInvoice").attr("src",n);$(this).dialog("option","title","");$(".function-area").remove();t=$('<label class="function-area"><input id = "btnInvoice" checked type="radio" onchange="window.PreviewInvoiceTemplate(false)" name="template_check" style="transform: scale(1.7)" /> &nbsp;&nbsp; Hóa đơn mẫu<label/>');t.appendTo($('[aria-describedby="popupViewInvoice"] .ui-dialog-titlebar'));i=$('<label class="function-area"><input id = "btnConvertInvoice" name="template_check" type="radio" onchange="window.PreviewInvoiceTemplate(true)" style="transform: scale(1.7)" />&nbsp;&nbsp; Hóa đơn mẫu chuyển đổi<label/>');i.appendTo($('[aria-describedby="popupViewInvoice"] .ui-dialog-titlebar'))}})}}]);var x=200;app.controller("ProductController",["$rootScope","$scope","$timeout","CommonFactory",function(n,t,i,r){var u="/Product/";LoadingShow();t.LoadCookie_Product=function(){var n=getCookie("Novaon_ProductManagement");n?t.cookie=JSON.parse(n):(t.cookie={FieldID:!0,FieldName:!0,FieldSKU:!0,FieldType:!0,FieldCategory:!0,FieldDes:!0,FieldQuantityUnit:!0,FieldPrice:!0,RowNum:10},setCookie("Novaon_ProductManagement",JSON.stringify(t.cookie),30))};t.Check=function(n,i){(t.cookie[i]=i=="RowNum"?n:!n,setCookie("Novaon_ProductManagement",JSON.stringify(t.cookie),30),i=="RowNum")&&t.GetProduct(t.currentpage)};t.Filter={KEYWORD:"",PRODUCTTYPE:0,CATEGORY:null};n.ReloadProduct=function(n){n==1&&(t.currentpage=n);t.GetProduct(t.currentpage)};t.ResetGetFunction=function(){t.LoadCookie_Product();t.ListProduct=[]};t.GetProduct=function(n){t.ResetGetFunction();t.IsLoading=!0;n||(n=1);n>t.TotalPages&&(n=t.TotalPages);t.currentpage=n;t.IsLoading=!0;var i=u+"GetProduct",f=JSON.stringify({form:t.Filter,currentPage:n,itemPerPage:t.cookie.RowNum});t.ListProduct=[];t.TotalPages=1;t.TotalRow=1;LoadingShow();r.PostDataAjax(i,f,function(n){n?n.rs?(t.ListProduct=n.result,t.TotalPages=n.TotalPages,t.TotalRow=n.TotalRow):t.ErrorMessage=n.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - ProductController - GetProduct");LoadingHide()})};t.UpdateType=function(){var i,f,e,o;if(t.ChangeType){if(i=t.ListProduct.filter(function(n){return n.ISSELECTED==!0}),i.length==0){alert("Vui lòng chọn ít nhất 1 dòng");t.ChangeType=null;return}f=confirm("Chuyển sang loại "+t.ChangeType);f?(e=u+"ChangeProductType",o=JSON.stringify({products:t.ListProduct,productType:t.ChangeType}),LoadingShow(),r.PostDataAjax(e,o,function(i){i?i.rs?n.ReloadProduct():(t.ChangeType=null,alert(i.msg)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - ProductController - UpdateType")}),LoadingHide()):t.ChangeType=null}};t.ExportExcel=function(){var n,i,r,f;n||(n=1);n>t.TotalPages&&(n=t.TotalPages);t.currentpage=n;i=u+"ExportExcell";r={keyword:t.Filter.KEYWORD,productType:t.Filter.PRODUCTTYPE,category:t.Filter.CATEGORY,currentPage:n,itemPerPage:t.cookie.RowNum};LoadingShow();f=$.fileDownload(i,{httpMethod:"POST",data:r});LoadingHide()};t.SelectAll=function(){var n=t.ListProduct.filter(function(n){return n.ISSELECTED==t.IsSelectAll});n.length>0&&n.forEach(function(n){n.ISSELECTED=!t.IsSelectAll})};t.SeleteRow=function(n){var i=t.ListProduct.filter(function(n){return n.ISSELECTED==!0});n?t.IsSelectAll=!1:i.length==t.ListProduct.length-1&&(t.IsSelectAll=!0)};t.ToggleShowMore=function(n){$(n).fadeToggle(300)};$(".dropdown-menu").find("form").click(function(n){n.stopPropagation()});t.RemoveProduct=function(i){var f=function(f){var e,o;if(!f)return!1;if(t.ListProductChecked=[],t.ListProductCheckedName=[],t.ListProductCheckedSku=[],i)t.ListProductChecked.push(i.ID),t.ListProductCheckedName.push(i.PRODUCTNAME),t.ListProductCheckedSku.push(i.SKU);else{if(e=t.ListProduct.filter(function(n){return n.ISSELECTED==!0}),e&&e.length===0){alert("Bạn chưa chọn sản phẩm cần xóa.");return}if(e&&Object.keys(e).length>0)for(o=0;o<e.length;o++)t.ListProductChecked.push(e[o].ID),t.ListProductCheckedName.push(e[o].PRODUCTNAME),t.ListProductCheckedSku.push(e[o].SKU)}var s=t.ListProductChecked.join(";"),h=t.ListProductCheckedName.join(";"),c=t.ListProductCheckedSku.join(";"),l=u+"RemoveProduct",a=JSON.stringify({idProducts:s,proname:h,sku:c});LoadingShow();r.PostDataAjax(l,a,function(t){t&&t.rs?(toastr.success(t.msg),n.ReloadProduct()):toastr.warning(t.msg);LoadingHide()})};confirm("Bạn có thực sự muốn xóa các sản phẩm đã chọn không?","Thông báo","Không","Có",f)}}]);app.controller("CustomerController",["$scope","$rootScope","$timeout","CommonFactory","persistObject",function(n,t,i,r){var u="/Customer/";LoadingShow();n.LoadCookie_Customer=function(){var t=getCookie("Novaon_CustomerManagement");t?n.cookie=JSON.parse(t):(n.cookie={FieldID:!0,FieldIDCustummer:!0,FieldName:!0,FieldEnterprise:!0,FieldPhone:!0,FieldEmail:!0,FieldAddress:!0,FieldStatus:!0,FieldTotalMoney:!0,FieldUnpaidMoney:!0,FieldCustaxcode:!0,RowNum:10},setCookie("Novaon_CustomerManagement",JSON.stringify(n.cookie),30))};n.Check=function(t,i){(n.cookie[i]=i=="RowNum"?t:!t,setCookie("Novaon_CustomerManagement",JSON.stringify(n.cookie),30),i=="RowNum")&&n.GetCustomer(n.currentpage)};n.Filter={KEYWORD:""};t.ReloadCustomer=function(t){t==1&&(n.currentpage=t);n.GetCustomer(n.currentpage)};n.ResetGetCustomer=function(){n.LoadCookie_Customer();n.ListCustomer=[]};n.GetCustomer=function(t){n.ResetGetCustomer();n.IsLoading=!0;t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;var i=u+"GetCustomer",f=JSON.stringify({keyword:n.Filter.KEYWORD,currentPage:t,itemPerPage:n.cookie.RowNum});LoadingShow();r.PostDataAjax(i,f,function(t){t?t.rs?(toastr.options={timeOut:"2000"},n.ListCustomer=t.result,n.TotalPages=t.TotalPages,n.TotalRow=t.TotalRow):n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetCustomer");LoadingHide()});n.IsLoading=!1};n.SelectAll=function(){var t=n.ListCustomer.filter(function(t){return t.ISSELECTED==n.IsSelectAll});t.length>0&&t.forEach(function(t){t.ISSELECTED=!n.IsSelectAll})};n.SeleteRow=function(t){var i=n.ListCustomer.filter(function(n){return n.ISSELECTED==!0});t?n.IsSelectAll=!1:i.length==n.ListCustomer.length-1&&(n.IsSelectAll=!0)};n.ToggleShowMore=function(n){$(n).fadeToggle(300)};n.EditCustomer=function(t){n.CurrentCustomer={};angular.copy(t,n.CurrentCustomer)};n.DeletedCustomer=function(n){n.ISDELETED=!0;t.ModalCustomer(n,!1);$(".modal-customer").modal("show")};n.ExportExcel=function(){var t,i,r;n.IsLoading=!0;t=u+"ExportExcell";i={keyword:n.Filter.KEYWORD,currentPage:1};LoadingShow();r=$.fileDownload(t,{httpMethod:"POST",data:i});LoadingHide()};n.DeactiveCustomer=function(){var t=u+"DeactiveCustomer",i=JSON.stringify({customers:n.ListCustomer});LoadingShow();r.PostDataAjax(t,i,function(n){n?n.rs:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - DeactiveCustomer");LoadingHide()})};n.GetInvoiceByCustomer=function(t){t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;n.IsInfo=!1;var i=u+"GetInvoice",f=JSON.stringify({customer:n.CurrentCustomer,currentPage:n.currentpage});n.ListInvoiceCustomer=[];n.TotalPages=1;n.TotalRow=1;LoadingShow();r.PostDataAjax(i,f,function(t){t?t.rs?(n.ListInvoiceCustomer=t.result,n.TotalPages=t.TotalPages,n.TotalRow=t.TotalRow):n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetCustomer");LoadingHide()})};n.SendEmail=function(){var t=[];if(n.ListCustomer.forEach(function(n){n.ISSELECTED==!0&&n.CUSEMAIL&&t.push(n.CUSEMAIL)}),t.length==0)return!1;window.open("mailto:"+t.join(";"),"_blank")};$(".dropdown-menu").find("form").click(function(n){n.stopPropagation()});n.RemoveCustomer=function(i){var f=function(f){var e,o;if(!f)return!1;if(n.ListCustomerChecked=[],n.ListCustomerCheckCode=[],i)n.ListCustomerChecked.push(i.ID),n.ListCustomerCheckCode.push(i.CUSID);else{if(e=n.ListCustomer.filter(function(n){return n.ISSELECTED==!0}),e&&e.length===0){alert("Bạn chưa chọn khách hàng cần xóa.");return}if(e&&Object.keys(e).length>0)for(o=0;o<e.length;o++)n.ListCustomerChecked.push(e[o].ID),n.ListCustomerCheckCode.push(e[o].CUSID)}var s=n.ListCustomerChecked.join(";"),h=n.ListCustomerCheckCode.join(";"),c=u+"RemoveCustomer",l=JSON.stringify({idCustomers:s,customer:i,codeCus:h});LoadingShow();r.PostDataAjax(c,l,function(n){n&&n.rs?(toastr.success(n.msg),t.ReloadCustomer()):toastr.warning(n.msg);LoadingHide()})};confirm("Bạn có thực sự muốn xóa các khách hàng đã chọn không?","Thông báo","Không","Có",f)}}]);app.controller("SettingsController",["$scope","$timeout","CommonFactory","$rootScope",function(n,t,i){var r="/Settings/";LoadingShow();n.Tab={Parameter:!0,Email:!1,Zalo:!1};n.TabEmail={Account:!0,Template:!1};n.TabClick=function(t){n.Tab.Parameter=!1;n.Tab.Email=!1;n.Tab.Zalo=!1;switch(t){case 1:n.Tab.Parameter=!0;break;case 2:n.Tab.Email=!0;n.Enterprise.MAILSERVICEID=n.Enterprise.MAILSERVICEID.toString();n.LoadEmailTemplate();break;case 3:n.Tab.Zalo=!0;break;default:n.Tab.Parameter=!0}};n.TabEmailClick=function(i){n.TabEmail.Account=!1;n.TabEmail.Template=!1;switch(i){case 1:n.TabEmail.Account=!0;n.Enterprise.MAILSERVICEID=n.Enterprise.MAILSERVICEID.toString();t(function(){$("select.cb-select-mail").selectpicker()});break;case 2:n.TabEmail.Template=!0;n.Enterprise.EMAILTEMPLATEID="1";t(function(){$(".cb-select-template").selectpicker()})}};n.ExValue=1e4;n.IsDisable=!1;angular.element(function(){LoadingHide();n.EnableDisableSaveButton();n.Enterprise.MAILSERVICEID="2";$("select.cb-select-mail").selectpicker("refresh");$("select.cb-select-template").selectpicker("refresh")});n.EnableDisableSaveButton=function(){n.IsDisable=n.Enterprise.MAILSERVICEID!=="1"?!0:!1};n.GetUserInfo=function(){var t=r+"GetUserInfo",u=JSON.stringify({});i.PostDataAjax(t,u,function(t){t?t.rs?n.User=t.objUser:(n.ErrorMessage=t.msg,alert(t.msg)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SettingsController - GetUserInfo")})};n.SaveInfoUser=function(){var t=r+"UpdateUser",u=JSON.stringify({account:n.User});LoadingShow();i.PostDataAjax(t,u,function(t){t?t.rs?(n.GetUserInfo(),alert("Cập nhật thành công.")):(n.ErrorMessage=t.msg,alert(t.msg)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SettingsController - GetUserInfo");LoadingHide()})};n.UserUpdatePassword=function(){var t=r+"UserUpdatePassword",u=JSON.stringify({account:n.User});LoadingShow();i.PostDataAjax(t,u,function(t){t?t.rs?(alert("Câp nhật thành công."),n.User.PASSWORDHIDDEN="",n.User.NEWPASSWORD="",n.User.RENEWPASSWORD=""):(n.ErrorMessage=t.msg,alert(t.msg)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SettingsController - GetUserInfo");LoadingHide()})};n.SaveInfoEnterprise=function(){if(!n.Enterprise.COMTAXCODE)return alert("Vui lòng cập nhật mã số thuế."),!1;var t=r+"SaveInfoEnterprise",u=JSON.stringify({enterprise:n.Enterprise});LoadingShow();i.PostDataAjax(t,u,function(t){t?t.rs?(alert("Cập nhật thành công!"),location.reload(!0)):(n.ErrorMessage=t.msg,alert(t.msg)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SaveEnterprise");LoadingHide()})};n.SaveEmailConfig=function(){if(!n.Enterprise.MAILSERVICEID)return alert("Vui lòng chọn Dịch vụ Email trước khi lưu."),!1;if(parseInt(n.Enterprise.MAILSERVICEID)===EMAIL_SERVICE_TYPE.GMAIL){if(!n.Enterprise.MAILSERVICEACCOUNT)return alert("Vui lòng khai báo tên đăng nhập trước khi lưu."),!1;if(!validation.isEmailAddress(n.Enterprise.MAILSERVICEACCOUNT))return alert("Vui lòng nhập đúng định dạng email"),!1;if(!n.Enterprise.MAILSERVICEPASSWORD)return alert("Vui lòng khai báo mật khẩu trước khi lưu."),!1}var t=r+"SaveEmailConfig",u=JSON.stringify({enterprise:n.Enterprise});LoadingShow();i.PostDataAjax(t,u,function(t){t?t.rs?alert("Thành công!"):(n.ErrorMessage=t.msg,alert(t.msg)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SaveEnterprise");LoadingHide()})};n.CheckSetupEmailConfig=function(){var t=r+"CheckSetupEmailConfig",u=JSON.stringify({enterprise:n.Enterprise});LoadingShow();i.PostDataAjax(t,u,function(t){t?t.rs?(alert(t.msg),n.IsDisable=!1):(n.ErrorMessage=t.msg,alert(t.msg),n.IsDisable=!0):(alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - CheckSetupEmailConfig"),n.IsDisable=!0);LoadingHide()})};n.SaveZaloAccessToken=function(){if(!n.Enterprise.ZALOACCESSTOKEN)return alert("Vui lòng nhập vào access token ứng dụng của bạn."),!1;var t=r+"SaveZaloOAAccessToken",u=JSON.stringify({enterprise:n.Enterprise});i.PostDataAjax(t,u,function(n){n?n.rs?toastr.success(n.msg,"Thành công"):toastr.error(n.msg,"Thất bại"):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SettingsController - GetUserInfo")})};n.SaveEmailTemplate=function(){var t=r+"SaveEmailTemplate",u=JSON.stringify({enterprise:n.Enterprise});i.PostDataAjax(t,u,function(n){n?n.rs?toastr.success(n.msg,"Thành công"):toastr.error(n.msg,"Thất bại"):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SettingsController - GetUserInfo")})};n.LoadEmailTemplate=function(){var t=r+"LoadEmailTemplate",u=JSON.stringify({enterprise:n.Enterprise});i.PostDataAjax(t,u,function(t){t&&t.rs&&(n.Enterprise.EMAILTEMPLATECONTENT=t.msg)})};n.RestoreDefault=function(){var t=r+"RestoreDefault",u=JSON.stringify({enterprise:n.Enterprise});i.PostDataAjax(t,u,function(t){t&&t.rs&&(n.Enterprise.EMAILTEMPLATECONTENT=t.msg)})};n.ExportExcel=function(){var t,i,u;LoadingShow();n.IsCategory==!1&&(t=r+"ExportExcelIsCategory",i={hasProductData:n.hasProductData,hasCustomerData:n.hasCustomerData});u=$.fileDownload(t,{httpMethod:"POST",data:i,preparingMessageHtml:"Đang tải file vui lòng đợi...",failMessageHtml:"Có lỗi trong khi tải file excel."});LoadingHide()};n.uploadFile=function(i){var u,r,e,f;for(LoadingShow(),u=i.target.files,r=0;r<u.length;r++)e=u[r],f=new FileReader,f.onload=function(i){t(function(){n.Enterprise.COMLOGO=i.target.result;LoadingHide()},100)},f.readAsDataURL(e)};$(".dropdown-menu").find("form").click(function(n){n.stopPropagation()});t(function(){$("select.cb-select-mail").selectpicker();$("select.cb-select-template").selectpicker()});n.SaveParameter=function(t){var u="",f,e;if(t===1&&(n.Enterprise.QUANTITYPLACE=0,n.Enterprise.PRICEPLACE=0,n.Enterprise.MONEYPLACE=0,u="Khôi phục thành công!"),t===2){if(n.Enterprise.QUANTITYPLACE===undefined||n.Enterprise.PRICEPLACE===undefined||n.Enterprise.MONEYPLACE===undefined||n.Enterprise.QUANTITYPLACE===null||n.Enterprise.PRICEPLACE===null||n.Enterprise.MONEYPLACE===null)return toastr.warning("Tham số làm tròn nằm trong khoảng 0-8."),!1;u="Thay đổi thành công!"}f=r+"SaveParameter";e=JSON.stringify({enterprise:n.Enterprise});i.PostDataAjax(f,e,function(t){t?t.rs?toastr.success(u):(n.ErrorMessage=t.msg,alert(t.msg)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SaveParameter");LoadingHide()})};n.ShowPass=0;n.OpenHidePassword=function(){n.ShowPass==0?($(".password").attr("type","text"),$(".open-hide-pass").removeClass("fa-eye"),$(".open-hide-pass").addClass("fa-eye-slash"),n.ShowPass=1):($(".password").attr("type","password"),$(".open-hide-pass").addClass("fa-eye"),$(".open-hide-pass").removeClass("fa-eye-slash"),n.ShowPass=0)}}]);app.controller("CategoryController",["$scope","$rootScope","$timeout","CommonFactory","persistObject",function(n,t,i,r){var u="/Category/";n.Filter={KEYWORD:"",PRODUCTTYPE:0,CATEGORY:null};n.LoadCookie_Category=function(){var t=getCookie("Novaon_CategoryManagement");t?n.cookie=JSON.parse(t):(n.cookie={FieldID:!0,FieldCategoryName:!0,FieldIsActived:!0,RowNum:10},setCookie("Novaon_CategoryManagement",JSON.stringify(n.cookie),30))};n.Check=function(t,i){(n.cookie[i]=i=="RowNum"?t:!t,setCookie("Novaon_CategoryManagement",JSON.stringify(n.cookie),30),i=="RowNum")&&n.GetCategory(n.currentpage)};t.ReloadCategory=function(t){t==1&&(n.currentpage=t);n.GetCategory(n.currentpage)};n.ResetGetCategory=function(){n.LoadCookie_Category();n.ListCategory=[]};n.GetCategory=function(t){n.ResetGetCategory();n.IsLoading=!0;t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;var i=u+"GetCategory",f=JSON.stringify({keyword:n.Filter.KEYWORD,pagesize:n.cookie.RowNum,currentpage:n.currentpage});LoadingShow();r.PostDataAjax(i,f,function(t){t?t.rs?(n.ListCategory=t.result,n.TotalPages=t.TotalPages,n.TotalRow=t.TotalRow):n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetCategory");LoadingHide()});n.IsLoading=!1};n.SelectAll=function(){var t=n.ListCategory.filter(function(t){return t.ISSELECTED==n.IsSelectAll});t.length>0&&t.forEach(function(t){t.ISSELECTED=!n.IsSelectAll})};n.SeleteRow=function(t){var i=n.ListCategory.filter(function(n){return n.ISSELECTED==!0});t?n.IsSelectAll=!1:i.length==n.ListCategory.length-1&&(n.IsSelectAll=!0)};n.RemoveCategory=function(i){var f=function(f){var o,e;if(!f)return!1;if(n.count=0,n.ListCategoryChecked=[],n.ListCategoryActive=[],i){if(i.ISACTIVE==!0)return toastr.warning("Không được phép xóa khi đang ở trạng thái hoạt động"),!1;n.ListCategoryChecked.push(i.ID);n.count=1}else{if(o=n.ListCategory.filter(function(n){return n.ISSELECTED==!0}),o&&o.length===0){toastr.warning("Bạn chưa chọn dịch vụ cần xóa.");return}if(o&&Object.keys(o).length>0){for(e=0;e<o.length;e++)n.ListCategoryChecked.push(o[e].ID),n.ListCategoryActive.push(o[e].ISACTIVE);for(e=0;e<n.ListCategoryActive.length;e++)n.ListCategoryActive[e]===!1&&n.count++}}var s=n.ListCategoryChecked.join(";"),h=u+"RemoveCategory",c=JSON.stringify({id:s,count:n.count});LoadingShow();r.PostDataAjax(h,c,function(n){n&&n.rs?(toastr.success(n.msg),t.ReloadCategory()):toastr.warning(n.msg);LoadingHide()})};confirm("Bạn có thực sự muốn xóa các dịch vụ đã chọn không?","Thông báo","Không","Có",f)};n.ExportExcel=function(){var t,i,r,f;t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;i=u+"ExportExcell";r={keyword:n.Filter.KEYWORD,pagesize:n.cookie.RowNum,currentpage:n.currentpage};LoadingShow();f=$.fileDownload(i,{httpMethod:"POST",data:r});LoadingHide()}}]);app.controller("StatisticController",["$scope","$timeout","CommonFactory","$rootScope",function(n,t,i,r){var o="/Statistic/",e,s,h,c,l,a;angular.element(function(){LoadingHide()});e=new Date;n.CurrentDay=e.getDate();n.CurrentMonth=e.getMonth()+1;n.CurrentYear=e.getFullYear();n.CurrentDate=e.getDate()+"/"+(e.getMonth()+1)+"/"+e.getFullYear();n.GetQuarter=function(t){return t>=1&&t<=3?(n.ReportInvoice.FROMDATE="01/01/"+n.ReportInvoice.YEAR,n.ReportInvoice.TODATE="31/03/"+n.ReportInvoice.YEAR,1):t>=4&&t<=6?(n.ReportInvoice.FROMDATE="01/04/"+n.ReportInvoice.YEAR,n.ReportInvoice.TODATE="30/06/"+n.ReportInvoice.YEAR,2):t>=7&&t<=9?(n.ReportInvoice.FROMDATE="01/07/"+n.ReportInvoice.YEAR,n.ReportInvoice.TODATE="30/09/"+n.ReportInvoice.YEAR,3):t>=10&&t<=12?(n.ReportInvoice.FROMDATE="01/10/"+n.ReportInvoice.YEAR,n.ReportInvoice.TODATE="31/12/"+n.ReportInvoice.YEAR,4):void 0};n.InitReportInvoice=function(){n.ReportInvoice={};n.ReportInvoice.YEAR=n.CurrentYear;n.ReportInvoice.MONTHQUARTER="Q"+n.GetQuarter(n.CurrentMonth)};n.InitReportInvoice();n.GetOutputInvoice=function(){var t=o+"GetOutputInvoice",u=JSON.stringify({reportUsingInvoice:n.ReportInvoice});LoadingShow();i.PostDataAjax(t,u,function(t){if(t)if(t.rs){let i=t.result[0];n.OutputInvoiceData=i;n.TOTALREVENUEPRETAX=parseFloat(parseFloat(i.SUMREVENUENOTAX)+parseFloat(i.SUMREVENUEZEROPERCENTTAX)+parseFloat(i.SUMREVENUEFIVEPERCENTTAX)+parseFloat(i.SUMREVENUETENPERCENTTAX));n.TOTALREVENUEUNDERTAX=parseFloat(parseFloat(i.SUMREVENUETENPERCENTTAX)+parseFloat(i.SUMREVENUEFIVEPERCENTTAX)+parseFloat(i.SUMREVENUEZEROPERCENTTAX));n.TOTALTAXMONEY=parseFloat(parseFloat(.1*i.SUMREVENUETENPERCENTTAX)+parseFloat(.05*i.SUMREVENUEFIVEPERCENTTAX));n.ReportTime=t.reportTime;r.Enterprise.USINGINVOICETYPE===AccountObjectType.HOADONBANHANG&&(n.TOTALREVENUEUNDERTAX=parseFloat(parseFloat(i.SUMREVENUEFIVEPERCENTTAX)+parseFloat(i.SUMREVENUETHREEPERCENTTAX)+parseFloat(i.SUMREVENUETWOPERCENTTAX)+parseFloat(i.SUMREVENUEONEPERCENTTAX)+parseFloat(i.SUMREVENUEZEROPERCENTTAX)),n.TOTALTAXMONEY=parseFloat(parseFloat(.01*i.SUMREVENUEONEPERCENTTAX)+parseFloat(.02*i.SUMREVENUETWOPERCENTTAX)+parseFloat(.03*i.SUMREVENUETHREEPERCENTTAX)+parseFloat(.05*i.SUMREVENUEFIVEPERCENTTAX)))}else n.ErrorMessage=t.msg;else alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetCustomer");LoadingHide()})};n.GetUsingInvoiceStatus=function(){var t=o+"GetUsingInvoice",r=JSON.stringify({reportUsingInvoice:n.ReportInvoice});LoadingShow();i.PostDataAjax(t,r,function(t){t?t.rs?(n.UsingInvoiceList=t.listUsingInvoiceThisTerm,n.ReportTime=t.reportTime):(n.ErrorMessage=t.msg,n.UsingInvoiceList=t.listUsingInvoiceThisTerm):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetCustomer");LoadingHide()})};n.GetEmailHistory=function(r){var s,h,u,e,f;n.FROMTIME=$("#pk_fromtime").val();n.TOTIME=$("#pk_totime").val();n.Filter||(n.Filter={});n.Filter.TIME=="5"&&(n.FROMTIME=moment(n.FROMTIME).format("YYYY-MM-DD"),n.TOTIME=moment(n.TOTIME).format("YYYY-MM-DD"),n.Filter.TIME=n.FROMTIME+";"+n.TOTIME,n.FROMTIME&&n.TOTIME||(n.Filter.TIME=n.Timepickers.Options[0].value));r||(r=1);r>n.TotalPages&&(r=n.TotalPages);n.currentRow=10;n.currentpage=r;n.ListEmailHistory=[];s=o+"GetEmailHistoryByComtaxcode";h=JSON.stringify({form:n.Filter,itemPerPage:n.currentRow,currentPage:n.currentpage});i.PostDataAjax(s,h,function(i){i?i.rs?t(function(){n.ListEmailHistory=i.result;n.TotalPages=i.TotalPages;n.TotalRow=i.TotalRow},200):n.ErrorMessage=i.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetCustomer");LoadingHide()});n.FilterApply=[];for(u in n.Filter)n.Filter[u]!=null&&(e={key:u,value:n.Filter[u]},u=="MAILTO"&&(f=n.ListInvoiceStatus.filter(function(t){return t.MAILTO==n.Filter[u]}),e.value=f[0].MAILTO),u=="TIME"&&(f=n.Timepickers.Options.filter(function(t){return t.value==n.Filter[u]}),e.value=f[0].TIME),u=="STATUS"&&(f=n.ListPaymentStatus.filter(function(t){return t.STATUS==n.Filter[u]}),e.value=f[0].STATUS),u=="MAILTYPE"&&(f=n.ListSymbolCode.filter(function(t){return t.MAILTYPE==n.Filter[u]}),e.value=f[0].MAILTYPE),n.FilterApply.push(e))};n.RemoveFilter=function(t){for(var i in n.Filter)if(i==t.key){n.Filter[i]=null;break}n.FilterInvoice()};$(".dropdown-menu").find("form").click(function(n){n.stopPropagation()});var e=new Date,u=new Date,f=new Date,v=e.getDay();u.setDate(e.getDate()-v);f.setDate(u.getDate()+6);s=u.getFullYear()+"-"+(u.getMonth()+1)+"-"+u.getDate()+";"+f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate();u.setDate(u.getDate()-7);f.setDate(f.getDate()-7);h=u.getFullYear()+"-"+(u.getMonth()+1)+"-"+u.getDate()+";"+f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate();c=new Date(e.getFullYear(),e.getMonth()+1,0).getDate();u=new Date(e.getFullYear(),e.getMonth(),1);f=new Date(e.getFullYear(),e.getMonth(),c);l=u.getFullYear()+"-"+(u.getMonth()+1)+"-"+u.getDate()+";"+f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate();f.setDate(u.getDate()-1);u=new Date(f.getFullYear(),f.getMonth(),1);a=u.getFullYear()+"-"+(u.getMonth()+1)+"-"+u.getDate()+";"+f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate();n.Timepickers={value:s,Options:[{id:1,value:s,text:"Tuần này"},{id:2,value:h,text:"Tuần trước"},{id:3,value:l,text:"Tháng này"},{id:4,value:a,text:"Tháng trước"},{id:5,value:"5",text:"Tùy chọn"}]};n.SetDatepikerFromTime=function(){$("#pk_fromtime").datepicker({dateFormat:"yy-mm-dd",maxDate:new Date});SetVietNameInterface($("#pk_fromtime"));$("#pk_fromtime").datepicker({dateFormat:"dd/mm/yy",maxDate:new Date})};n.SetDatepikerToTime=function(){var t=n.TOTIME;$("#pk_totime").datepicker("option","minDate",t);$("#pk_totime").datepicker({dateFormat:"yy-mm-dd",minDate:new Date(t)});SetVietNameInterface($("#pk_totime"));t=n.TOTIME;$("#pk_totime").datepicker("option","minDate",t);$("#pk_totime").datepicker({dateFormat:"dd/mm/yy",minDate:new Date(t)});SetVietNameInterface($("#pk_totime"))};n.LISTMAILTYPE=[{value:"Phat-hanh",name:"Thông báo phát hành"},{value:"Huy",name:"Thông báo hủy"}];n.LISTMAILSTATUS=[{value:1,name:"Đã gửi"},{value:2,name:"Đã xem"},{value:3,name:"Gửi lỗi"}]}]);app.controller("UserController",["$scope","$rootScope","$timeout","CommonFactory","persistObject","permissions",function(n,t,i,r,u,f){var e="/User/";n.ActiveTab=1;n.ListRoleDetail=[];n.ListRoleDetailChecked=[];n.User=null;n.KEYWORD="";t.ReloadUser=function(t){t==1&&(n.currentpage=t);n.GetUser(n.currentpage)};n.GetUser=function(t){t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;n.TotalPages=1;n.TotalRow=1;var i=e+"GetAllUserByComtaxCode",u=JSON.stringify({keyword:n.KEYWORD,page:t});LoadingShow();r.PostDataAjax(i,u,function(t){t?t.rs?(n.ListUser=t.result,n.TotalPages=t.totalPages,n.TotalRow=t.totalRow):alert(t.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetUser");LoadingHide()})};n.GetRole=function(){var t=e+"GetRole",i=JSON.stringify({});r.PostDataAjax(t,i,function(t){t?t.rs?n.ListRole=t.result:alert(t.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetRole")})};n.GetRole();n.GetRoleDetail=function(){var t=e+"GetRoleDetail",i=JSON.stringify({});r.PostDataAjax(t,i,function(t){t?t.rs?n.ListRoleDetail=t.result:alert(t.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetRole")})};n.GetRoleDetail();n.GetRoleDetailByUserId=function(t){var i=e+"GetRoleDetailByUserId",u=JSON.stringify({email:t});LoadingShow();r.PostDataAjax(i,u,function(t){t?t.rs?(n.ListRoleDetailChecked=t.result,n.ListRoleDetailChecked.forEach(t=>{n.ListRoleDetail.filter(n=>{n.ID===t.ROLEDETAILID&&(n.ISSELECTED=!0)})})):alert(t.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetRoleDetailByUserId");LoadingHide()})};n.UpdateUserRole=function(){if(!n.ISEDIT&&!n.User.EMAIL){toastr.warning("Không thể phân quyền cho người người dùng chưa tạo.","Cảnh báo",{timeOut:2e3});return}n.ListRoleDetailChecked.forEach(function(t){t.USERNAME=n.User.EMAIL});var t=e+"UpdateUserRole",i=JSON.stringify({email:n.User.EMAIL,userRoleDetail:n.ListRoleDetailChecked});LoadingShow();r.PostDataAjax(t,i,function(n){n?n.rs?toastr.success(n.msg,"Thành công",{timeOut:2e3}):toastr.error(n.msg,"Thất bại",{timeOut:2e3}):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetRoleDetailByUserId");LoadingHide()})};n.AddUser=function(){var t,i;if(!n.User.EMAIL){toastr.warning("Vui lòng nhập vào email.","Cảnh báo",{timeOut:2e3});return}if(!n.ISEDIT&&!n.User.PASSWORD){toastr.warning("Vui lòng nhập vào mật khẩu.","Cảnh báo",{timeOut:2e3});return}t=e+"AddUser";t=n.ISEDIT?e+"UpdateUser":e+"AddUser";i=JSON.stringify({registerForm:n.User});LoadingShow();r.PostDataAjax(t,i,function(t){t?t.rs?(toastr.success(t.msg,"Thành công",{timeOut:2e3}),n.GetUser(1)):toastr.error(t.msg,"Thất bại",{timeOut:2e3}):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - AddUser");LoadingHide()})};n.DeleteUser=function(t){var i=function(i){if(i){var u=e+"DeleteUser",f=JSON.stringify({account:t});LoadingShow();r.PostDataAjax(u,f,function(t){t?t.rs?(toastr.success(t.msg,"Thành công",{timeOut:2e3}),n.GetUser(1)):toastr.error(t.msg,"Thất bại",{timeOut:2e3}):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - DeleteUser");LoadingHide()})}else return!1};confirm("Bạn chắc chắn muốn xóa người dùng này không "+t.EMAIL+"?","Xóa người dùng","Không","Có",i)};n.ShowActiveTab=function(t){n.ActiveTab=t};n.SelectCheckbox=function(t,i){var r={USERNAME:n.User.EMAIL,ROLEDETAILID:i};if(t){const t=n.ListRoleDetailChecked.findIndex(n=>n.ROLEDETAILID===i);t>-1&&n.ListRoleDetailChecked.splice(t,1)}else n.ListRoleDetailChecked.push(r)};n.ModalAddEditUser=function(t,i){n.ListRoleDetail.filter(n=>{n.ISSELECTED=!1});i===2&&n.GetRoleDetailByUserId(t.EMAIL);n.ISEDIT=!1;n.FormTitle="Thêm người dùng";i==2&&(n.FormTitle="Cập nhật thông tin người dùng",n.ISEDIT=!0,t.PASSWORD="");$("#modal-addedit-user").dialog({title:n.FormTitle,width:"85%",modal:!0,resizable:!1,scope:n,permissions:f,show:{effect:"fade",direction:"top",duration:100},hide:{effect:"fade",duration:200},create:function(){$("#modal-addedit-user").show()},close:function(){n.ListRoleDetailChecked=[]}});n.User={};angular.copy(t,n.User)};n.ShowPass=0;n.OpenHidePassword=function(){n.ShowPass==0?($(".password").attr("type","text"),$(".open-hide-pass").removeClass("fa-eye"),$(".open-hide-pass").addClass("fa-eye-slash"),n.ShowPass=1):($(".password").attr("type","password"),$(".open-hide-pass").addClass("fa-eye"),$(".open-hide-pass").removeClass("fa-eye-slash"),n.ShowPass=0)};$(".dropdown-menu").find("form").click(function(n){n.stopPropagation()})}]);app.controller("ModalInvoiceController",["$scope","$rootScope","$timeout","$sce","CommonFactory","$filter","$http","$location","permissions",function(n,t,r,u,f,e,o,s){var h="/Invoice/",l="Từ ngày của kỳ thanh toán không được lớn hơn đến ngày.",c;t.ModalInvoice=function(i,u,f,o,s){var h;t.Enterprise||t.GetEnterpriseInfo();n.TYPECHANGE=u;n.Invoice={};n.Invoice.LISTPRODUCT=[];n.Invoice.INVOICETYPE=u;n.IsCopy=!1;n.ONLYTAXRATE=n.TaxRateList[0].value;n.Invoice.CURRENCY="VND";n.Invoice.EXCHANGERATE=1;n.GLOBALTAXRATEWATER=0;n.Invoice.SERVICEFEETAXRATE=n.TaxRateList[0].value;n.Invoice.CUSTOMFIELDEXCHANGERATE=0;n.Invoice.CUSTOMFIELDEXCHANGE=0;n.LoadCurrencyExchangeRate();n.TempListFormCode=t.ListFormCode;$(".modal-invoice").modal("show");u==1?(n.Invoice.ID=0,n.Invoice.CUSPAYMENTMETHOD="TM/CK",n.Invoice.FORMCODE=t.ListFormCode[0].FORMCODE+"-"+t.ListFormCode[0].SYMBOLCODE,n.Invoice.SYMBOLCODE=t.ListFormCode[0].SYMBOLCODE,n.TAXRATE=t.ListFormCode[0].TAXRATE,n.Invoice.DISCOUNTTYPE="KHONG_CO_CHIET_KHAU",i?(angular.copy(i,n.Invoice),s?(h=t.ListFormCode.filter(function(n){return n.SYMBOLCODE===i.SYMBOLCODE&&n.FORMCODE===i.FORMCODE}),n.TAXRATE=h[0].TAXRATE,n.Invoice.FORMCODE=i.FORMCODE+"-"+i.SYMBOLCODE,n.Invoice.INVOICESTATUS=1,n.Invoice.NUMBER=0,n.Invoice.ID=0,n.Invoice.INVOICETYPE=u,n.Invoice.REFERENCE=0,n.Invoice.EXCHANGERATE=n.Invoice.EXCHANGERATE.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),n.IsCopy=s,(t.Enterprise.USINGINVOICETYPE===2||t.Enterprise.USINGINVOICETYPE===4)&&n.GetMeterByInvoiceId(i.ID),n.GetInvoiceDetail(i.ID)):n.MeterList=null):(n.Invoice.NUMBER=0,(t.Enterprise.USINGINVOICETYPE===AccountObjectType.HOADONGTGT||t.Enterprise.USINGINVOICETYPE===AccountObjectType.HOADONBANHANG||t.Enterprise.USINGINVOICETYPE===AccountObjectType.PHIEUXUATKHO)&&r(function(){n.AddRow()},100)),n.MeterList=null,n.Invoice.METER={METERNAME:"[Số công tơ]",CODE:"[Số công tơ]"},f&&o&&(n.Invoice.FORMCODE=f,n.Invoice.SYMBOLCODE=o,n.Invoice.NUMBER=0,n.Invoice.INVOICESTATUS=1,n.Invoice.INVOICETYPE=1,n.Invoice.ISINVOICEWAITING=!0)):u==2?(i.EXCHANGERATE=i.EXCHANGERATE.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),(i.INVOICETYPE==5||i.INVOICETYPE==3||i.INVOICETYPE==6)&&n.GetInvoiceById(i.REFERENCE),angular.copy(i,n.Invoice),h=t.ListFormCode.filter(function(n){return n.SYMBOLCODE===i.SYMBOLCODE&&n.FORMCODE===i.FORMCODE}),n.Invoice.FORMCODE=h[0].FORMCODE+"-"+h[0].SYMBOLCODE,n.Invoice.SYMBOLCODE=h[0].SYMBOLCODE,n.TAXRATE=h[0].TAXRATE,(t.Enterprise.USINGINVOICETYPE===2||t.Enterprise.USINGINVOICETYPE===4)&&n.GetMeterByInvoiceId(n.Invoice.ID),n.GetInvoiceDetail(i.ID),setTimeout(function(){n.RefInvoice&&(n.Invoice.NUMBERTEMP=n.RefInvoice.NUMBER,n.Invoice.SIGNEDTIME=n.RefInvoice.SIGNEDTIME)},2e3)):u==5?(angular.copy(i,n.Invoice),h=t.ListFormCode.filter(function(n){return n.SYMBOLCODE===i.SYMBOLCODE&&n.FORMCODE===i.FORMCODE}),n.Invoice.FORMCODE=h[0].FORMCODE+"-"+h[0].SYMBOLCODE,n.Invoice.SYMBOLCODE=h[0].SYMBOLCODE,n.TAXRATE=h[0].TAXRATE,n.Invoice.INVOICESTATUS=1,n.Invoice.NUMBER=0,n.Invoice.ID=0,n.Invoice.INVOICETYPE=u,n.Invoice.REFERENCE=i.ID,n.Invoice.NUMBERTEMP=i.NUMBER,(t.Enterprise.USINGINVOICETYPE===2||t.Enterprise.USINGINVOICETYPE===4)&&n.GetMeterByCustaxcode(n.Invoice.CUSTAXCODE),n.Invoice.LISTPRODUCT=[],n.GetInvoiceDetail(i.ID)):u==6&&(angular.copy(i,n.Invoice),h=t.ListFormCode.filter(function(n){return n.SYMBOLCODE===i.SYMBOLCODE&&n.FORMCODE===i.FORMCODE}),n.Invoice.FORMCODE=h[0].FORMCODE+"-"+h[0].SYMBOLCODE,n.Invoice.SYMBOLCODE=h[0].SYMBOLCODE,n.TAXRATE=h[0].TAXRATE,(t.Enterprise.USINGINVOICETYPE===2||t.Enterprise.USINGINVOICETYPE===4)&&n.GetMeterByCustaxcode(n.Invoice.CUSTAXCODE),n.GetInvoiceDetail(i.ID),n.Invoice.NUMBER=0,n.Invoice.ID=0,n.Invoice.INVOICESTATUS=1,n.Invoice.INVOICETYPE=u,n.Invoice.REFERENCE=i.ID,n.Invoice.NUMBERTEMP=i.NUMBER);n.Invoice.STRDUEDATE=e("dateFormat")(n.Invoice.DUEDATE,"dd/MM/yyyy");n.Invoice.STRINVOICEWAITINGTIME=e("dateFormat")(n.Invoice.INVOICEWAITINGTIME,"dd/MM/yyyy");n.Invoice.FROMDATE=e("dateFormat")(n.Invoice.FROMDATE,"dd/MM/yyyy");n.Invoice.TODATE=e("dateFormat")(n.Invoice.TODATE,"dd/MM/yyyy");n.Invoice.DELIVERYORDERDATE=e("dateFormat")(n.Invoice.DELIVERYORDERDATE,"dd/MM/yyyy");n.Invoice.FROMDATESTR=n.Invoice.FROMDATE;n.Invoice.TODATESTR=n.Invoice.TODATE;n.Invoice.DELIVERYORDERDATESTR=n.Invoice.DELIVERYORDERDATE;$(".datepicker").datepicker({buttonText:"Chọn ngày tháng",dateFormat:"dd/mm/yy"})};n.LoadCookie_Invoice_CustomField=function(){var t=getCookie("Novaon_Invoice_CustomField");t?n.cookie_customField=JSON.parse(t):(n.cookie_customField={FieldConsignment:!1,FieldProductService:!0,FieldUnit:!0,FieldQuantity:!0,FieldPrice:!0,FieldMoney:!0,FieldExchangeRateAdd:!1,FieldExchangeAdd:!1,FieldOtherTaxFee:!1,FieldRefundFee:!1,FieldServiceFee:!1},setCookie("Novaon_Invoice_CustomField",JSON.stringify(n.cookie_customField),30))};n.Check=function(t,i){n.cookie_customField[i]=!t;setCookie("Novaon_Invoice_CustomField",JSON.stringify(n.cookie_customField),30)};n.GetInvoiceDetail=function(i){var u=h+"GetInvoiceDetail",e=JSON.stringify({invoiceid:i});LoadingShow();f.PostDataAjax(u,e,function(i){i?i.rs?(n.Invoice.LISTPRODUCT=i.result,n.Invoice.LISTPRODUCT.length==0&&r(function(){n.AddRow()}),n.TAXRATE===1&&n.Invoice.LISTPRODUCT.length>0&&(n.ONLYTAXRATE=n.Invoice.LISTPRODUCT[0].TAXRATE,n.GLOBALTAXRATE=n.Invoice.LISTPRODUCT[0].TAXRATE),r(function(){n.Invoice.LISTPRODUCT&&Object.keys(n.Invoice.LISTPRODUCT).length>0&&(n.GLOBALTAXRATEWATER=n.Invoice.LISTPRODUCT[0].TAXRATEWATER,setSelectedValueDropdown(t.Enterprise.USINGINVOICETYPE,n.Invoice.LISTPRODUCT[0].METERCODE))},100)):n.ErrorMessage=i.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetInvoiceDetail");LoadingHide()})};n.AddInvoice=function(i,r){var u={messErrorForCustomer:"",messErrorForCoder:"",result:!0},e,o,c,a;if(!n.Invoice.FORMCODE)return alert("Vui lòng chọn mẫu số hóa đơn"),!1;if(e=n.Invoice.FORMCODE.split("-"),n.Invoice.FORMCODE=e[0],n.Invoice.SYMBOLCODE=e[1],!n.Invoice.SYMBOLCODE)return alert("Vui lòng chọn ký hiệu hóa đơn"),!1;if((t.Enterprise.USINGINVOICETYPE===2||t.Enterprise.USINGINVOICETYPE===4)&&((u=CheckDate(n.Invoice.FROMDATE,"Kỳ thanh toán từ ngày",10,!0),u.result===!1)||(u=CheckDate(n.Invoice.TODATE,"Kỳ thanh toán đến ngày",10,!0),u.result===!1)||(u=compareDates(n.Invoice.FROMDATE,n.Invoice.TODATE,l),u.result===!1)))return alert(u.messErrorForCustomer),!1;if(t.Enterprise.USINGINVOICETYPE===AccountObjectType.PHIEUXUATKHO){if(!n.Invoice.CUSNAME)return alert("Của: không được để trống"),!1;if((u=CheckDate(n.Invoice.DELIVERYORDERDATE,"Ngày",10,!0),u.result===!1)||(u=CheckDate(n.Invoice.FROMDATE,"Ngày xuất kho",10,!0),u.result===!1))return alert(u.messErrorForCustomer),!1}if(!n.Invoice.CUSNAME&&!n.Invoice.CUSBUYER)return alert("Bạn phải nhập vào thông tin <strong>Tên đơn vị<\/strong> hoặc thông tin <b>Người mua hàng<\/b>"),!1;if(!n.Invoice.CUSPAYMENTMETHOD)return alert("Vui lòng chọn hình thức thanh toán"),!1;if(n.Invoice.INVOICETYPE===5&&n.Invoice.INVOICEMETHOD===0)return alert("Vui chọn loại hóa đơn điều chỉnh."),!1;if(n.Invoice.CUSEMAIL&&!validation.isEmailAddress(n.Invoice.CUSEMAIL)){alert("Vui lòng nhập đúng định dạng email.");return}if(!n.Invoice.CHANGEREASON&&n.Invoice.INVOICETYPE==5)return alert("Vui lòng nhập lý do điều chỉnh."),!1;if(n.Invoice.INVOICETYPE!=5&&(n.Invoice.LISTPRODUCT.forEach(function(t,i){t.PRODUCTNAME||n.Invoice.INVOICETYPE==5||alert("Tên sản phẩm không được để trống, vui lòng kiểm tra lại dữ liệu dòng thứ "+(i+1));t.TAXRATEWATER=n.GLOBALTAXRATEWATER;t.QUANTITY=parseFloat(t.QUANTITY.toString())}),o=n.Invoice.LISTPRODUCT.filter(function(n){return!n.PRODUCTNAME}),o.length>0&&n.Invoice.INVOICETYPE!=5))return!1;n.TAXRATE==1&&n.Invoice.LISTPRODUCT.forEach(function(t){t.TAXRATE=n.GLOBALTAXRATE;t.TAXRATEWATER=n.GLOBALTAXRATEWATER});n.Invoice.EXCHANGERATE=n.Invoice.EXCHANGERATE.toString().replace(/\,/g,"").replace(/\./g,"");n.CalMoneyAfterChangeValue();n.Invoice.LISTPRODUCT.forEach(function(n){n.TOTALMONEY=n.ITEMTOTALMONEY});n.Invoice.TOTALPAYMENT=n.Invoice.TOTALPAYMENTRAW;n.Invoice.TOTALMONEY=n.Invoice.TOTALMONEYRAW;n.Invoice.TAXMONEY=n.Invoice.TAXMONEYRAW;LoadingShow();c=h+"AddInvoice";a=JSON.stringify({invoice:n.Invoice,type:i});f.PostDataAjax(c,a,function(n){if(n)if(n.rs)if(r){var i=n.result;Sign(i).then(function(){toastr.success("Thêm mới thành công!","Thành công",{timeOut:4e3});$(".modal-invoice").modal("hide");s.path().toString().includes("/bien-lai-thu-phi-le-phi")?t.ReloadReceipt():s.path().toString().includes("/quan-ly-hoa-don")&&t.ReloadInvoice()})}else toastr.success("Thêm mới thành công!","Thành công",{timeOut:4e3}),$(".modal-invoice").modal("hide"),s.path().toString().includes("/bien-lai-thu-phi-le-phi")?t.ReloadReceipt():s.path().toString().includes("/quan-ly-hoa-don")&&t.ReloadInvoice();else alert(n.msg);else alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SaveAndSend");LoadingHide()})};n.UpdateInvoice=function(i,r){var e,u,o,c,a;if(!n.Invoice.FORMCODE)return alert("Vui lòng chọn mẫu số hóa đơn"),$("select#form-code").focus(),!1;if(e=n.Invoice.FORMCODE.split("-"),n.Invoice.FORMCODE=e[0],n.Invoice.SYMBOLCODE=e[1],!n.Invoice.SYMBOLCODE)return alert("Vui lòng chọn mẫu số hóa đơn"),$("select#symbol-code").focus(),!1;if((t.Enterprise.USINGINVOICETYPE===2||t.Enterprise.USINGINVOICETYPE===4)&&((u={messErrorForCustomer:"",messErrorForCoder:"",result:!0},u=CheckDate(n.Invoice.FROMDATE,"Kỳ thanh toán từ ngày",10,!0),u.result===!1)||(u=CheckDate(n.Invoice.TODATE,"Kỳ thanh toán đến ngày",10,!0),u.result===!1)||(u=compareDates(n.Invoice.FROMDATE,n.Invoice.TODATE,l),u.result===!1))||t.Enterprise.USINGINVOICETYPE===AccountObjectType.PHIEUXUATKHO&&((u=CheckDate(n.Invoice.DELIVERYORDERDATE,"Ngày",10,!0),u.result===!1)||(u=CheckDate(n.Invoice.FROMDATE,"Ngày xuất kho",10,!0),u.result===!1)))return alert(u.messErrorForCustomer),!1;if(n.Invoice.CUSEMAIL&&!validation.isEmailAddress(n.Invoice.CUSEMAIL)){alert("Vui lòng nhập đúng định dạng email");return}if(!n.Invoice.CHANGEREASON&&n.Invoice.INVOICETYPE==5)return alert("Vui lòng nhập lý do điểu chỉnh"),!1;if(n.Invoice.INVOICETYPE!=5&&(n.Invoice.LISTPRODUCT.forEach(function(t,i){t.PRODUCTNAME||n.Invoice.INVOICETYPE==5||alert("Tên sản phẩm không được để trống, vui lòng kiểm tra lại dữ liệu dòng thứ "+(i+1));t.TAXRATEWATER=n.GLOBALTAXRATEWATER;t.QUANTITY=parseFloat(t.QUANTITY.toString())}),o=n.Invoice.LISTPRODUCT.filter(function(n){return!n.PRODUCTNAME}),o.length>0&&n.Invoice.INVOICETYPE!=5))return!1;n.TAXRATE==1&&n.Invoice.LISTPRODUCT.forEach(function(t){t.TAXRATE=n.GLOBALTAXRATE});n.Invoice.EXCHANGERATE=n.Invoice.EXCHANGERATE.toString().replace(/\,/g,"");n.Invoice.LISTPRODUCT.forEach(function(n){n.TOTALMONEY=n.ITEMTOTALMONEY});n.Invoice.TOTALPAYMENT=n.Invoice.TOTALPAYMENTRAW;n.Invoice.TOTALMONEY=n.Invoice.TOTALMONEYRAW;n.Invoice.TAXMONEY=n.Invoice.TAXMONEYRAW;LoadingShow();c=h+"UpdateInvoice";a=JSON.stringify({invoice:n.Invoice,type:i});f.PostDataAjax(c,a,function(i){if(i)if(i.rs)if(r){var u=i.result;Sign(u).then(function(){toastr.success("Cập nhật thành công!","Thành công",{timeOut:4e3});$(".modal-invoice").modal("hide");s.path().toString().includes("/dai-hoa-don-cho")?t.ReloadWaitingInvoice(n.Invoice.FORMCODE,n.Invoice.SYMBOLCODE):t.ReloadInvoice()})}else toastr.success("Cập nhật thành công!","Thành công",{timeOut:2e3}),$(".modal-invoice").modal("hide"),s.path().toString().includes("/dai-hoa-don-cho")?t.ReloadWaitingInvoice(n.Invoice.FORMCODE,n.Invoice.SYMBOLCODE):t.ReloadInvoice();else alert(i.msg);else alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SaveAndSend");LoadingHide()})};n.AddRow=function(){n.Invoice.LISTPRODUCT||(n.Invoice.LISTPRODUCT=[]);t.Enterprise.USINGINVOICETYPE===AccountObjectType.PHIEUXUATKHO?n.Invoice.LISTPRODUCT.push({PRODUCTNAME:"",QUANTITYUNIT:"Khác",QUANTITY:1,INQUANTITY:1,TAXRATE:0,RETAILPRICE:0,GROUPID:0,SORTORDER:0,CONSIGNMENTID:"",DESCRIPTION:null}):n.Invoice.LISTPRODUCT.push({PRODUCTNAME:"",QUANTITYUNIT:"Khác",QUANTITY:1,TAXRATE:-1,RETAILPRICE:0,OTHERTAXFEE:0,REFUNDFEE:0,DISCOUNTRATE:0,TOTALDISCOUNT:0,GROUPID:0,SORTORDER:0,CONSIGNMENTID:"",DESCRIPTION:null})};n.AddRowHeader=function(){n.Invoice.LISTPRODUCT||(n.Invoice.LISTPRODUCT=[]);n.Invoice.LISTPRODUCT.push({PRODUCTNAME:"",QUANTITYUNIT:"Khác",QUANTITY:0,TAXRATE:0,OTHERTAXFEE:0,REFUNDFEE:0,RETAILPRICE:0,DISCOUNTRATE:0,TOTALDISCOUNT:0,ITEMMONEY:0,ITEMTOTALMONEY:0,GROUPID:1,SORTORDER:0,DESCRIPTION:null});n.Invoice.LISTPRODUCT||(n.Invoice.LISTPRODUCT=[]);n.Invoice.LISTPRODUCT.push({PRODUCTNAME:"",QUANTITYUNIT:"Khác",QUANTITY:1,TAXRATE:-1,OTHERTAXFEE:0,REFUNDFEE:0,RETAILPRICE:0,DISCOUNTRATE:0,TOTALDISCOUNT:0,GROUPID:0,SORTORDER:0,DESCRIPTION:null})};n.RemoveRow=function(t){if(t.PRODUCTNAME){var i=function(i){if(!i)return!1;r(function(){n.Invoice.LISTPRODUCT=n.Invoice.LISTPRODUCT.filter(function(n){return n!=t});n.Invoice.LISTPRODUCT.length==0&&n.AddRow()});n.CalMoneyAfterChangeValue()};confirm('Bạn chắc chắn muốn xóa sản phẩm "'+t.PRODUCTNAME+'"?',"Xóa sản phẩm","Không","Có",i)}else r(function(){n.Invoice.LISTPRODUCT=n.Invoice.LISTPRODUCT.filter(function(n){return n!=t});n.Invoice.LISTPRODUCT.length==0&&n.AddRow()}),n.CalMoneyAfterChangeValue()};n.onKeypress=function(t){r(function(){var i=n.Invoice.LISTPRODUCT[t].keyCode;i==38?t>0&&(n.Invoice.LISTPRODUCT.forEach(function(n){n.isFocus=!1}),r(function(){n.Invoice.LISTPRODUCT[t-1].isFocus=!0})):(i==40||i==13)&&n.Invoice.LISTPRODUCT.length-1==t?n.AddRow():(n.Invoice.LISTPRODUCT.forEach(function(n){n.isFocus=!1}),r(function(){n.Invoice.LISTPRODUCT[t+1].isFocus=!0}))})};n.CreateRowDescription=function(n){var t="#Item_p_"+n;$(t).removeClass("ng-hide");$(t).addClass("ng-show")};n.CloseRowDescription=function(n){var t="#Item_p_"+n;$(t).hide()};n.onKeypress=function(t){r(function(){var i=n.Invoice.LISTPRODUCT[t].keyCode;i==38?t>0&&(n.Invoice.LISTPRODUCT.forEach(function(n){n.isFocus=!1}),r(function(){n.Invoice.LISTPRODUCT[t-1].isFocus=!0})):(i==40||i==13)&&n.Invoice.LISTPRODUCT.length-1==t?n.AddRow():(n.Invoice.LISTPRODUCT.forEach(function(n){n.isFocus=!1}),r(function(){n.Invoice.LISTPRODUCT[t+1].isFocus=!0}))})};n.ChangeRetailPrice=function(t){n.DiscountChange(t,!0);var i=t.PRICE;t.PRICE==null||isNaN(parseFloat(t.PRICE))||(i=GetNumber(t.PRICE));t.RETAILPRICE=i;(t.QUANTITY===0||t.QUANTITY==="0"||t.QUANTITY==="")&&t.RETAILPRICE===0?(t.ITEMTOTALMONEY=t.TOTALMONEY,t.ITEMMONEY=t.TOTALMONEY.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")):(t.ITEMTOTALMONEY=t.RETAILPRICE*t.QUANTITY,t.ITEMMONEY=(t.RETAILPRICE*t.QUANTITY).toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),n.CalMoneyAfterChangeValue())};n.ChangeTotalPrice=function(t){n.DiscountChange(t,!0);var i=t.ITEMMONEY;t.ITEMMONEY==null||isNaN(parseFloat(t.ITEMMONEY))||(i=GetNumber(t.ITEMMONEY));t.ITEMTOTALMONEY=i;t.QUANTITY!==0&&t.QUANTITY!=="0"&&t.QUANTITY!==""&&(t.PRICE=(i/t.QUANTITY).toFixed(3).toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),t.RETAILPRICE=i/t.QUANTITY);t.QUANTITY==="0"&&(t.RETAILPRICE=0,t.PRICE=0);t.QUANTITY===""&&(t.RETAILPRICE=null,t.PRICE=null);(t.QUANTITY===0||t.QUANTITY==="0"||t.QUANTITY==="")&&t.RETAILPRICE===0?(n.CalTotalMoney(),n.CalTaxMoney(),n.CalDiscountMoney(),n.CalTotalPayment()):n.CalMoneyAfterChangeValue()};n.QuantityChange=function(t){n.DiscountChange(t,!0);t.QUANTITY=t.QUANTITY.toString().replace(/\,/g,".").replace(/[^0-9.]/g,"");(t.QUANTITY===0||t.QUANTITY==="0"||t.QUANTITY==="")&&t.RETAILPRICE===0?(t.ITEMTOTALMONEY=t.TOTALMONEY,t.ITEMMONEY=t.TOTALMONEY.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")):(t.ITEMTOTALMONEY=t.RETAILPRICE*t.QUANTITY,t.ITEMMONEY=(t.RETAILPRICE*t.QUANTITY).toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),n.CalMoneyAfterChangeValue())};n.DiscountChange=function(t,i){n.Invoice.DISCOUNTTYPE=="CHIET_KHAU_THEO_HANG_HOA"&&(i?t.TOTALDISCOUNT=t.DISCOUNTRATE*t.ITEMTOTALMONEY/100:t.DISCOUNTRATE=t.TOTALDISCOUNT/t.ITEMTOTALMONEY*100,n.CalMoneyAfterChangeValue())};n.SuggestProduct=function(i){if(i){var r=t.selectedResultobj;i.RETAILPRICE=r.PRICE;i.PRODUCTID=r.PRODUCTID;i.PRODUCTNAME=r.PRODUCTNAME;i.QUANTITYUNIT=r.QUANTITYUNIT;i.QUANTITY=i.QUANTITY>0?i.QUANTITY:1;i.TAXRATE=i.TAXRATE>0?i.TAXRATE:0;i.PRICE=r.PRICE.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");i.ITEMMONEY=(i.RETAILPRICE*i.QUANTITY).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");n.CalMoneyAfterChangeValue()}};n.QuantityUnitChange=function(n){var r=[];angular.forEach(t.ListQuantityUnit,function(n){r.push(n.QUANTITYUNIT)});$("#quantityunit").autoComplete({minChars:1,source:function(u,f){var e=JSON.parse(JSON.stringify(r)),o=[];for(i=0;i<e.length;i++)~t.cleanAccents(e[i]).toLowerCase().indexOf(t.cleanAccents(n.QUANTITYUNIT.toLowerCase()))&&o.push(e[i]),f(o)}})};n.CalTotalMoney=function(){if(n.CalDiscountMoney(),n.Invoice.LISTPRODUCT)return n.Invoice.TOTALMONEY=0,n.Invoice.TOTALMONEYRAW=0,n.Invoice.LISTPRODUCT.forEach(function(t){if(!t.ISPROMOTION)if((t.RETAILPRICE===null||t.RETAILPRICE===NaN||t.RETAILPRICE>=0)&&(t.QUANTITY===""||t.QUANTITY==="0"||t.QUANTITY===0))t.ITEMTOTALMONEY===undefined&&(t.ITEMTOTALMONEY=t.TOTALMONEY),n.Invoice.TOTALMONEYRAW+=t.ITEMTOTALMONEY,n.Invoice.TOTALMONEY+=t.ITEMTOTALMONEY*parseInt(n.Invoice.EXCHANGERATE.toString().replace(/\,/g,""));else{let i=t.QUANTITY*t.RETAILPRICE;n.Invoice.TOTALMONEYRAW+=i;n.Invoice.TOTALMONEY+=i*parseInt(n.Invoice.EXCHANGERATE.toString().replace(/\,/g,""))}}),n.Invoice.TOTALMONEY=n.Invoice.TOTALMONEY-n.Invoice.DISCOUNTMONEY,n.Invoice.TOTALMONEYRAW=n.Invoice.TOTALMONEYRAW-n.Invoice.DISCOUNTMONEYRAW,n.Invoice.TOTALMONEY=(n.Invoice.CURRENCY!=="VND"?n.Invoice.TOTALMONEYRAW.formatMoneyNumberPlace(2):n.Invoice.TOTALMONEYRAW)*parseInt(n.Invoice.EXCHANGERATE.toString().replace(/\,/g,"")),n.Invoice.TOTALMONEY};n.CalTaxMoney=function(){if(n.Invoice.LISTPRODUCT)return n.Invoice.TAXWATERMONEY=0,n.Invoice.TAXMONEY=0,n.Invoice.TAXMONEYRAW=0,n.TAXRATE==1?(n.Invoice.TAXMONEY=n.Invoice.TOTALMONEY*(n.GLOBALTAXRATE==-1?0:n.GLOBALTAXRATE)/100,n.Invoice.TAXMONEYRAW=n.Invoice.TOTALMONEYRAW*(n.GLOBALTAXRATE==-1?0:n.GLOBALTAXRATE)/100):n.Invoice.LISTPRODUCT.forEach(function(t){var i=0,u=0,r=0,f=0;(t.RETAILPRICE===null||t.RETAILPRICE===NaN||t.RETAILPRICE>=0)&&(t.QUANTITY===""||t.QUANTITY==="0"||t.QUANTITY===0)?(t.ITEMTOTALMONEY===undefined&&(t.ITEMTOTALMONEY=t.TOTALMONEY),i=t.ITEMTOTALMONEY*parseInt(n.Invoice.EXCHANGERATE.toString().replace(/\,/g,"")),u=t.DISCOUNTRATE*i/100,r=t.ITEMTOTALMONEY,f=t.DISCOUNTRATE*r/100):(i=t.QUANTITY*t.RETAILPRICE*parseInt(n.Invoice.EXCHANGERATE.toString().replace(/\,/g,"")),u=t.DISCOUNTRATE*i/100,r=t.QUANTITY*t.RETAILPRICE,f=t.DISCOUNTRATE*r/100);t.ISPROMOTION||(n.Invoice.TAXMONEY+=(i-u)*(t.TAXRATE==-1?0:t.TAXRATE)/100,n.Invoice.TAXMONEYRAW+=(r-f)*(t.TAXRATE==-1?0:t.TAXRATE)/100)}),t.Enterprise.USINGINVOICETYPE===4&&(n.Invoice.TAXWATERMONEY+=n.Invoice.TOTALMONEY*n.GLOBALTAXRATEWATER/100,n.Invoice.TAXWATERMONEYRAW+=n.Invoice.TOTALMONEY*(n.GLOBALTAXRATEWATER/100)),n.Invoice.TAXMONEY=(n.Invoice.CURRENCY!=="VND"?n.Invoice.TAXMONEYRAW.formatMoneyNumberPlace(2):n.Invoice.TAXMONEYRAW)*parseInt(n.Invoice.EXCHANGERATE.toString().replace(/\,/g,"")),n.Invoice.TAXMONEY};n.CalOtherTaxFeeMoney=function(){if(n.Invoice.LISTPRODUCT)return n.Invoice.OTHERTAXFEE=0,n.Invoice.LISTPRODUCT.forEach(function(t){t.ISPROMOTION||((t.RETAILPRICE===null||t.RETAILPRICE===NaN||t.RETAILPRICE>=0)&&(t.QUANTITY===""||t.QUANTITY==="0"||t.QUANTITY===0)?(t.OTHERTAXFEE===""&&(t.OTHERTAXFEE=0),n.Invoice.OTHERTAXFEE+=parseFloat(t.OTHERTAXFEE.toString().replace(/\,/g,""))):(t.OTHERTAXFEE===""&&(t.OTHERTAXFEE=0),n.Invoice.OTHERTAXFEE+=parseFloat(t.OTHERTAXFEE.toString().replace(/\,/g,""))))}),n.Invoice.OTHERTAXFEE};n.CalRefundFee=function(){if(n.Invoice.LISTPRODUCT)return n.Invoice.REFUNDFEE=0,n.Invoice.LISTPRODUCT.forEach(function(t){t.ISPROMOTION||((t.RETAILPRICE===null||t.RETAILPRICE===NaN||t.RETAILPRICE>=0)&&(t.QUANTITY===""||t.QUANTITY==="0"||t.QUANTITY===0)?(t.REFUNDFEE===""&&(t.REFUNDFEE=0),n.Invoice.REFUNDFEE+=parseFloat(t.REFUNDFEE.toString().replace(/\,/g,""))):(t.REFUNDFEE===""&&(t.REFUNDFEE=0),n.Invoice.REFUNDFEE+=parseFloat(t.REFUNDFEE.toString().replace(/\,/g,""))))}),n.Invoice.REFUNDFEE};n.CalDiscountMoney=function(){if(n.Invoice.LISTPRODUCT)return n.Invoice.DISCOUNTMONEY=0,n.Invoice.DISCOUNTMONEYRAW=0,n.Invoice.LISTPRODUCT.forEach(function(t){if(!t.ISPROMOTION)if((t.RETAILPRICE===null||t.RETAILPRICE===NaN||t.RETAILPRICE>=0)&&(t.QUANTITY===""||t.QUANTITY==="0"||t.QUANTITY===0))t.ITEMTOTALMONEY===undefined&&(t.ITEMTOTALMONEY=t.TOTALMONEY),n.Invoice.DISCOUNTMONEY+=t.DISCOUNTRATE*t.ITEMTOTALMONEY*parseInt(n.Invoice.EXCHANGERATE.toString().replace(/\,/g,""))/100,n.Invoice.DISCOUNTMONEYRAW+=t.DISCOUNTRATE*t.ITEMTOTALMONEY/100;else{let i=t.QUANTITY*t.RETAILPRICE;n.Invoice.DISCOUNTMONEY+=t.DISCOUNTRATE*i*parseInt(n.Invoice.EXCHANGERATE.toString().replace(/\,/g,""))/100;n.Invoice.DISCOUNTMONEYRAW+=t.DISCOUNTRATE*i/100}}),n.Invoice.DISCOUNTMONEY=(n.Invoice.CURRENCY!=="VND"?n.Invoice.DISCOUNTMONEYRAW.formatMoneyNumberPlace(2):n.Invoice.DISCOUNTMONEYRAW)*parseInt(n.Invoice.EXCHANGERATE.toString().replace(/\,/g,"")),n.Invoice.DISCOUNTMONEY};n.CalServiceFeeTax=function(){return n.Invoice.SERVICEFEETAX=n.Invoice.SERVICEFEETAXRATE===0||n.Invoice.SERVICEFEETAXRATE===-1?0:n.Invoice.SERVICEFEE*n.Invoice.SERVICEFEETAXRATE/100,n.CalTotalServiceFee(),n.Invoice.SERVICEFEETAX};n.CalTotalServiceFee=function(){return n.Invoice.TOTALSERVICEFEE=parseFloat(n.Invoice.SERVICEFEE)+parseFloat(n.Invoice.SERVICEFEETAX),n.CalMoneyAfterChangeValue(),n.Invoice.TOTALSERVICEFEE};n.CalTotalPayment=function(){if(n.Invoice.LISTPRODUCT)return n.Invoice.TOTALMONEY||(n.Invoice.TOTALMONEY=0),n.Invoice.DISCOUNTMONEY||(n.Invoice.DISCOUNTMONEY=0),n.Invoice.TAXMONEY||(n.Invoice.TAXMONEY=0),n.Invoice.TAXWATERMONEY||(n.Invoice.TAXWATERMONEY=0),n.Invoice.OTHERTAXFEE||(n.Invoice.OTHERTAXFEE=0),n.Invoice.REFUNDFEE||(n.Invoice.REFUNDFEE=0),n.Invoice.TOTALSERVICEFEE||(n.Invoice.TOTALSERVICEFEE=0),t.Enterprise.USINGINVOICETYPE===AccountObjectType.HOADONBANHANG?(n.Invoice.TOTALPAYMENT=n.Invoice.TOTALMONEY,n.Invoice.TOTALPAYMENTRAW=n.Invoice.TOTALMONEYRAW):t.Enterprise.USINGINVOICETYPE===4?(n.Invoice.TOTALPAYMENT=n.Invoice.TOTALMONEY+n.Invoice.TAXWATERMONEY+n.Invoice.TAXMONEY,n.Invoice.TOTALPAYMENTRAW=n.Invoice.TOTALMONEY+n.Invoice.TAXWATERMONEY+n.Invoice.TAXMONEY):(n.Invoice.TOTALPAYMENT=n.Invoice.TOTALMONEY+n.Invoice.TAXMONEY,n.Invoice.TOTALPAYMENTRAW=n.Invoice.TOTALMONEYRAW+n.Invoice.TAXMONEYRAW),n.Invoice.TOTALPAYMENT=n.Invoice.TOTALPAYMENT+n.Invoice.OTHERTAXFEE-n.Invoice.REFUNDFEE+n.Invoice.TOTALSERVICEFEE,n.Invoice.TOTALPAYMENTRAW=n.Invoice.TOTALPAYMENTRAW+n.Invoice.OTHERTAXFEE-n.Invoice.REFUNDFEE+n.Invoice.TOTALSERVICEFEE,n.Invoice.TOTALPAYMENT};n.CalMoneyAfterChangeValue=function(){n.TAXRATE==1&&(n.GLOBALTAXRATE=parseInt($("#idOnlyTaxRate").val()));t.Enterprise.USINGINVOICETYPE===4&&(n.GLOBALTAXRATEWATER=parseInt($("#txtTaxwater").val()));r(function(){n.ChangeDiscountType();n.CalDiscountMoney();n.CalTotalMoney();n.CalTaxMoney();n.CalOtherTaxFeeMoney();n.CalRefundFee();n.CalTotalPayment();n.CalExChangeStr();n.ReadNumberToCurrencyWords()},100)};n.CalExChangeStr=function(){var t=n.Invoice.TOTALPAYMENT/n.Invoice.EXCHANGERATE;n.Invoice.CUSTOMFIELDEXCHANGE=t.formatMoney(2,".",",")};n.ReadNumberToCurrencyWords=function(){var i=0,r,u;i=n.Invoice.TOTALPAYMENTRAW&&n.Invoice.TOTALPAYMENTRAW.toString()!="NaN"?n.Invoice.TOTALPAYMENTRAW:n.Invoice.TOTALPAYMENT;r=h+"ReadNumberToWords";u=JSON.stringify({currency:n.Invoice.CURRENCY,number:i,numberPlace:t.Enterprise.MONEYPLACE});f.PostDataAjax(r,u,function(t){t?t.rs?n.NumberToCurrencyWords=t.data:n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - ReadNumberToCurrencyWords")})};n.SuggestCustomer=function(){var i=t.selectedCustomer;i&&(n.Invoice.CUSID=i.CUSID,n.Invoice.CUSNAME=i.CUSNAME,n.Invoice.CUSADDRESS=i.CUSADDRESS,n.Invoice.CUSTAXCODE=i.CUSTAXCODE,n.Invoice.CUSEMAIL=i.CUSEMAIL,n.Invoice.CUSPHONENUMBER=i.CUSPHONENUMBER,n.Invoice.CUSBUYER=i.CUSBUYER,n.Invoice.CUSTOMERCODE=i.CUSID,n.Invoice.CUSACCOUNTNUMBER=i.CUSACCOUNTNUMBER,n.GetMeterByCustaxcode(i.CUSID))};n.GetInvoice=function(){LoadingShow();var t=h+"GetInvoice",i=JSON.stringify({});LoadingShow();f.PostDataAjax(t,i,function(t){t?t.rs?n.ListInvoice=t.result:n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetInvoice");LoadingHide()})};n.GetInvoiceById=function(t){var i=h+"GetInvoiceById",r=JSON.stringify({id:t});f.PostDataAjax(i,r,function(t){t?t.rs?n.RefInvoice=t.result:n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetInvoiceById")})};n.SelectAll=function(){var t=n.ListInvoice.filter(function(t){return t.ISSELECTED==n.IsSelectAll});t.length>0&&t.forEach(function(t){t.ISSELECTED=!n.IsSelectAll})};n.SeleteRow=function(t){var i=n.ListInvoice.filter(function(n){return n.ISSELECTED==!0});t?n.IsSelectAll=!1:i.length==n.ListInvoice.length-1&&(n.IsSelectAll=!0)};n.LoadInfoByTaxcode2=function(){if(!n.Invoice.CUSTAXCODE)return alert("Bạn cần nhập MST"),!1;if(LoadingShow(),n.Invoice.CUSTAXCODE&&n.Invoice.CUSTAXCODE!=""){var t="https://app.meinvoice.vn/other/getcompanyinfobytaxcode?taxcode="+n.Invoice.CUSTAXCODE;$("#tempLoadTaxinfo").load(t,function(t){r(function(){var r=JSON.parse(t),i={};r.Data!=""&&(i=JSON.parse(r.Data));i.companyName?(n.Invoice.CUSADDRESS=i.address,n.Invoice.CUSNAME=i.companyName):(toastr.warning("Không tìm thấy thông tin doanh nghiệp. Xin vui lòng kiểm tra lại mã số thuế nhập vào."),n.Invoice.CUSNAME=null,n.Invoice.CUSADDRESS=null);LoadingHide()},2e3)})}};n.LoadInfoByTaxcode=function(){n.LoadInfoByTaxcode2()};n.LoadCurrencyExchangeRate=function(){var t=h+"LoadCurrency",i=JSON.stringify({});f.PostDataAjax(t,i,function(t){if(t){var i=[];i=t.items===undefined?[]:t.items;i.push({type:"VND",imageurl:"",muatienmat:1,muack:1,bantienmat:1,banck:1});i=i.filter(function(n){return n.type!="XAU"}).filter(function(n){return n.type!="PNJ_DAB"});i.forEach(function(n){n.type=="JPY"&&(n.bantienmat=n.bantienmat.split(".")[0])});n.CurrencyList=i}else alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - LoadCurrencyExchangeRate")})};n.ChangeCurrencyType=function(t){var i=n.CurrencyList.filter(function(n){return n.type===t});n.Invoice.EXCHANGERATE=i[0].bantienmat.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");n.CalMoneyAfterChangeValue()};$(".dropdown-menu").find("form").click(function(n){n.stopPropagation()});n.DiscountType=[{value:"KHONG_CO_CHIET_KHAU",name:"Không có chiết khấu"},{value:"CHIET_KHAU_THEO_HANG_HOA",name:"Chiết khấu theo hàng hóa"}];n.TaxRateList=[{value:-1,name:"Không chịu thuế"},{value:0,name:"0%"},{value:5,name:"5%"},{value:10,name:"10%"}];n.Hoa_Don_Ban_Hang_TaxRateList=[{value:-1,name:"Hàng hóa, dịch vụ không chịu thuế GTGT hoặc thuế GTGT 0%"},{value:1,name:"Phân phối, cung cấp hàng hoá (1%)"},{value:5,name:"Dịch vụ, xây dựng không bao thầu nguyên vật liệu (5%)"},{value:3,name:"Sản xuất, vận tải, dịch vụ có gắn với hàng hoá, xây dựng có bao thầu nguyên vật liệu (3%)"},{value:2,name:"Hoạt động kinh doanh khác (2%)"}];n.ViewTaxcode=function(n){if(n){var t=new RegExp(/\d/,"gi"),i=new RegExp(/\S/,"gi");return n=n.replace(i,function(n){return n.match(t)?'<span class="taxcode-symbol">'+n+"<\/span>":'<span class="taxcode-space">'+n+"<\/span>"}),u.trustAsHtml(n)}};n.ChangeDiscountType=function(){n.Invoice.DISCOUNTTYPE=="KHONG_CO_CHIET_KHAU"&&n.Invoice.LISTPRODUCT.forEach(function(n){n.DISCOUNTRATE=0})};n.ModalInvoiceNote=function(){$("#modal_invoice_note").dialog({modal:!0,width:"35%"});n.Invoice.ID==0&&(n.Invoice.NOTE="")};n.GetNumber=function(){n.FormNumber={};n.FormNumber.FORMCODE=n.Number.FORMCODE;n.FormNumber.SYMBOLCODE=n.Number.SYMBOLCODE;var t=h+"GetNumber",i=JSON.stringify({form:n.FormNumber});LoadingShow();f.PostDataAjax(t,i,function(t){if(t)if(t.rs){let i=t.result[0];n.Number.CURRENTNUMBER=i.CURRENTNUMBER;n.Number.FROMNUMBER=i.CURRENTNUMBER+1}else n.ErrorMessage=t.msg;else alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetNumberaa");LoadingHide()})};n.ExchangeRateFormat=function(){$("#exchangeRateInput").on("keyup",function(){if($(this).val()!="NaN"){var n=parseInt($(this).val().replace(/\D/g,""),10);$(this).val(n.toLocaleString().replace(".",","))}else $(this).val(1)})};n.FormCodeChange=function(i){t.ListFormCode=n.TempListFormCode;r(function(){if(t.ListFormCode!==undefined){let r=i.split("-"),u=t.ListFormCode.filter(function(n){return n.FORMCODE===r[0]&&n.SYMBOLCODE===r[1]});n.GLOBALTAXRATE=0;n.TAXRATE=u[0].TAXRATE;n.ONLYTAXRATE=n.TaxRateList[0].value}},100)};n.ChangeInvoiceMethod=function(){var n=$("#product-container");n.attr("style","pointer-events:auto;")};c=new Date;n.CurrentDay=c.getDate();n.CurrentMonth=c.getMonth()+1;n.CurrentYear=c.getFullYear();n.CurrentDate=c.getDate()+"/"+(c.getMonth()+1)+"/"+c.getFullYear();n.GetMeterByCustaxcode=function(t){if(t!==undefined){LoadingShow();var i=JSON.stringify({custaxcode:t});f.PostDataAjax("/Meter/GetMeterListByCustaxcode",i,function(t){t?t.rs?n.MeterList=t.msg:n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetMeterByCustaxcode")});LoadingHide()}};n.GetMeterByInvoiceId=function(i){var r=JSON.stringify({invoiceid:i});f.PostDataAjax("/Meter/GetListMeterCodeByInvoiceID",r,function(i){i?i.rs&&i.msg.length>0?(n.MeterList=i.msg,setSelectedValueDropdown(t.Enterprise.USINGINVOICETYPE,n.MeterList[0].METERCODE)):n.ErrorMessage=i.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetMeterByInvoiceId")})};n.ChooseMeter=function(){var t=JSON.stringify({meterCode:n.Invoice.METER.CODE,custaxcode:n.Invoice.CUSID});f.PostDataAjax("/Product/GetProductListByMeterCode",t,function(t){if(t)if(t.rs)for(var i=0;i<t.msg.length;i++)n.AddDataRow(t.msg[i]);else n.ErrorMessage=t.msg;else alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - AddDataRow")})};n.AddDataRow=function(t){t.PRICE=t.PRICE===undefined?0:t.PRICE;t.RETAILPRICE=t.RETAILPRICE===undefined?0:t.RETAILPRICE;t.ITEMMONEY=t.ITEMMONEY===undefined?0:t.ITEMMONEY;t.QUANTITY=t.QUANTITY===undefined?0:t.QUANTITY;t.OLDNO=t.OLDNO===undefined?0:t.OLDNO;t.NEWNO=t.NEWNO===undefined?0:t.NEWNO;t.FACTOR=t.FACTOR===undefined?0:t.FACTOR;var i={METERCODE:t.METERCODE,PRODUCTNAME:t.PRODUCTNAME,OLDNO:t.OLDNO,NEWNO:t.NEWNO,FACTOR:t.FACTOR,QUANTITY:1,TAXRATE:-1,RETAILPRICE:t.PRICE,METERNAME:t.METERNAME};n.Invoice.LISTPRODUCT||(n.Invoice.LISTPRODUCT=[]);n.Invoice.LISTPRODUCT.push(i)};n.ElectricInvoiceQuantityChange=function(t){t.OLDNO=t.OLDNO.toString().replace(/\,/g,".").replace(/[^0-9.]/g,"");t.NEWNO=t.NEWNO.toString().replace(/\,/g,".").replace(/[^0-9.]/g,"");var i=(t.NEWNO-t.OLDNO)*t.FACTOR;t.QUANTITY=i.toString().replace(/\,/g,".").replace(/[^0-9.]/g,"");t.ITEMMONEY=(t.RETAILPRICE*t.QUANTITY).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");n.CalMoneyAfterChangeValue()};n.SetDatepikerDate=function(){var r=n.Invoice.TODATE,t,i;n.Invoice.TODATESTR=r;t=n.Invoice.FROMDATE;n.Invoice.FROMDATESTR=t;i=n.Invoice.DELIVERYORDERDATE;n.Invoice.DELIVERYORDERDATESTR=i}}]);$(".modal-invoice").on("hidden.bs.modal",function(){alert("logs")});app.controller("ModalProductController",["$scope","$rootScope","$timeout","CommonFactory",function(n,t,r,u){var f="/Product/";t.ModalProduct=function(i,u){t.Enterprise||t.GetEnterpriseInfo();r(function(){t.GetCategory();t.GetQuantityUnit()},200);n.TYPECHANGE=u;n.Product={};u==1?(n.Product={},typeof i=="string"&&(n.Product.PRODUCTNAME=i)):u==2?(angular.copy(i,n.Product),n.Product.STRPRICE=n.Product.PRICE):u==3&&(angular.copy(i,n.Product),n.Product.ID=0)};n.ChangeRetailPrice=function(n){var t=n.STRPRICE;n.STRPRICE==null||isNaN(parseFloat(n.STRPRICE))||(t=GetNumber(n.STRPRICE));n.PRICE=t};n.uploadFile=function(t){var u,i,e,f;for(LoadingShow(),u=t.target.files,i=0;i<u.length;i++)e=u[i],f=new FileReader,f.onload=function(t){r(function(){n.Product.IMAGE=t.target.result;LoadingHide()},100)},f.readAsDataURL(e)};n.AddProduct=function(){if(!n.Product.PRODUCTTYPE)return alert("Vui lòng chọn kiểu sản phẩm"),!1;if(!n.Product.PRODUCTNAME)return alert("Vui lòng nhập vào tên sản phẩm"),!1;n.IsLoading=!0;var i=f+"AddProduct",r=JSON.stringify({product:n.Product});LoadingShow();u.PostDataAjax(i,r,function(i){i?i.rs?(toastr.options={timeOut:"2000"},toastr.success("Thêm mới thành công!"),$(".modal-product").modal("hide"),t.ReloadProduct(1)):n.ErrorMessage=i.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - AddProduct");LoadingHide()})};n.UpdateProduct=function(){if(!n.Product.PRODUCTTYPE)return alert("Vui lòng chọn kiểu sản phẩm"),$("div#productType").focus(),!1;if(!n.Product.PRODUCTNAME)return alert("Vui lòng nhập vào tên sản phẩm"),$("div#idProductName").focus(),!1;var i=f+"UpdateProduct",r=JSON.stringify({product:n.Product});LoadingShow();u.PostDataAjax(i,r,function(i){i?i.rs?(toastr.options={timeOut:"2000"},toastr.success("Cập nhật thành công!"),$(".modal-product").modal("hide"),t.ReloadProduct()):n.ErrorMessage=i.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - UpdateProduct");LoadingHide()})};n.QuantityUnitChange=function(n){var r=[];angular.forEach(t.ListQuantityUnit,function(n){r.push(n.QUANTITYUNIT)});$("#quantityunitproduct").autoComplete({minChars:1,source:function(u,f){var e=JSON.parse(JSON.stringify(r)),o=[];for(o.length=0,i=0;i<e.length;i++)~t.cleanAccents(e[i]).toLowerCase().indexOf(t.cleanAccents(n.toLowerCase()))&&o.push(e[i]),f(o)}})}}]);app.controller("ModalCategoryController",["$scope","$rootScope","$timeout","CommonFactory",function(n,t,i,r){var u="/Category/";n.category={};t.ModalCategory=function(t){angular.copy(t,n.category);t===""&&(n.category.ISACTIVE=!0)};n.SaveCategory=function(){if(!n.category.CATEGORY){alert("Vui lòng nhập tên dịch vụ");return}if(n.category.CATEGORY.length>=512)return toastr.warning("Tên danh mục độ dài không quá 512 ký tự"),!1;var i=u+"SaveCategory",f=JSON.stringify({category:n.category});r.PostDataAjax(i,f,function(n){n?n.rs?(toastr.success("Cập nhật thành công"),$(".modal-category").modal("hide"),t.ReloadCategory(1),t.GetCategory()):toastr.warning(n.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SaveCategory")})};t.UpdateCategory=function(n){var f,e;let i="";if(n.COMTAXCODE=="1")return toastr.warning("Bạn không được phép thay đổi trạng thái này"),!1;f=u+"SaveCategory";n.ISACTIVE==!0?(n.ISACTIVE=!1,i="Ngừng kích hoạt thành công"):(n.ISACTIVE=!0,i="Kích hoạt thành công");e=JSON.stringify({category:n});r.PostDataAjax(f,e,function(n){n?n.rs?(toastr.success(i),t.ReloadCategory(1),t.GetCategory()):toastr.warning(n.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SaveCategory")})}}]);app.controller("ModalCustomerController",["$scope","$rootScope","$timeout","CommonFactory",function(n,t,i,r){var u="/Customer/";t.ModalCustomer=function(i,r){t.Enterprise||t.GetEnterpriseInfo();t.GetPaymentMethod();t.GetCurrencyUnit();n.TYPECHANGE=r;n.selectedValues=[];n.Customer={};r==1?(n.Customer={},n.Customer.CUSPAYMENTMETHOD="TM/CK",n.Customer.CUSCURRENCYUNIT="VNĐ (Việt Nam Đồng)"):r==2?(angular.copy(i,n.Customer),t.Enterprise.USINGINVOICETYPE===2&&(n.Customer.METERCODE&&(n.selectedValues=n.Customer.METERCODE.split(",")),n.GetListMeters())):r==3&&(angular.copy(i,n.Customer),n.Customer.ID=0,t.Enterprise.USINGINVOICETYPE===2&&(n.Customer.METERCODE&&(n.selectedValues=n.Customer.METERCODE.split(",")),n.GetListMeters()));n.Customer.CUSTOMERTYPE=n.Customer.COMTAXCODE!==null||n.Customer.COMTAXCODE!==""?1:2;n.Customer.CUSTOMERTYPE===1?($("#comtaxt-code-required").html("(*)"),$("#ctr-address-required").html("(*)"),$("input:radio[name=DefaultCustomer]").prop("checked",!1),$("input:radio[name=DefaultPersional]").prop("checked",!0)):($("input:radio[name=DefaultCustomer]").prop("checked",!0),$("input:radio[name=DefaultPersional]").prop("checked",!1),$("#comtaxt-code-required").html(""),$("#ctr-address-required").html(""));t.Customercode=n.Customer.CUSTAXCODE};n.SetRequiedTaxCode=function(t){n.Customer.CUSTOMERTYPE=t;t===1?($("#comtaxt-code-required").html("(*)"),$("#ctr-address-required").html("(*)"),$("input:radio[name=DefaultCustomer]").prop("checked",!1),$("input:radio[name=DefaultPersional]").prop("checked",!0)):($("input:radio[name=DefaultCustomer]").prop("checked",!0),$("input:radio[name=DefaultPersional]").prop("checked",!1),$("#comtaxt-code-required").html(""),$("#ctr-address-required").html(""))};n.AddCustomer=function(){var i,f;if(t.Enterprise.USINGINVOICETYPE===1){if(!n.Customer.CUSTAXCODE)return alert("Vui lòng nhập vào nhóm khách hàng"),!1;if(!n.Customer.CUSID)return alert("Vui lòng nhập vào mã khách hàng"),!1;if(!n.Customer.CUSNAME)return alert("Vui lòng nhập vào tên khách hàng"),!1;if(!n.Customer.CUSADDRESS)return alert("Vui lòng nhập vào địa chỉ"),!1}else{if(n.Customer.CUSTOMERTYPE==1&&!n.Customer.CUSTAXCODE)return alert("Vui lòng nhập vào mã số thuế doanh nghiệp"),!1;if(!n.Customer.CUSNAME)return alert("Vui lòng nhập vào tên khách hàng"),!1;if(!n.Customer.CUSADDRESS)return alert("Vui lòng nhập vào địa chỉ"),!1;if(!n.Customer.CUSPAYMENTMETHOD)return alert("Vui lòng chọn hình thức thanh toán"),!1}i=u+"AddCustomer";n.Customer.METERCODE=n.selectedValues.join(",");f=JSON.stringify({customer:n.Customer});LoadingShow();r.PostDataAjax(i,f,function(i){i?i.rs?(toastr.options={timeOut:"4000"},toastr.success("Thêm mới thành công!"),$(".modal-customer").modal("hide"),t.ReloadCustomer()):(n.ErrorMessage=i.msg,alert(i.msg)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - AddCustomer");LoadingHide()})};n.UpdateCustomer=function(){var i,f;if(!n.Customer.CUSNAME)return alert("Vui lòng nhập vào tên khách hàng"),!1;if(n.Customer.CUSTOMERTYPE==1&&!n.Customer.CUSTAXCODE)return alert("Vui lòng nhập vào mã số thuế doanh nghiệp"),!1;if(n.Customer.CUSTOMERTYPE==1&&!n.Customer.CUSBUYER)return alert("Vui lòng nhập vào tên người mua hàng"),!1;if(!n.Customer.CUSADDRESS)return alert("Vui lòng nhập vào địa chỉ"),!1;if(!n.Customer.CUSPAYMENTMETHOD)return alert("Vui lòng chọn hình thức thanh toán"),!1;i=u+"UpdateCustomer";n.Customer.METERCODE=n.selectedValues.join(",");f=JSON.stringify({customer:n.Customer});LoadingShow();r.PostDataAjax(i,f,function(i){i?i.rs?(toastr.options={timeOut:"4000"},toastr.success("Cập nhật thành công!"),$(".modal-customer").modal("hide"),t.ReloadCustomer()):(n.ErrorMessage=i.msg,alert(i.msg)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - UpdateCustomer");LoadingHide()})};n.GetListMeters=function(){if(!n.Customer.CUSTAXCODE)return alert("Bạn cần nhập MST của khách hàng."),n.ListMeters=[],!1;n.IsLoading=!0;var t=JSON.stringify({custaxcode:n.Customer.CUSTAXCODE});r.PostDataAjax("/Meter/GetMeterListByCustaxcode",t,function(t){t?t.rs?($(".selectpicker").selectpicker({}),n.ListMeters=t.msg,i(function(){$(".selectpicker").selectpicker("refresh")},1e3)):n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetCurrencyUnit")});n.IsLoading=!1};n.FillCustomerCode=function(n){t.Customercode=n};n.LoadInfoByTaxcode=function(){if(n.Customer.CUSTAXCODE==null&&toastr.warning("vui lòng nhập mã số thuế của khách hàng"),n.Customer.CUSTAXCODE!=n.oldTaxcode&&n.Customer.CUSTAXCODE!=null&&n.Customer.CUSTAXCODE!=""){var t="https://app.meinvoice.vn/Other/GetCompanyInfoByTaxCode?taxCode="+n.Customer.CUSTAXCODE;$("#tempLoadTaxinfo").load(t,function(t){LoadingShow();var u=JSON.parse(t),r={};u.Data!=""&&(r=JSON.parse(u.Data));i(function(){r.companyName?(n.Customer.CUSID=r.companyId,n.Customer.CUSADDRESS=r.address,n.Customer.CUSNAME=r.companyName.toUpperCase()):(alert("Không tìm thấy thông tin doanh nghiệp. Xin vui lòng kiểm tra lại mã số thuế nhập vào."),n.Customer.CUSNAME=null,n.Customer.CUSADDRESS=null);LoadingHide()},1e3)})}else n.Customer.CUSTAXCODE!=n.oldTaxcode&&(n.Customer.CUSNAME=null,n.Customer.CUSADDRESS=null)}}]);app.controller("ModalImportInvoiceController",["$scope","$rootScope","$timeout","CommonFactory",function(n,t,i,r){var u="/Invoice/";t.Enterprise||t.GetEnterpriseInfo();angular.element(function(){n.Import={};n.Import.ImportInvoiceType=0;n.ListMap={};n.Import.HeaderRow=1;n.Import.ShowSelectSheetAndHeader=!1});n.listColumnError=[];n.ResetAllStep=function(){n.stepOne=!0;n.stepTwo=!1;n.stepThree=!1;n.ListData=null;n.IsDiffent=!0};n.ImportBackToStep=function(t){n.stepOne=!1;n.stepTwo=!1;n.stepThree=!1;switch(t){case 1:n.stepOne=!0;break;case 2:n.stepTwo=!0}};n.ModalImportInvoice=function(){};n.revmoveItem=function(t){var i=t;$(n.ListData).each(function(n,t){t.YOURFIELD===i&&(t.YOURFIELD=null)});n.ListData=n.ListData};n.changeDataMapping=function(){n.listColumnError=[]};n.ToggleShowMore=function(n){$(n).fadeToggle(300)};n.ImportInvoiceFromExcel=function(){$("#fileUploadInvoice").trigger("click")};$("#frmImportInvoice").fileupload({autoUpload:!1,add:function(r,f){var o,e,s;if(!f.files[0].type.match("image.*")){if(o=CheckFile(f.files),!o)return!1;LoadingShow();e=new FormData;e.append("file0",f.files[0]);s=u+"ReadFileExcel";$.ajax({type:"POST",url:s,contentType:!1,processData:!1,data:e,success:function(r){i(function(){if(r.rs){n.Import.FileName=r.fileName;n.Import.ListSheets=JSON.parse(r.listSheet);n.Import.SelectedSheet=[n.Import.ListSheets[0]];var i=$("#ddlSheet");i.attr("value",n.Import.SelectedSheet.Index);n.Import.FORMCODE=t.ListFormCode[0].FORMCODE+"-"+t.ListFormCode[0].SYMBOLCODE;n.Import.SYMBOLCODE=t.ListFormCode[0].SYMBOLCODE;n.Import.UploadMessage=r.reponseText;n.Import.ShowSelectSheetAndHeader=!0}else alert(r.msg);LoadingHide()})},error:function(){alert("Lỗi không thể đọc file excel.");LoadingHide()}})}}});n.ImportExcelMappingData=function(){if(n.listColumnError=[],!n.Import.FORMCODE)return alert("Bạn chưa chọn mẫu số."),!1;if(!n.Import.SYMBOLCODE)return alert("Bạn chưa chọn ký hiệu."),!1;if(!n.Import.FileName)return alert("Bạn chưa chọn file."),!1;if(!n.Import.SelectedSheet)return alert("Bạn chưa chọn sheet dữ liệu."),!1;if(!n.Import.HeaderRow)return alert("Bạn chưa chọn thứ tự dòng tiêu đề."),!1;var t=n.Import.FORMCODE.split("-"),f=u+"MappingColumnExcel",e=JSON.stringify({fromCode:t[0],symbolCode:t[1],selectedSheet:$("#ddlSheet").val(),headerRow:n.Import.HeaderRow});LoadingShow();r.PostDataAjax(f,e,function(t){t?t.rs?(n.ListData=t.data,i(function(){$(".selectpicker").selectpicker("refresh")},100),n.stepOne=!1,n.stepTwo=!0,n.ClientData=t.clientData,n.lstYourField=t.lstYourField):(n.ErrorMessage=t.msg,alert(t.msg)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - ImportExcelMappingData");LoadingHide()})};n.ImportExcelPreviewData=function(){var f=JSON.stringify(n.ListMap),t=n.ListData.filter(function(n){return n.YOURFIELD===null&&n.Required===!0});if(t&&Object.keys(t).length>0&&$(t).each(function(t,i){n.ListMap[i.MYFIELD]||n.listColumnError.push(i.MYFIELD)}),n.listColumnError.length>0)return!1;var r=n.Import.FORMCODE.split("-"),o=JSON.stringify(n.ClientData),e=u+"PreviewInvoiceData";successCallback=function(t){n.ImportInvoices=t.ListInvoices;n.TotalInvoiceMoneyPayment=t.TotalInvoiceMoney;i(function(){n.stepThree=!0;n.stepTwo=!1},100)};AjaxRequest(e,{listMap:f,formCode:r[0],symbolCode:r[1]},"POST",!0,"json",successCallback)};n.SaveInvoiceList=function(){n.ImportInvoices||alert("Bạn chưa tải file lên. Vui lòng tải chọn file tải lên.");n.EnableButton(!1);action=u+"ImportDataInvoice";successCallback=function(){$(".import-invoice").modal("hide");n.ResetAllStep()};AjaxRequest(action,{},"POST",!0,"json",successCallback)};n.EnableButton=function(n){$("#modalFooterInv").find("button").each(function(){$(this).prop("disabled",!n)})};n.BackroundJodSinglR=function(){var r=$.connection.signlRConf,u=sessionStorage.getItem("userNameSS"),i;$.connection.hub.qs={username:u};i=0;r.client.newMessageReceived=function(r){var u,f,e;i=i+1;console.log(i);i===r.totalRow?(u="Thêm mới thành công <b>"+i+"/"+r.totalRow+"<\/b> hóa đơn.",$(".invoiceResult").html("Hoàn Thành"),$("#progressTab").hide(),toastr.success(u),n.EnableButton(!0),i=0,f=function(i){if(i)return n.ActionAfterImport(),!1;n.ActionAfterImport();t.ReloadInvoice()},confirm(u+"<br> Bạn có muốn làm mới dữ liệu không?","Thêm mới hóa đơn","Có","Không",f)):($("#progressTab").show(),e=Math.floor(i/r.totalRow*100),$(".invoiceResult").html("Đang tải hóa đơn: "+e+"%"))}};n.BackroundJodSinglR();n.ActionAfterImport=function(){var n=u+"ActionAfterImport",t=JSON.stringify({});r.PostDataAjax(n,t,function(n){n?n.rs?(n.msg&&alert('Tải file lỗi <a href="'+n.msg+'" download="OnFinance_error_import_file.txt">tại đây<\/a>'),console.log(n.msg)):console.log(n.msg):console.log(n.msg)})};n.SetRequiedTaxCode=function(t){n.Import.ImportInvoiceType=t};n.Sum=function(n,t){return n.reduce(function(n,i){return n+i[t]},0)}}]);app.controller("ModalImportProductController",["$scope","$rootScope","$timeout","CommonFactory",function(n,t,i,r){var u="/Product/";t.Enterprise||t.GetEnterpriseInfo();angular.element(function(){n.Import={};n.ListMap={};n.Import.HeaderRow=1;n.Import.ShowSelectSheetAndHeader=!1});n.ShowStepThree=function(){n.stepOne=!1;n.stepTwo=!1;n.stepThree=!0};n.ImportBackToStep=function(t){n.stepOne=!1;n.stepTwo=!1;n.stepThree=!1;switch(t){case 1:n.stepOne=!0;break;case 2:n.stepTwo=!0}};n.ResetAllStep=function(){n.stepOne=!0;n.stepTwo=!1;n.stepThree=!1;n.ListData=null;n.IsDiffent=!0};t.ModalImportProduct=function(){};n.ImportProductFromExcel=function(){$("#fileUploadProduct").trigger("click")};$("#frmImportProduct").fileupload({autoUpload:!1,add:function(t,r){var e,f,o;if(!r.files[0].type.match("image.*")){if(e=CheckFile(r.files),!e)return!1;LoadingShow();f=new FormData;f.append("file0",r.files[0]);o=u+"ReadFileExcel";$.ajax({type:"POST",url:o,contentType:!1,processData:!1,data:f,success:function(t){i(function(){if(t.rs){n.Import.FileName=t.fileName;n.Import.ListSheets=JSON.parse(t.listSheet);n.Import.SelectedSheet=[n.Import.ListSheets[0]];var i=$("#ddlSheet");i.attr("value",n.Import.SelectedSheet.Index);n.Import.UploadMessage=t.reponseText;n.Import.ShowSelectSheetAndHeader=!0}else alert(t.msg);LoadingHide()})},error:function(){alert("Lỗi không thể đọc file excel.");LoadingHide()}})}}});n.ImportExcelMappingData=function(){if(n.listColumnError=[],!n.Import.FileName)return alert("Bạn chưa chọn file."),!1;if(!n.Import.SelectedSheet)return alert("Bạn chưa chọn sheet dữ liệu."),!1;if(!n.Import.HeaderRow)return alert("Bạn chưa chọn thứ tự dòng tiêu đề."),!1;var t=u+"MappingColumnExcel",f=JSON.stringify({selectedSheet:n.Import.SelectedSheet===undefined?0:n.Import.SelectedSheet[0].Index,headerRow:n.Import.HeaderRow});LoadingShow();r.PostDataAjax(t,f,function(t){t?t.rs?(n.ListData=t.data,i(function(){$(".selectpicker").selectpicker("refresh")},100),n.stepOne=!1,n.stepTwo=!0,n.ClientData=t.clientData,n.lstYourField=t.lstYourField):(n.ErrorMessage=t.msg,alert(t.msg)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SaveInvoiceList");LoadingHide()})};n.ImportExcelPreviewData=function(){var f=JSON.stringify(n.ListMap),t=n.ListData.filter(function(n){return n.YOURFIELD===null&&n.Required===!0}),e,r;if(t&&Object.keys(t).length>0&&$(t).each(function(t,i){n.ListMap[i.MYFIELD]||n.listColumnError.push(i.MYFIELD)}),n.listColumnError.length>0)return!1;e=JSON.stringify(n.ClientData);r=u+"PreviewProductData";successCallback=function(t){n.ImportProducts=t.ListProducts;i(function(){n.stepThree=!0;n.stepTwo=!1},100)};AjaxRequest(r,{listMap:f},"POST",!0,"json",successCallback)};n.SaveProductList=function(){n.ImportProducts||alert("Bạn chưa tải file lên. Vui lòng tải chọn file tải lên.");var t=u+"ImportDataProduct";successCallback=function(){$(".import-product").modal("hide");n.ResetAllStep()};AjaxRequest(t,{},"POST",!0,"json",successCallback)};n.BackgroundJobServiceProduct=function(){var i=$.connection.signlRConf,r=sessionStorage.getItem("userNameSS"),n;$.connection.hub.qs={username:r};n=0;i.client.newMessageReceivedProduct=function(i){var r,u,f;n=n+1;console.log(n);n===i.totalRow?(r="Thêm mới thành công <b>"+n+"/"+i.totalRow+"<\/b> hàng hóa.",$(".invoiceResult").html("Hoàn Thành"),$("#progressTab").hide(),toastr.success(r),n=0,u=function(n){if(n)return!1;t.ReloadProduct()},confirm(r+"<br> Bạn có muốn làm mới dữ liệu không?","Thêm mới hàng hóa","Có","Không",u)):($("#progressTab").show(),f=Math.floor(n/i.totalRow*100),$(".invoiceResult").html("Đang tải hàng hóa: "+f+"%"))}};n.BackgroundJobServiceProduct()}]);app.controller("ModalImportCustomerController",["$scope","$rootScope","$timeout","CommonFactory",function(n,t,i,r){var u="/Customer/";t.Enterprise||t.GetEnterpriseInfo();angular.element(function(){n.Import={};n.ListMap={};n.Import.HeaderRow=1;n.Import.ShowSelectSheetAndHeader=!1});n.ShowStepThree=function(){n.stepOne=!1;n.stepTwo=!1;n.stepThree=!0};n.ImportBackToStep=function(t){n.stepOne=!1;n.stepTwo=!1;n.stepThree=!1;switch(t){case 1:n.stepOne=!0;break;case 2:n.stepTwo=!0}};n.ResetAllStep=function(){n.stepOne=!0;n.stepTwo=!1;n.stepThree=!1;n.ListData=null;n.IsDiffent=!0};t.ModalImportProduct=function(){};n.changeDataMapping=function(){n.listColumnError=[]};n.ImportCustomerFromExcel=function(){$("#fileUploadCustomer").trigger("click")};$("#frmImportCustomer").fileupload({autoUpload:!1,add:function(t,r){var e,f,o;if(!r.files[0].type.match("image.*")){if(e=CheckFile(r.files),!e)return!1;LoadingShow();f=new FormData;f.append("file0",r.files[0]);o=u+"ReadFileExcel";$.ajax({type:"POST",url:o,contentType:!1,processData:!1,data:f,success:function(t){i(function(){if(t.rs){n.Import.FileName=t.fileName;n.Import.ListSheets=JSON.parse(t.listSheet);n.Import.SelectedSheet=[n.Import.ListSheets[0]];var i=$("#ddlSheet");i.attr("value",n.Import.SelectedSheet.Index);n.Import.UploadMessage=t.reponseText;n.Import.ShowSelectSheetAndHeader=!0}else alert(t.msg);LoadingHide()})},error:function(){alert("Lỗi không thể đọc file excel.");LoadingHide()}})}}});n.ImportExcelMappingData=function(){if(n.listColumnError=[],!n.Import.FileName)return alert("Bạn chưa chọn file."),!1;if(!n.Import.SelectedSheet)return alert("Bạn chưa chọn sheet dữ liệu."),!1;if(!n.Import.HeaderRow)return alert("Bạn chưa chọn thứ tự dòng tiêu đề."),!1;var t=u+"MappingColumnExcel",f=JSON.stringify({selectedSheet:n.Import.SelectedSheet===undefined?0:n.Import.SelectedSheet[0].Index,headerRow:n.Import.HeaderRow});LoadingShow();r.PostDataAjax(t,f,function(t){t?t.rs?(n.ListData=t.data,i(function(){$(".selectpicker").selectpicker("refresh")},100),n.stepOne=!1,n.stepTwo=!0,n.ClientData=t.clientData,n.lstYourField=t.lstYourField):(n.ErrorMessage=t.msg,alert(t.msg)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SaveInvoiceList");LoadingHide()})};n.ImportExcelPreviewData=function(){var f=JSON.stringify(n.ListMap),t=n.ListData.filter(function(n){return n.YOURFIELD===null&&n.Required===!0}),e,r;if(t&&Object.keys(t).length>0&&$(t).each(function(t,i){n.ListMap[i.MYFIELD]||n.listColumnError.push(i.MYFIELD)}),n.listColumnError.length>0)return!1;e=JSON.stringify(n.ClientData);r=u+"PreviewCustomerData";successCallback=function(t){n.ImportCustomers=t.ListCustomers;i(function(){n.stepThree=!0;n.stepTwo=!1},100)};AjaxRequest(r,{listMap:f,formCode:n.Import.FORMCODE,symbolCode:n.Import.SYMBOLCODE},"POST",!0,"json",successCallback)};n.count=1;n.SaveCustomerList=function(){n.ImportCustomers||alert("Bạn chưa tải file lên. Vui lòng tải chọn file tải lên.");var t=u+"ImportDataCustomer";successCallback=function(){$(".import-customer").modal("hide");n.ResetAllStep()};AjaxRequest(t,{},"POST",!0,"json",successCallback)};n.BackgroundJobServiceCustomer=function(){var i=$.connection.signlRConf,r=sessionStorage.getItem("userNameSS"),n;$.connection.hub.qs={username:r};n=0;i.client.newMessageReceivedCustomer=function(i){var r,u,f;n=n+1;console.log(n);n===i.totalRow?(r="Thêm mới thành công <b>"+n+"/"+i.totalRow+"<\/b> khách hàng.",$(".invoiceResult").html("Hoàn Thành"),$("#progressTab").hide(),toastr.success(r),n=0,u=function(n){if(n)return!1;t.ReloadCustomer()},confirm(r+"<br> Bạn có muốn làm mới dữ liệu không?","Thêm mới khách hàng","Có","Không",u)):($("#progressTab").show(),f=Math.floor(n/i.totalRow*100),$(".invoiceResult").html("Đang tải khách hàng: "+f+"%"))}};n.BackgroundJobServiceCustomer()}]);app.controller("ModalPreviewInvoiceController",["$scope","$rootScope","$timeout","CommonFactory",function(){}]);app.controller("ModalCancelInvoiceController",["$scope","$rootScope","$timeout","$location","CommonFactory",function(n,t,i,r,u){var s="/Invoice/",f=new Date,e=f.getDate(),o=f.getMonth()+1,h=f.getFullYear();e<10&&(e="0"+e);o<10&&(o="0"+o);f=e+"/"+o+"/"+h;t.ModalCancelInvoice=function(t){n.CancelInvoice={};i(function(){angular.copy(t,n.CancelInvoice);n.CancelInvoice.INVOICETYPE=3;n.CancelInvoice.STRCANCELTIME=f},100)};n.CancelInv=function(){var o=n.CancelInvoice.NUMBER,h=n.CancelInvoice.FORMCODE,c=n.CancelInvoice.SYMBOLCODE,f,i,e;if(n.CancelInvoice.STRCANCELTIME===undefined||n.CancelInvoice.STRCANCELTIME===null||n.CancelInvoice.STRCANCELTIME.trim()===""){alert("Vui lòng nhập vào ngày hủy.");return}if(!n.CancelInvoice.CANCELREASON||n.CancelInvoice.CANCELREASON==" ")return alert("Vui lòng nhập lý do hủy."),!1;if(n.CancelInvoice.AttachEmail===!0){if(!n.CancelInvoice.CUSEMAIL)return alert("Vui nhập vào email người nhận!!"),!1;for(f=n.CancelInvoice.CUSEMAIL.split(","),i=0;i<f.length;i++)if(!validation.isEmailAddress(f[i].trim()))return alert("Vui lòng nhập đúng định dạng email "+(i+1)),!1}e=function(i){if(!i)return!1;var f=s+"UpdateCancelInvoice",e=JSON.stringify({invoice:n.CancelInvoice,type:0});LoadingShow();u.PostDataAjax(f,e,function(i){if(i)if(i.rs){var u=function(i){if(i)r.path().toString().includes("/bien-lai-thu-phi-le-phi")?(t.ModalReceipt(n.CancelInvoice,6),$(".modal-receipt").modal("show")):(t.ModalInvoice(n.CancelInvoice,6),$(".modal-invoice").modal("show"));else return!1};confirm("Xóa bỏ hóa đơn thành công. Bạn có muốn lập hóa đơn thay thế cho hóa đơn này hay không?","Lập hóa đơn thay thế","Không","Có",u);$(".modal-cancel-invoice").modal("hide");r.path().toString().includes("/bien-lai-thu-phi-le-phi")?t.ReloadReceipt():t.ReloadInvoice()}else n.ErrorMessage=i.msg,alert(i.msg);else alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - CancelInv");LoadingHide()})};confirm("Sau khi hủy bỏ hóa đơn <strong><"+h+" - "+c+" - "+("0000000"+o).slice(-7)+"><\/strong> thì hóa đơn này sẽ không còn giá trị sử dụng, bạn không thể khôi phục được trạng thái ban đầu của hóa đơn và bạn phải lập hóa đơn thay thế.<br /> Bạn có thực sự muốn <strong>hủy bỏ<\/strong> hóa đơn này không?","Hủy bỏ hóa đơn","Không","Đồng ý",e)}}]);app.controller("ModalChangeInvoiceController",["$scope","$rootScope","$timeout","CommonFactory",function(n,t,i,r){var u="/Invoice/";t.ModalChangeInvoice=function(t,i){n.TYPECHANGE=i;n.Invoice={};n.Invoice.LISTPRODUCT=[];n.Invoice.LISTPRODUCT.push({});i==5&&(angular.copy(t,n.ChangeInvoice),n.GetInvoiceDetail(t.ID),n.ChangeInvoice.ID=0)};n.GetInvoiceDetail=function(t){n.IsLoading=!0;var i=u+"GetInvoiceDetail",f=JSON.stringify({invoiceid:t});LoadingShow();r.PostDataAjax(i,f,function(t){t?t.rs?n.Invoice.LISTPRODUCT=t.result:n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetInvoiceDetail");LoadingHide()})}}]);app.controller("ModalNumberWaitingController",["$scope","$rootScope","$timeout","$sce","CommonFactory","$filter",function(n,t,i,r,u){var f="/Invoice/";t.ModalNumberWaiting=function(t,r){n.Number={};n.TYPECHANGE=r;r===2&&i(function(){angular.copy(t,n.Number)},300)};n.GetNumber=function(){if(n.Number.FORMCODE){let t=n.Number.FORMCODE.split("-");n.FormNumber={};n.FormNumber.FORMCODE=t[0];n.FormNumber.SYMBOLCODE=t[1];var i=f+"GetNumber",r=JSON.stringify({form:n.FormNumber});LoadingShow();u.PostDataAjax(i,r,function(t){if(t)if(t.rs){let i=t.result[0];n.CurrentNumberWaiting=i;n.Number.CURRENTNUMBER=i.CURRENTNUMBER;n.Number.FROMNUMBER=i.CURRENTNUMBER+1}else n.ErrorMessage=t.msg,alert(n.ErrorMessage);else alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetNumberaa");LoadingHide()});n.IsLoading=!1}};n.AddNumberWaiting=function(){var i,r,e;if(!n.Number.FORMCODE)return alert("Vui lòng chọn mẫu số, ký hiệu hóa đơn."),!1;if(n.Number.FROMNUMBER<n.CurrentNumberWaiting.FROMNUMBER)return alert("Số bắt đầu của dải chờ "+n.Number.FROMNUMBER+" phải lớn hơn hoặc bằng số bắt đầu của dải số "+n.CurrentNumberWaiting.FROMNUMBER),!1;if(n.Number.FROMNUMBER<n.Number.CURRENTNUMBER)return alert("Số bắt đầu của dải chờ phải lớn hơn hoặc bằng số hiện tại."),!1;if(n.Number.TONUMBER<n.Number.FROMNUMBER)return alert("Số đến của dải chờ phải lớn hơn hoặc bằng số bắt đầu."),!1;if(n.Number.TONUMBER>n.CurrentNumberWaiting.TONUMBER)return alert("Số đến của dải chờ "+n.Number.TONUMBER+" phải nhỏ hơn hoặc bằng số đến của dải số "+n.CurrentNumberWaiting.TONUMBER),!1;i=n.Number.FORMCODE.split("-");n.Number.FORMCODE=i[0];n.Number.SYMBOLCODE=i[1];r=f+"AddNumberWaiting";e=JSON.stringify({numberWaiting:n.Number});LoadingShow();u.PostDataAjax(r,e,function(n){n?n.rs?(toastr.options={timeOut:"2000"},toastr.success("Thêm mới thành công!"),$(".modal-number-waiting").modal("hide"),t.GetInvoiceWaiting(1)):alert(n.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SaveAndSend");LoadingHide()});LoadingHide()};n.UpdateNumberWaiting=function(){if(!n.Number.FORMCODE)return alert("Vui lòng chọn mẫu số hóa đơn."),$("select#form-code").focus(),!1;if(!n.Number.SYMBOLCODE)return alert("Vui lòng chọn kí hiệu hóa đơn."),$("select#symbol-code").focus(),!1;if(n.Number.FROMNUMBER<n.Number.CURRENTNUMBER)return alert("Số bắt đầu của dải chờ phải lớn hơn hoặc bằng số hiện tại."),$("select#symbol-code").focus(),!1;if(n.Number.TONUMBER<n.Number.FROMNUMBER)return alert("Số đến của dải chờ phải lớn hơn hoặc bằng số bắt đầu."),$("select#symbol-code").focus(),!1;var i=f+"UpdateNumberWaiting",r=JSON.stringify({numberWaiting:n.Number});LoadingShow();u.PostDataAjax(i,r,function(n){n?n.rs?(toastr.options={timeOut:"2000"},toastr.success("Cập nhật thành công!"),$(".modal-number-waiting").modal("hide"),t.GetInvoiceWaiting()):alert(n.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SaveAndSend");LoadingHide()})}}]);app.controller("InvoiceWaitController",["$scope","$rootScope","$timeout","$sce","CommonFactory","$filter","$location",function(n,t,i,r,u,f,e){var c="/Invoice/",l,a,v,y,p;angular.element(function(){});n.TabWaiting={TabWaitingNumber:!0,TabInvoice:!1};n.CurrentNumberObject={};t.TabClick=function(t,i){var e;i&&(n.NumberWaitingId=i.ID,n.CurrentNumberObject=i);var u=[],r=[],f=[];if(n.CurrentNumberObject.USEDNUMBER!=null){f=n.CurrentNumberObject.USEDNUMBER.split(",");for(let n=0;n<f.length;n++)r.push(parseInt(f[n]))}for(let t=n.CurrentNumberObject.FROMNUMBER;t<=n.CurrentNumberObject.TONUMBER;t++)u.push(t);e=u.filter(function(n){return r.indexOf(n)<0});n.LISTUSEDNUMBER=r.sort(function(n,t){return n-t});n.LISTNUMBER=e.sort(function(n,t){return n-t});r.length==u.length;n.TabWaiting.TabWaitingNumber=!1;n.TabWaiting.TabInvoice=!1;n.Filter={};n.ListInvoice=[];switch(t){case 1:n.TabWaiting.TabWaitingNumber=!0;n.GetInvoiceWaiting(1);break;case 2:n.TabWaiting.TabInvoice=!0;n.Filter={};n.Filter.INVOICESTATUS=1;n.Filter.FORMCODE=i.FORMCODE;n.Filter.SYMBOLCODE=i.SYMBOLCODE;n.GetInvoice(1);break;default:n.TabWaiting.TabWaitingNumber=!0}};t.ReloadWaitingInvoice=function(t,i){e.path().toString().includes("/dai-hoa-don-cho")&&(n.Filter={},n.ListInvoice=[],n.Filter.INVOICESTATUS=1,n.Filter.FORMCODE=t,n.Filter.SYMBOLCODE=i,n.GetInvoice(1))};n.SignWaiting=function(t,i,r){var u;if(!r)return alert("Vui lòng nhập vào số muốn ký."),!1;if(parseInt(r)<=0)return alert("Vui lòng nhập số lớn hơn 0."),!1;if(parseInt(r)<parseInt(n.CurrentNumberObject.FROMNUMBER))return alert("Số hóa đơn không nhỏ hơn số bắt đầu."),!1;if(parseInt(r)>parseInt(n.CurrentNumberObject.TONUMBER))return alert("Số hóa đơn không lớn hơn số đến."),!1;if(!i)return alert("Vui lòng nhập vào ngày muốn ký."),!1;if(!i.match(/^\d{2}[./-]\d{2}[./-]\d{4}$/))return alert("Vui lòng nhập đúng định dạng ngày dd/mm/yyyy."),!1;if(n.CurrentNumberObject.USEDNUMBER!==null&&(u=n.CurrentNumberObject.USEDNUMBER.split(",").filter(function(n){return n==r}),u.length>0))return alert("Số hóa đơn "+r+" đã được sử dụng."),!1;LoadingShow();SignWaiting(t,i,n.NumberWaitingId,r)};n.GetNumber=function(){n.FormNumber={};n.FormNumber.FORMCODE=n.Number.FORMCODE;n.FormNumber.SYMBOLCODE=n.Number.SYMBOLCODE;var t=c+"GetNumber",i=JSON.stringify({form:n.FormNumber});LoadingShow();u.PostDataAjax(t,i,function(t){if(t)if(t.rs){let i=t.data[0];n.Number.CURRENTNUMBER=i.CURRENTNUMBER;n.Number.FROMNUMBER=i.CURRENTNUMBER}else n.ErrorMessage=t.msg;else alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetInvoice");LoadingHide()});n.IsLoading=!1};n.SetDatepiker=function(n){let t=$("#pk_"+n);t.datepicker({dateFormat:"dd/mm/yy",maxDate:new Date});SetVietNameInterface(t)};n.CheckDateOfPreviousInvoice=function(t,i){var r=$("#pk_"+i.ID),o=null,s=c+"CheckDateOfPreviousInvoice",f="",e="",h=JSON.stringify({form:i,number:parseInt(t)});t!=null&&t!=""&&u.PostDataAjax(s,h,function(i){if(i){if(i.rs){var u=i.result.filter(n=>n.NUMBER<t),s=i.result.filter(n=>n.NUMBER>t);f=u.length===0?null:new Date(u[0].SIGNEDTIME.match(/\d+/)[0]*1);r.datepicker("option","minDate",f);e=s.length===0?o:new Date(s[0].SIGNEDTIME.match(/\d+/)[0]*1);r.datepicker("option","maxDate",e);r.datepicker({dateFormat:"dd/mm/yy",mindate:f,maxdate:e})}else r.datepicker("option","maxDate",o),r.datepicker({dateFormat:"dd/mm/yy",maxDate:o}),n.ErrorMessage=i.msg;r.datepicker("option","minDate",f);r.datepicker("option","maxDate",e);SetVietNameInterface(r);r.datepicker("show")}else alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - CheckDateOfPreviousInvoice")})};n.GetInvoice=function(t){n.Filter||(n.Filter={});t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;var i=c+"GetInvoice",r=JSON.stringify({form:n.Filter,currentPage:n.currentpage,itemPerPage:10});n.ListInvoice=[];n.TotalPages=1;n.TotalRow=1;LoadingShow();u.PostDataAjax(i,r,function(t){t?t.rs?(n.ListInvoice=t.result,n.TotalPages=t.TotalPages,n.TotalRow=t.TotalRow):(alert(t.msg),n.ErrorMessage=t.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetInvoice");LoadingHide()});n.IsLoading=!1};t.GetInvoiceWaiting=function(t){t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentRow=10;n.currentpage=t;var i=c+"GetInvoiceNumerWaiting",r=JSON.stringify({itemPerPage:n.currentRow,currentPage:n.currentpage});LoadingShow();u.PostDataAjax(i,r,function(t){t?t.rs?(t.result.forEach(function(t){t.NUMBERSTATUS=n.ENUM_WAITINGNUMBERSTATUS.CON_SO;let r=[],i=[],f=[],u=[];if(t.USEDNUMBER!=null){u=t.USEDNUMBER.split(",");for(let n=0;n<u.length;n++)i.push(parseInt(u[n]));t.USEDNUMBER=i.sort(function(n,t){return n-t}).join(", ")}for(let n=t.FROMNUMBER;n<=t.TONUMBER;n++)r.push(n);i.length==r.length&&(t.NUMBERSTATUS=n.ENUM_WAITINGNUMBERSTATUS.HET_SO);f=r.filter(function(n){return!i.includes(n)});t.AVAILABLENUMBER=f.join(", ")}),n.ListInvoiceWaiting=t.result,n.TotalPages=t.TotalPages,n.TotalRow=t.TotalRow):(alert(t.msg),n.ErrorMessage=t.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetInvoice");LoadingHide()})};var h=new Date,o=new Date,s=new Date,w=h.getDay();o.setDate(h.getDate()-w);s.setDate(o.getDate()+6);l=o.getFullYear()+"-"+(o.getMonth()+1)+"-"+o.getDate()+";"+s.getFullYear()+"-"+(s.getMonth()+1)+"-"+s.getDate();o.setDate(o.getDate()-7);s.setDate(s.getDate()-7);a=o.getFullYear()+"-"+(o.getMonth()+1)+"-"+o.getDate()+";"+s.getFullYear()+"-"+(s.getMonth()+1)+"-"+s.getDate();v=new Date(h.getFullYear(),h.getMonth(),0).getDate();o=new Date(h.getFullYear(),h.getMonth(),1);s=new Date(h.getFullYear(),h.getMonth(),v-1);y=o.getFullYear()+"-"+(o.getMonth()+1)+"-"+o.getDate()+";"+s.getFullYear()+"-"+(s.getMonth()+1)+"-"+s.getDate();s.setDate(o.getDate()-1);o=new Date(s.getFullYear(),s.getMonth(),1);p=o.getFullYear()+"-"+(o.getMonth()+1)+"-"+o.getDate()+";"+s.getFullYear()+"-"+(s.getMonth()+1)+"-"+s.getDate();n.Timepickers={value:l,Options:[{value:l,text:"Tuần này"},{value:a,text:"Tuần trước"},{value:y,text:"Tháng này"},{value:p,text:"Tháng trước"}]};n.ENUM_WAITINGNUMBERSTATUS={CON_SO:"Còn số",HET_SO:"Hết số"};$(".dropdown-menu").find("form").click(function(n){n.stopPropagation()});$(document).on("keyup",".number-waitting",function(n){n.keyCode==69&&$(".number-waitting").val("")})}]);app.controller("ModalReleaseNoticeController",["$scope","$rootScope","$timeout","$sce","CommonFactory",function(n,t,i,r,u){var f="/Invoice/";t.ModalNumber=function(){n.Number={}};n.AddReleaseNotice=function(){var t,i,r;if(!n.Number||!n.Number.FORMCODE)return alert("Vui lòng chọn mẫu số hóa đơn"),$("select#form-code").focus(),!1;if(n.Number.SYMBOLCODE){if(n.Number.SYMBOLCODE.length!=6)return alert("Ký hiệu bao gồm 6 ký hiệu, vui lòng kiểm tra lại!"),$("select#symbol-code").focus(),!1;if((t=n.Number.SYMBOLCODE.split("/"),t[0].length!=2||!n.Number.SYMBOLCODE.endsWith("E"))||t.length==2&&(t[1].length!=3||!validation.isNumber(t[1].substring(0,2))))return alert("Vui lòng nhập đúng ký hiệu theo quy định"),$("select#symbol-code").focus(),!1}else return alert("Vui lòng nhập đúng ký hiệu theo quy định"),$("select#symbol-code").focus(),!1;if(!n.Number.STRFROMTIME)return alert("Vui lòng chọn Ngày bắt đầu sử dụng"),!1;if(!n.Number.TONUMBER>n.Number.FROMNUMBER)return alert("Dải số đến không được nhỏ hơn dải số bắt đầu, vui lòng kiểm tra lại."),!1;n.IsLoading=!0;i=f+"AddReleaseNotice";r=JSON.stringify({numberWaiting:n.Number});LoadingShow();u.PostDataAjax(i,r,function(n){n?n.rs?(alert("Thành công!"),$(".modal-number-waiting").modal("hide"),location.reload(!0)):alert(n.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SaveAndSend");LoadingHide()})};n.AcceptReleaseNotice=function(t){n.IsLoading=!0;var i=f+"AcceptReleaseNotice",r=JSON.stringify({releaseNoticeId:t});LoadingShow();u.PostDataAjax(i,r,function(n){n?n.rs?(alert("Thành công!"),location.reload(!0)):alert(n.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SaveAndSend");LoadingHide()})}}]);app.controller("ModalCancelReportController",["$scope","$rootScope","$timeout","$location","CommonFactory","$filter",function(n,t,i,r,u,f){var e="/Invoice/",o=new Date;n.CurrentDay=String(o.getDate()).padStart(2,"0");n.CurrentMonth=String(o.getMonth()+1).padStart(2,"0");n.CurrentYear=o.getFullYear();n.CurrentDate=n.CurrentDay+"/"+n.CurrentMonth+"/"+n.CurrentYear;t.ModalCancelReport=function(t,r){n.Invoice={};n.Report={};i(function(){angular.copy(t,n.Report);angular.copy(r,n.Invoice);n.Invoice.STRCANCELTIME=f("dateFormat")(n.Invoice.CANCELTIME,"dd/MM/yyyy");n.Invoice.CANCELTIME==="/Date(-62135596800000)/"&&(n.Invoice.STRCANCELTIME=n.CurrentDate)},100)};n.AddReport=function(i){if(i===REPORT_TYPE.Cancel&&(n.Report.REPORTTYPE=REPORT_TYPE.Cancel),n.Report.INVOICEID=n.Invoice.ID,n.Report.COMPHONENUMBER||(n.Report.COMPHONENUMBER=n.Enterprise.COMPHONENUMBER),n.Report.COMLEGALNAME||(n.Report.COMLEGALNAME=n.Enterprise.COMLEGALNAME),n.Report.CUSADDRESS||(n.Report.CUSADDRESS=n.Invoice.CUSADDRESS),n.Report.CUSTAXCODE||(n.Report.CUSTAXCODE=n.Invoice.CUSTAXCODE),n.Report.CUSPHONENUMBER||(n.Report.CUSPHONENUMBER=n.Invoice.CUSPHONENUMBER),n.Report.CUSDELEGATE||(n.Report.CUSDELEGATE=n.Invoice.CUSBUYER),n.Report.REASON||(n.Report.REASON=n.Invoice.CANCELREASON),!n.Report.REASON)return alert("Vui lòng nhập lý do hủy!"),!1;if(n.Report.STRREPORTTIME=n.Invoice.STRCANCELTIME,n.Report.STRREPORTTIME===undefined||n.Report.STRREPORTTIME===null||n.Report.STRREPORTTIME===""){alert("Vui lòng nhập vào ngày lập biên bản hủy.");return}var f=e+"AddReport",o=JSON.stringify({report:n.Report});LoadingShow();u.PostDataAjax(f,o,function(i){i?i.rs?(n.Invoice.CANCELREASON=n.Report.REASON,t.ModalCancelInvoice(n.Invoice),toastr.success(i.msg),n.Invoice.INVOICETYPE!=3&&$(".modal-cancel-invoice").modal("show"),$(".modal-cancel-report").modal("hide"),r.path().toString().includes("/bien-lai-thu-phi-le-phi")?t.ReloadReceipt():t.ReloadInvoice()):alert(i.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - AddReport");LoadingHide()})};n.UpdateReport=function(){if(n.Report.REPORTTYPE=n.Invoice.ISEXISTCANCELREPORT,n.Report.INVOICEID=n.Invoice.ID,n.Report.COMPHONENUMBER||(n.Report.COMPHONENUMBER=n.Enterprise.COMPHONENUMBER),n.Report.COMLEGALNAME||(n.Report.COMLEGALNAME=n.Enterprise.COMLEGALNAME),n.Report.CUSADDRESS||(n.Report.CUSADDRESS=n.Invoice.CUSADDRESS),n.Report.CUSTAXCODE||(n.Report.CUSTAXCODE=n.Invoice.CUSTAXCODE),n.Report.CUSPHONENUMBER||(n.Report.CUSPHONENUMBER=n.Invoice.CUSPHONENUMBER),n.Report.CUSDELEGATE||(n.Report.CUSDELEGATE=n.Invoice.CUSBUYER),n.Report.REASON||(n.Report.REASON=n.Invoice.CANCELREASON),!n.Report.REASON)return alert("Vui lòng nhập lý do hủy!"),!1;if(n.Report.STRREPORTTIME=n.Invoice.STRCANCELTIME,n.Report.STRREPORTTIME===undefined||n.Report.STRREPORTTIME===null||n.Report.STRREPORTTIME===""){alert("Vui lòng nhập vào ngày lập biên bản hủy.");return}LoadingShow();var i=e+"UpdateReport",f=JSON.stringify({report:n.Report});u.PostDataAjax(i,f,function(n){n?n.rs?(toastr.success(n.msg),$(".modal-cancel-report").modal("hide"),r.path().toString().includes("/bien-lai-thu-phi-le-phi")?t.ReloadReceipt():t.ReloadInvoice()):alert(n.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - UpdateCancelReport");LoadingHide()})};n.SaveAndSignDocumentPDF=function(i){var f="Vui lòng nhập lý do hủy.",o,s;if(i===REPORT_TYPE.Cancel?n.Report.REPORTTYPE=REPORT_TYPE.Cancel:f="Vui lòng nhập lý do điều chỉnh.",n.Report.INVOICEID=n.Invoice.ID,n.Report.COMPHONENUMBER||(n.Report.COMPHONENUMBER=n.Enterprise.COMPHONENUMBER),n.Report.COMLEGALNAME||(n.Report.COMLEGALNAME=n.Enterprise.COMLEGALNAME),n.Report.CUSADDRESS||(n.Report.CUSADDRESS=n.Invoice.CUSADDRESS),n.Report.CUSTAXCODE||(n.Report.CUSTAXCODE=n.Invoice.CUSTAXCODE),n.Report.CUSPHONENUMBER||(n.Report.CUSPHONENUMBER=n.Invoice.CUSPHONENUMBER),n.Report.CUSDELEGATE||(n.Report.CUSDELEGATE=n.Invoice.CUSBUYER),n.Report.REASON||(n.Report.REASON=n.Invoice.CANCELREASON),!n.Report.REASON)return alert(f),!1;if(n.Report.STRREPORTTIME=n.Invoice.STRCANCELTIME,n.Report.STRREPORTTIME===undefined||n.Report.STRREPORTTIME===null||n.Report.STRREPORTTIME===""){alert("Vui lòng nhập vào ngày lập biên bản hủy.");return}o=e+"SaveAndSignDocumentPDF";s=JSON.stringify({report:n.Report});LoadingShow();u.PostDataAjax(o,s,function(i){i?i.rs?(n.Invoice.CANCELREASON=n.Report.REASON,t.ModalCancelInvoice(n.Invoice),toastr.success(i.msg),n.Invoice.INVOICETYPE!=3&&$(".modal-cancel-invoice").modal("show"),$(".modal-cancel-report").modal("hide"),r.path().toString().includes("/bien-lai-thu-phi-le-phi")?t.ReloadReceipt():t.ReloadInvoice()):alert(i.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - AddReport");LoadingHide()})}}]);app.controller("ModalModifiedReportController",["$scope","$rootScope","$timeout","$location","CommonFactory","$filter",function(n,t,i,r,u){var f="/Invoice/",e=new Date;n.CurrentDay=String(e.getDate()).padStart(2,"0");n.CurrentMonth=String(e.getMonth()+1).padStart(2,"0");n.CurrentYear=e.getFullYear();n.CurrentDate=n.CurrentDay+"/"+n.CurrentMonth+"/"+n.CurrentYear;t.ModalModifiedReport=function(t,r){n.Invoice={};n.Report={};i(function(){angular.copy(r,n.Invoice);angular.copy(t,n.Report);n.Report.REPORTTIME=n.CurrentDate},100)};n.AddReport=function(i){if(i===REPORT_TYPE.Change&&(n.Report.REPORTTYPE=REPORT_TYPE.Change),n.Report.INVOICEID=n.Invoice.ID,n.Report.COMPHONENUMBER||(n.Report.COMPHONENUMBER=n.Enterprise.COMPHONENUMBER),n.Report.COMLEGALNAME||(n.Report.COMLEGALNAME=n.Enterprise.COMLEGALNAME),n.Report.CUSADDRESS||(n.Report.CUSADDRESS=n.Invoice.CUSADDRESS),n.Report.CUSTAXCODE||(n.Report.CUSTAXCODE=n.Invoice.CUSTAXCODE),n.Report.CUSPHONENUMBER||(n.Report.CUSPHONENUMBER=n.Invoice.CUSPHONENUMBER),n.Report.CUSDELEGATE||(n.Report.CUSDELEGATE=n.Invoice.CUSBUYER),n.Report.REASON||(n.Report.REASON=n.Invoice.CHANGEREASON),!n.Report.REASON)return alert("Vui lòng nhập lý do điều chỉnh!"),!1;if(n.Report.STRREPORTTIME=n.Report.REPORTTIME,n.Report.STRREPORTTIME===undefined||n.Report.STRREPORTTIME===null||n.Report.STRREPORTTIME===""){alert("Vui lòng nhập vào ngày lập biên bản điều chỉnh.");return}var e=f+"AddReport",o=JSON.stringify({report:n.Report});LoadingShow();u.PostDataAjax(e,o,function(i){i?i.rs?(toastr.success(i.msg),n.Invoice.CHANGEREASON=n.Report.REASON,$(".modal-modified-report").modal("hide"),n.Invoice.INVOICETYPE!=5&&(r.path().toString().includes("/bien-lai-thu-phi-le-phi")?t.ModalReceipt(n.Invoice,5):t.ModalInvoice(n.Invoice,5)),r.path().toString().includes("/bien-lai-thu-phi-le-phi")?t.ReloadReceipt():t.ReloadInvoice()):alert(i.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - AddReport");LoadingHide()})};n.UpdateReport=function(){if(n.Report.REPORTTYPE=n.Invoice.ISEXISTMODIFIEDREPORT,n.Report.INVOICEID=n.Invoice.ID,n.Report.COMPHONENUMBER||(n.Report.COMPHONENUMBER=n.Enterprise.COMPHONENUMBER),n.Report.COMLEGALNAME||(n.Report.COMLEGALNAME=n.Enterprise.COMLEGALNAME),n.Report.CUSADDRESS||(n.Report.CUSADDRESS=n.Invoice.CUSADDRESS),n.Report.CUSTAXCODE||(n.Report.CUSTAXCODE=n.Invoice.CUSTAXCODE),n.Report.CUSPHONENUMBER||(n.Report.CUSPHONENUMBER=n.Invoice.CUSPHONENUMBER),n.Report.CUSDELEGATE||(n.Report.CUSDELEGATE=n.Invoice.CUSBUYER),n.Report.REASON||(n.Report.REASON=n.Invoice.CHANGEREASON),!n.Report.REASON)return alert("Vui lòng nhập lý do điều chỉnh!"),!1;if(n.Report.STRREPORTTIME=n.Report.REPORTTIME,n.Report.STRREPORTTIME===undefined||n.Report.STRREPORTTIME===null||n.Report.STRREPORTTIME===""){alert("Vui lòng nhập vào ngày lập biên bản điều chỉnh.");return}var i=f+"UpdateReport",e=JSON.stringify({report:n.Report});LoadingShow();u.PostDataAjax(i,e,function(n){n?(n.rs?(toastr.success(n.msg),$(".modal-modified-report").modal("hide"),r.path().toString().includes("/bien-lai-thu-phi-le-phi")?t.ReloadReceipt():t.ReloadInvoice()):alert(n.msg),LoadingHide()):(alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - UpdateModifiedReport"),LoadingHide());LoadingHide()})};n.SaveAndSignDocumentPDF=function(i){var e="Vui lòng nhập lý do điều chỉnh.",o,s;if(i===REPORT_TYPE.Change?n.Report.REPORTTYPE=REPORT_TYPE.Change:e="Vui lòng nhập lý do hủy.",n.Report.INVOICEID=n.Invoice.ID,n.Report.COMPHONENUMBER||(n.Report.COMPHONENUMBER=n.Enterprise.COMPHONENUMBER),n.Report.COMLEGALNAME||(n.Report.COMLEGALNAME=n.Enterprise.COMLEGALNAME),n.Report.CUSADDRESS||(n.Report.CUSADDRESS=n.Invoice.CUSADDRESS),n.Report.CUSTAXCODE||(n.Report.CUSTAXCODE=n.Invoice.CUSTAXCODE),n.Report.CUSPHONENUMBER||(n.Report.CUSPHONENUMBER=n.Invoice.CUSPHONENUMBER),n.Report.CUSDELEGATE||(n.Report.CUSDELEGATE=n.Invoice.CUSBUYER),n.Report.REASON||(n.Report.REASON=n.Invoice.CHANGEREASON),!n.Report.REASON)return alert(e),!1;if(n.Report.STRREPORTTIME=n.Report.REPORTTIME,n.Report.STRREPORTTIME===undefined||n.Report.STRREPORTTIME===null||n.Report.STRREPORTTIME===""){alert("Vui lòng nhập vào ngày lập biên bản điều chỉnh.");return}o=f+"SaveAndSignDocumentPDF";s=JSON.stringify({report:n.Report});LoadingShow();u.PostDataAjax(o,s,function(i){i?i.rs?(n.Invoice.CHANGEREASON=n.Report.REASON,n.Invoice.INVOICETYPE!=5&&(r.path().toString().includes("/bien-lai-thu-phi-le-phi")?t.ModalReceipt(n.Invoice,5):t.ModalInvoice(n.Invoice,5)),toastr.success(i.msg),$(".modal-modified-report").modal("hide"),r.path().toString().includes("/bien-lai-thu-phi-le-phi")?t.ReloadReceipt():t.ReloadInvoice()):alert(i.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - AddReport");LoadingHide()})}}]);app.controller("ModalReleaseDocumentController",["$scope","$rootScope","$timeout","CommonFactory",function(n,t,i,r){var f="/Invoice/",u=new Date;n.CurrentDay=u.getDate();n.CurrentMonth=u.getMonth()+1;n.CurrentYear=u.getFullYear();n.CurrentDate=u.getDate()+"/"+(u.getMonth()+1)+"/"+u.getFullYear();t.ModalReleaseDocumentReport=function(t){n.Invoice={};i(function(){angular.copy(t,n.Invoice);angular.copy(item1,n.Report)},100)};n.AddReport=function(i){if(i===2&&(n.Report.REPORTTYPE="2"),n.Report.INVOICEID=n.Invoice.ID,n.Report.COMPHONENUMBER||(n.Report.COMPHONENUMBER=n.Enterprise.COMPHONENUMBER),n.Report.COMLEGALNAME||(n.Report.COMLEGALNAME=n.Enterprise.COMLEGALNAME),n.Report.CUSADDRESS||(n.Report.CUSADDRESS=n.Invoice.CUSADDRESS),n.Report.CUSTAXCODE||(n.Report.CUSTAXCODE=n.Invoice.CUSTAXCODE),n.Report.CUSPHONENUMBER||(n.Report.CUSPHONENUMBER=n.Invoice.CUSPHONENUMBER),n.Report.CUSDELEGATE||(n.Report.CUSDELEGATE=n.Invoice.CUSBUYER),n.Report.REASON||(n.Report.REASON=n.Invoice.CHANGEREASON),!n.Report.REASON)return alert("Vui lòng nhập tên cơ quan thuế tiếp nhận thông báo!"),!1;var u=f+"AddReport",e=JSON.stringify({report:n.Report});LoadingShow();r.PostDataAjax(u,e,function(i){i?i.rs?(n.Invoice.CHANGEREASON=n.Report.REASON,t.ModalInvoice(n.Invoice,5),$(".modal-invoice").modal("show"),$(".modal-modified-report").modal("hide"),t.ReloadInvoice()):alert(i.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - AddReport");LoadingHide()})};n.UpdateReport=function(){if(n.Report.REPORTTYPE=n.Invoice.ISEXISTMODIFIEDREPORT,n.Report.INVOICEID=n.Invoice.ID,n.Report.COMPHONENUMBER||(n.Report.COMPHONENUMBER=n.Enterprise.COMPHONENUMBER),n.Report.COMLEGALNAME||(n.Report.COMLEGALNAME=n.Enterprise.COMLEGALNAME),n.Report.CUSADDRESS||(n.Report.CUSADDRESS=n.Invoice.CUSADDRESS),n.Report.CUSTAXCODE||(n.Report.CUSTAXCODE=n.Invoice.CUSTAXCODE),n.Report.CUSPHONENUMBER||(n.Report.CUSPHONENUMBER=n.Invoice.CUSPHONENUMBER),n.Report.CUSDELEGATE||(n.Report.CUSDELEGATE=n.Invoice.CUSBUYER),n.Report.REASON||(n.Report.REASON=n.Invoice.CHANGEREASON),!n.Report.REASON)return alert("Vui lòng nhập tên cơ quan thuế tiếp nhận thông báo!"),!1;var i=f+"UpdateReport",u=JSON.stringify({report:n.Report});LoadingShow();r.PostDataAjax(i,u,function(n){n?(n.rs?(alert("Thành công!"),$(".modal-modified-report").modal("hide"),t.ReloadInvoice()):alert(n.msg),LoadingHide()):(alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - UpdateModifiedReport"),LoadingHide());LoadingHide()})}}]);app.controller("TempInvoiceController",["$scope","$rootScope","$routeParams","$timeout","CommonFactory",function(n,t,i,r,u){function h(n){var t=[];for(let i in n){let r=i+" {";for(let t in n[i])r+=t+":"+n[i][t]+";";r+="}";t.push(r)}return t.join("\n")}var c="/TempInvoice/",o;LoadingHide();var s="/TempInvoice/ViewTemplate/?id=",f=$("#iframe_templateViewInvoice"),e=null;i.id&&(e=atob(i.id));n.InvoiceType={value:"1",Options:[{value:"1",text:"Mẫu một thuế suất"},{value:"2",text:"Mẫu nhiều thuế suất"},{value:"3",text:"Hóa đơn bán hàng"},{value:"4",text:"Hóa đơn tiền điện"},{value:"5",text:"Hóa đơn tiền nước"},{value:"6",text:"Hóa đơn trường học"},{value:"7",text:"Phiếu xuất kho"}]};r(function(){var i=0,r,u;t.Enterprise&&(i=t.Enterprise.USINGINVOICETYPE);r="1";u=[{value:"1",text:"Khổ giấy A4"},{value:"2",text:"Khổ giấy A5"}];(i===1||i===4)&&(r="2",u=[{value:"2",text:"Khổ giấy A5"}]);n.SizePaper={value:r,Options:u}});o=function(){LoadingShow();r(function(){var i=f.contents().find("style").text();i!=null&&i!=""?$.parsecss(i,function(i){r(function(){var e=f.contents().find("#form_invoice_template").text(),s=f.contents().find("#symbol_invoice_template").text(),o=e.split("/"),u;n.template={fontSize:"16px",fontFamily:"Times New Roman",SYMBOLCODE:s,FORM:o[0]+"/",CODE:o[1],FORMCODE:e,logo:"",bg:"",status:4,borderRadius:"0px",borderWidth:"0px",style:i};t.Enterprise&&(n.SizePaper.value==="2"||t.Enterprise.USINGINVOICETYPE===1||t.Enterprise.USINGINVOICETYPE===4?r(function(){$("#viewPreviewTemplate")[0].setAttribute("style","width: 760px;height: 500px;");var n=$("#iframe_templateViewInvoice").contents();n.find("img.temp")[0].setAttribute("style","position: absolute; width: 200px; top: 45%; left: calc(50% - 100px); transform: rotate(-30deg);");n.find("body")[0].setAttribute("style","height: 720px;background-size: 70%;");$("#iframe_templateViewInvoice")[0].setAttribute("style","width: 1100px;height: 720px;")}):($("#viewPreviewTemplate")[0].removeAttribute("style","width: 760px;height: 600px;"),u=$("#iframe_templateViewInvoice").contents(),u.find("img.temp")[0].setAttribute("style","position: absolute; width: 200px; top: 50%; left: calc(50% - 100px); transform: rotate(-30deg);"),u.find("body")[0].removeAttribute("style","height: 868px;background-size: 90%;"),$("#iframe_templateViewInvoice")[0].removeAttribute("style","width: 1100px;height: 868px;")));LoadingHide()})}):(console.log("Load repeat..."),o())},300)};e?(f.attr("src",s+e),o(),n.isChonseType=!1):(n.isChonseType=!0,r(function(){$("select.cb-select-time").selectpicker()}));n.ApplyInvoiceType=function(t){e=t;f.attr("src",s+e);o();n.isChonseType=!1};n.SaveTemplate=function(i){var r,f,o;LoadingShow();r={};t.EditingTemplate&&(r.FORMCODE=t.EditingTemplate.FORMCODE,r.SYMBOLCODE=t.EditingTemplate.SYMBOLCODE,r.FROMNUMBER=t.EditingTemplate.FROMNUMBER,r.TONUMBER=t.EditingTemplate.TONUMBER);n.SizePaper.value==="2"&&(n.template.style.body["background-size"]="70%",n.template.style.body.height="720px");n.template.CSS=h(n.template.style);n.template.TAXRATE=n.InvoiceType.value;t.Enterprise.ISFREETRIAL===!0&&(n.template.STATUS=$("#txtNumberStatus").val());f=c+"SaveTemplate";o=JSON.stringify({objNumberBO:n.template,templateFile:e,editingTemplate:r});u.PostDataAjax(f,o,function(n){n?(n.rs?typeof i=="function"?i(n):alert("Lưu thành công!"):alert(n.msg),LoadingHide()):(alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetInvoice"),LoadingHide())})};n.SaveExport=function(){var t="A4";n.SizePaper.value==="2"&&(t="A5");n.SaveTemplate(function(n){var r="/TempInvoice/Downloadfile/?link="+n.outputTemplate+"&pageSize="+t,i=document.createElement("a");i.href=r;i.target="_blank";document.body.appendChild(i);i.click();document.body.removeChild(i)})};n.uploadFile=function(t){var u,i,e,f;for(n.isLoading=!0,u=t.target.files,i=0;i<u.length;i++)e=u[i],f=new FileReader,f.onload=function(t){r(function(){n.template.logo=t.target.result;n.ChangeLogo(n.template.logo)},100)},f.readAsDataURL(e)};n.uploadBackground=function(t){var u,i,e,f;for(n.isLoading=!0,u=t.target.files,i=0;i<u.length;i++)e=u[i],f=new FileReader,f.onload=function(t){r(function(){n.template.bg=t.target.result;n.SetBackground(n.template.bg,"auto")},100)},f.readAsDataURL(e)};n.$watch("template.style",function(){if(n.template){var t=h(n.template.style);f.contents().find("style").text(t)}},!0);n.ChangeFontSize=function(){n.template.style["body, table"]["font-size"]=n.template.fontSize};n.ChangeFontFamily=function(){n.template.style["body, table"]["font-family"]=n.template.fontFamily};n.ChangeColor=function(t){n.template.style["body, table"].color=t+" !important"};n.SetBorderColor=function(t){n.template.style["#layer1"]["border-color"]=t;n.template.borderWidth==="0px"&&(n.template.borderWidth="3px",n.template.style["#layer1"]["border-width"]=n.template.borderWidth)};n.SetBorderRadius=function(){n.template.style["#layer1"]["border-radius"]=n.template.borderRadius};n.SetBorderWidth=function(){n.template.style["#layer1"]["border-width"]=n.template.borderWidth;n.template.style["#layer1"]["border-color"]==="#fff"&&(n.template.style["#layer1"]["border-color"]="#000")};n.SetBorderPattern=function(t){n.template.style["#layer1"]["background-image"]=t!=null&&t!=""?"url('"+t+"')":"none"};n.ChangeSerialNo=function(){f.contents().find("#symbol_invoice_template").html(n.template.SYMBOLCODE)};n.ChangeForm=function(){n.template.FORMCODE=n.template.CODE.length==1?n.template.FORM+"00"+n.template.CODE:n.template.CODE.length==2?n.template.FORM+"0"+n.template.CODE:n.template.FORM+n.template.CODE;f.contents().find("#form_invoice_template").html(n.template.FORMCODE)};n.ShowAgainCode=function(){n.template.CODE.length==1?n.template.CODE="00"+n.template.CODE:n.template.CODE.length==2&&(n.template.CODE="0"+n.template.CODE)};n.ChangeLogo=function(t){t!=null&&t!=""?(n.template.style[".logo"]["background-image"]="url('"+t+"')",n.template.style[".logo"].display="block"):n.RemoveLogo()};n.RemoveLogo=function(){n.template.logo=null;n.template.style[".logo"]["background-image"]="none";n.template.style[".logo"].display="none";$('[type="file"]').val("")};n.SetBackground=function(t,i){t===""?(n.template.style.body["background-image"]="none",n.template.bg=null,$('[type="file"]').val("")):n.template.style.body["background-image"]="url('"+t+"')";n.template.style.body["background-size"]=i!=null?i:"100% 100%"};n.LoadSizePaper=function(){parseInt(n.SizePaper.value)==1?($("#div-template-a4")[0].setAttribute("style","display:block;"),$("#div-template-a5")[0].setAttribute("style","display:none;")):($("#div-template-a4")[0].setAttribute("style","display:none;"),$("#div-template-a5")[0].setAttribute("style","display:block;"))};$('[data-toggle="tooltip"]').tooltip({content:function(){return $(this).prop("title")},position:{my:"center top+15",at:"left bottom"}})}]);app.controller("ReceiptController",["$scope","$rootScope","$timeout","CommonFactory","$location","$window",function(n,t,i,r,u,f){var e="/Receipt/";angular.element(function(){n.LoadDashboard()});n.LoadCookie_Receipt=function(){var t=getCookie("Novaon_ReceiptManagement");t?n.cookie=JSON.parse(t):(n.cookie={FieldID:!0,FieldBillDate:!0,FieldBillType:!0,FieldCustomer:!0,FieldFormCode:!0,FieldSymbolCode:!0,FieldNumber:!0,FieldInvoiceStatus:!0,FieldReferenceCode:!0,FieldPaymentStatus:!1,FieldTotalPayment:!0,FieldCustomerID:!0,RowNum:10},setCookie("Novaon_ReceiptManagement",JSON.stringify(n.cookie),30))};n.Check=function(t,i){(n.cookie[i]=i=="RowNum"?t:!t,setCookie("Novaon_ReceiptManagement",JSON.stringify(n.cookie),30),i=="RowNum")&&n.GetReceiptPaging(n.currentpage)};t.Tab={All:!0,Cancel:!1,Tranfer:!1,Change:!1,Replace:!1};t.ReceiptTabClick=function(t){n.Tab.All=!1;n.Tab.Cancel=!1;n.Tab.Tranfer=!1;n.Tab.Change=!1;n.Tab.Replace=!1;n.Filter={};n.ListReceipt=[];switch(t){case 1:n.Tab.All=!0;n.Filter={};n.GetReceiptPaging(1);break;case 2:n.Tab.Cancel=!0;n.Filter={};n.GetReceiptByStatus(INVOICE_TYPE.Cancel_Invoice,1,REPORT_TYPE.Cancel);break;case 3:n.Tab.Tranfer=!0;n.Filter.INVOICETYPE=4;n.GetReceiptPaging(1);break;case 4:n.Tab.Change=!0;n.Filter={};n.GetReceiptByStatus(INVOICE_TYPE.Modifield_Invoice,1,REPORT_TYPE.Change);break;case 5:n.Tab.Replace=!0;n.Filter={};n.GetReceiptByStatus(INVOICE_TYPE.Replace_Invoice,1,REPORT_TYPE.Cancel);break;default:n.Tab.All=!0}$(".dropdown-menu").removeClass("show")};t.ReloadReceipt=function(){u.path().toString().includes("/bien-lai-thu-phi-le-phi")&&(n.Tab.Cancel?n.GetReceiptByStatus(INVOICE_TYPE.Cancel_Invoice,1,REPORT_TYPE.Cancel):(n.ListReceipt=[],n.GetReceiptPaging(n.currentpage)))};n.GetReceiptPaging=function(t){var o,s,i,f,u;n.Filter||(n.Filter={});n.Filter.TIME=="5"&&(n.Filter.TIME=n.FROMTIME+";"+n.TOTIME,n.FROMTIME&&n.TOTIME||(n.Filter.TIME=n.Timepickers.Options[0].value));n.LoadCookie_Receipt();t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;o=e+"GetReceiptPaging";s=JSON.stringify({form:n.Filter,currentPage:n.currentpage,itemPerPage:n.cookie.RowNum});n.ListReceipt=[];n.TotalPages=1;n.TotalRow=1;LoadingShow();r.PostDataAjax(o,s,function(t){t?t.rs?(n.ListReceipt=t.result,n.TotalPages=t.TotalPages,n.TotalRow=t.TotalRow):n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetReceiptPaging");LoadingHide()});n.IsLoading=!1;n.FilterApply=[];for(i in n.Filter)n.Filter[i]!=null&&(f={key:i,value:n.Filter[i]},i=="INVOICESTATUS"&&(u=n.ListReceiptStatus.filter(function(t){return t.INVOICESTATUSID==n.Filter[i]}),f.value=u[0].INVOICESTATUS),i=="TIME"&&(u=n.Timepickers.Options.filter(function(t){return t.value==n.Filter[i]}),u.length>0&&(f.value=u[0].TIME)),i=="FORMCODE"&&(u=n.ListFormCode.filter(function(t){return t.FORMCODE==n.Filter[i]}),f.value=u[0].FORMCODE),i=="PAYMENTSTATUS"&&(u=n.ListPaymentStatus.filter(function(t){return t.PAYMENTSTATUS==n.Filter[i]}),f.value=u[0].PAYMENTSTATUS),i=="SYMBOLCODE"&&(u=n.ListSymbolCode.filter(function(t){return t.SYMBOLCODE==n.Filter[i]}),f.value=u[0].SYMBOLCODE),n.FilterApply.push(f))};n.GetReceiptByStatus=function(t,i,u){var h,c,f,s,o;n.Filter||(n.Filter={});n.LoadCookie_Receipt();i||(i=1);i>n.TotalPages&&(i=n.TotalPages);n.currentpage=i;h=e+"GetReceiptByStatus";c=JSON.stringify({form:n.Filter,type:t,intpage:i,reportType:u});n.ListReceipt=[];n.TotalPages=1;n.TotalRow=1;LoadingShow();r.PostDataAjax(h,c,function(t){t?t.rs?(n.ListReceipt=t.result,n.TotalPages=t.TotalPages,n.TotalRow=t.TotalRow):n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetInvoice");LoadingHide()});n.FilterApply=[];for(f in n.Filter)n.Filter[f]!=null&&(s={key:f,value:n.Filter[f]},f=="TIME"&&(o=n.Timepickers.Options.filter(function(t){return t.value==n.Filter[f]}),s.value=o[0].TIME),f=="FORMCODE"&&(o=n.ListFormCode.filter(function(t){return t.FORMCODE==n.Filter[f]}),s.value=o[0].FORMCODE),f=="SYMBOLCODE"&&(o=n.ListSymbolCode.filter(function(t){return t.SYMBOLCODE==n.Filter[f]}),s.value=o[0].SYMBOLCODE),n.FilterApply.push(s))};n.RemoveFilter=function(i){for(var r in n.Filter)if(r==i.key){n.Filter[r]=null;break}t.ReloadReceipt()};n.SeleteRow=function(n,t,i){var r=n.filter(function(n){return n.ISSELECTED==!0});t?i=!1:r.length==n.length-1&&(i=!0)};n.Sign=function(n){LoadingShow();Sign(n)};n.LoadDashboard=function(){var t=e+"LoadDashboard",i=JSON.stringify({});r.PostDataAjax(t,i,function(t){t?t.rs&&(n.TotalMoneyNotPay=t.TotalMoneyNotPay,n.TotalMoneyPaied=t.TotalMoneyPaied,n.TotalMoneyNotApproval=t.TotalMoneyNotApproval,n.TotalInvoiceSigned=t.totalInvoiceSigned):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetProvince")})};$(".dropdown-menu").find("form").click(function(n){n.stopPropagation()});n.PreviewReferenceInvoice=function(n){window.open("NOVAON_FOLDER"+n+"?v="+(new Date).getTime())};t.PreviewInvoice=function(n,t){if(t===!1){var i=e+"CreateFilePdfToView",u=JSON.stringify({invoiceId:n});LoadingShow();r.PostDataAjax(i,u,function(n){n&&n.rs?window.open("NOVAON_FOLDER"+n.msg+"?v="+(new Date).getTime()):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - PreviewInvoice");LoadingHide()})}else window.open("NOVAON_FOLDER"+n+"?v="+(new Date).getTime())};n.PreviewModifiedReport=function(n){window.open("NOVAON_FOLDER"+n.MODIFIEDLINK+"?v="+(new Date).getTime())};n.PreviewCancelReport=function(n){window.open("NOVAON_FOLDER"+n.CANCELLINK+"?v="+(new Date).getTime())};n.ConvertInv=function(i){var o=confirm("Sau khi chuyển sang hóa đơn chuyển đổi. Hóa đơn chỉ được phép in một lần duy nhất. Bạn có thực sự muốn chuyển đổi hóa đơn ?"),u,f;o&&(n.IsLoading=!0,u=e+"UpdateConvertInvoice",f=JSON.stringify({invoice:i}),r.PostDataAjax(u,f,function(n){n?n.rs?(alert("Thành công!"),t.ReloadReceipt()):alert(n.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js)")}),n.IsLoading=!1)};t.ReloadGetNumber=function(){n.GetNumber(n.FormNumber.CURRENTPAGE)};n.GetNumber=function(t){n.FormNumber={};t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.FormNumber.ITEMPERPAGE=10;n.FormNumber.CURRENTPAGE=t;var i=e+"GetNumber",u=JSON.stringify({form:n.FormNumber});LoadingShow();n.ListNumber=[];r.PostDataAjax(i,u,function(t){t?t.rs?(n.ListNumber=t.result,n.TotalPages=t.TotalPages,n.TotalRow=t.TotalRow):alert(t.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetNumber");LoadingHide()})};n.SendEmail=function(t){n.IsLoading=!0;var i=e+"SendEmail",u=JSON.stringify({invoice:t});LoadingShow();r.PostDataAjax(i,u,function(n){n?n.rs?alert(n.msg):alert(n.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SendEmail");LoadingHide()});n.IsLoading=!1};n.uploadFile=function(n){var t,e,r,u,f;if(LoadingShow(),$("#div-file-active").show(),t=n.target.files,e=CheckFile(t),e)for(r=0;r<t.length;r++)u=t[r],f=new FileReader,f.onloadend=function(n){i(function(){var t=n.target.result.split(",")[1];$("#file-selected").append('<span class="has-tag-attment-file" name = "'+u.name+'" rel= "'+t+'" onclick="DeleteFile(this)">'+u.name+'<img src="/Images/close.png"><\/span>');LoadingHide()},100)},f.readAsDataURL(u);else LoadingHide()};n.ConfirmChange=function(n){if(n.IDTEMP>0){var i=function(t){if(!t)return!1;window.open("NOVAON_FOLDER"+n.SIGNLINKTEMP)};return confirm("Hóa đơn này đã được lập hóa đơn điều chỉnh. Bạn có muốn xem hóa đơn điều chỉnh đã lập không?","Hóa đơn điều chỉnh","Không","Xem hóa đơn",i),!1}t.ModalReceipt(n,2);$(".modal-receipt").modal("show")};n.CancelInvoiceConfirm=function(n){if(n.CANCELREASON!=null&&n.CANCELREASON.trim()!="")t.ModalCancelInvoice(n),$(".modal-cancel-invoice").modal("show");else{var i=function(i){i?(t.IsUpdateCancelReport=!1,t.ModalCancelReport(null,n),$(".modal-cancel-report").modal("show")):(t.ModalCancelInvoice(n),$(".modal-cancel-invoice").modal("show"))};confirm("Bạn có muốn lập biên bản hủy cho hóa đơn này không?","Hóa đơn xóa bỏ","Không","Có",i)}};n.ReplaceInvoiceConfirm=function(n){var f=n.NUMBER,r=n.FORMCODE,u=n.SYMBOLCODE,i;n.INVOICETYPE==3?n.IDTEMP>0&&n.IDTEMP>n.ID?(i=function(t){if(!t)return!1;window.open("NOVAON_FOLDER"+n.SIGNLINKTEMP)},confirm("Hóa đơn <strong><"+r+" - "+u+" - "+("0000000"+f).slice(-7)+"><\/strong> đã được lập hóa đơn thay thế <strong><"+r+" - "+u+" - Chưa cấp số><\/strong>. Bạn có muốn xem không?","Hóa đơn thay thế","Không","Có",i)):(t.ModalReceipt(n,6),$(".modal-receipt").modal("show")):(i=function(i){if(i)t.ModalCancelInvoice(n),$(".modal-cancel-invoice").modal("show");else return!1},confirm("Để lập được hóa đơn thay thế cho hóa đơn <strong><"+r+" - "+u+" - "+("0000000"+f).slice(-7)+"><\/strong> bạn cần thực hiện xóa bỏ hóa đơn này trước. Bạn có muốn thực hiện xóa bỏ hóa đơn không?","Hóa đơn xóa bỏ","Không","Có",i))};n.ModifiedInvoiceConfirm=function(n){var i;if(n.CHANGEREASON!=null&&n.CHANGEREASON.trim()!=""){if(n.IDTEMP>0)return i=function(t){if(!t)return!1;window.open("NOVAON_FOLDER"+n.SIGNLINKTEMP)},confirm("Hóa đơn này đã được lập hóa đơn điều chỉnh. Bạn có muốn xem hóa đơn điều chỉnh đã lập không?","Hóa đơn điều chỉnh","Không","Xem hóa đơn",i),!1;t.ModalReceipt(n,5);$(".modal-receipt").modal("show")}else if(i=function(i){if(i)t.IsUpdateModifiedReport=!1,t.ModalModifiedReport(null,n),$(".modal-modified-report").modal("show");else{if(n.IDTEMP>0){var r=function(t){if(!t)return!1;window.open("NOVAON_FOLDER"+n.SIGNLINKTEMP)};return confirm("Hóa đơn này đã được lập hóa đơn điều chỉnh. Bạn có muốn xem hóa đơn điều chỉnh đã lập không?","Hóa đơn điều chỉnh","Không","Xem hóa đơn",r),!1}t.ModalReceipt(n,5);$(".modal-receipt").modal("show")}},n.ISEXISTMODIFIEDREPORT!="1")confirm("Bạn có muốn lập biên bản điều chỉnh cho hóa đơn này không?","Hóa đơn điểu chỉnh","Không","Có",i);else{if(n.IDTEMP>0)return i=function(t){if(!t)return!1;window.open("NOVAON_FOLDER"+n.SIGNLINKTEMP)},confirm("Hóa đơn này đã được lập hóa đơn điều chỉnh. Bạn có muốn xem hóa đơn điều chỉnh đã lập không?","Hóa đơn điều chỉnh","Không","Xem hóa đơn",i),!1;t.ModalReceipt(n,5);$(".modal-receipt").modal("show")}};n.OpenModalCancelReport=function(u){if(n.Report={},u.ISEXISTCANCELREPORT=="1"){t.IsUpdateCancelReport=!0;var f=e+"GetReportByInvoiceIdReportType",o=JSON.stringify({invoiceId:u.ID,reportType:u.ISEXISTCANCELREPORT});LoadingShow();r.PostDataAjax(f,o,function(t){t?t.rs?n.Report=t.result:alert(t.msg):(LoadingHide,alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetReportByInvoiceIdReportType"));LoadingHide()});i(function(){t.ModalCancelReport(n.Report,u);$(".modal-cancel-report").modal("show")},200)}else t.IsUpdateCancelReport=!1,i(function(){t.ModalCancelReport(n.Report,u);$(".modal-cancel-report").modal("show")},200)};n.OpenModalModifiedReport=function(u){if(n.Report={},u.ISEXISTMODIFIEDREPORT=="2"){t.IsUpdateModifiedReport=!0;var f=e+"GetReportByInvoiceIdReportType",o=JSON.stringify({invoiceId:u.ID,reportType:u.ISEXISTMODIFIEDREPORT});LoadingShow();r.PostDataAjax(f,o,function(t){t?(LoadingHide(),t.rs?n.Report=t.result:alert(t.msg)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetReportByInvoiceIdReportType");LoadingHide()});i(function(){t.ModalModifiedReport(n.Report,u);$(".modal-modified-report").modal("show")},200)}else t.IsUpdateModifiedReport=!1,i(function(){t.ModalModifiedReport(n.Report,u);$(".modal-modified-report").modal("show")},200)};n.DownloadReleaseDocument=function(n){var t=e+"DownloadReleaseDocument",i={numberBO:n},r=$.fileDownload(t,{httpMethod:"POST",data:i})};n.DownloadIssuedDocument=function(n){var t=e+"DownloadIssuedReleaseDocument",i={numberBO:n},r=$.fileDownload(t,{httpMethod:"POST",data:i})};n.DownloadReleaseInvoiceTemplate=function(n){var t=e+"DownloadReleaseInvoiceTemplate",r={numberBO:n},u=$.fileDownload(t,{httpMethod:"POST",data:r,prepareCallback:function(){LoadingShow()}});i(function(){LoadingHide()},3e3)};n.RemoveInvoice=function(i){var u=function(u){var f,s,o;if(!u)return!1;if(n.ListInvoiceChecked=[],i)n.ListInvoiceChecked.push(i);else{if(f=n.ListReceipt.filter(function(n){return n.ISSELECTED==!0}),f&&f.length===0){toastr.warning("Bạn chưa chọn hóa đơn cần xóa.");return}if(s=n.ListReceipt.filter(function(n){return n.INVOICESTATUS!==1&&n.ISSELECTED===!0}),s&&s.length>0){toastr.warning("Bạn không được xóa hóa đơn ở trạng thái <b style='color: #222;'>Đã phát hành<\/b>.");return}if(f&&Object.keys(f).length>0)for(o=0;o<f.length;o++)n.ListInvoiceChecked.push(f[o].ID)}var h=n.ListInvoiceChecked.join(";"),c=e+"RemoveInvoice",l=JSON.stringify({idInvoices:h});LoadingShow();r.PostDataAjax(c,l,function(n){n&&n.rs?(toastr.success(n.msg),t.ReloadReceipt()):toastr.warning(n.msg);LoadingHide()})};confirm("Bạn có thực sự muốn xóa các Hóa đơn đã chọn không?","Thông báo","Không","Có",u)};n.ModalSendEmail=function(t){$("#modal_send_email").dialog({width:"45%",modal:!0,resizable:!1,show:{effect:"drop",direction:"right",duration:300},hide:{effect:"fade",duration:200},create:function(){$("#modal_send_email").show()}});$("#file-selected").html("");n.GetEmailHistory(t.ID);n.Invoice={};angular.copy(t,n.Invoice);n.Invoice={};angular.copy(t,n.Invoice)};n.SendEmail=function(){var u,i,o,c;if(!n.Invoice.RECIEVEREMAIL)return alert("Vui nhập vào email người nhận!!"),!1;for(u=n.Invoice.RECIEVEREMAIL.split(","),i=0;i<u.length;i++)if(!validation.isEmailAddress(u[i].trim()))return alert("Email bạn nhập không đúng định dạng email: "+u[i+1]),!1;n.Invoice.CUSBUYER=n.Invoice.RECIEVERNAME;n.Invoice.CUSEMAIL=n.Invoice.RECIEVEREMAIL;var s=[],h=[],f=$("#file-selected .has-tag-attment-file");if(f.length>0)for(i=0;i<f.length;i++)h.push(f[i].getAttribute("rel")),s.push(f[i].getAttribute("name"));o="";o=n.Invoice.INVOICETYPE===3?e+"SendCancelEmail":e+"SendEmail";c=JSON.stringify({invoice:n.Invoice,imgBase64:JSON.stringify(h),fileNames:s.join(";")});LoadingShow();r.PostDataAjax(o,c,function(i){i?i.rs?(alert(i.msg),$("#modal_send_email").dialog("close"),t.ReloadReceipt()):(n.ErrorMessage=i.msg,alert(i.msg)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SendEmail");LoadingHide()});n.IsLoading=!1};n.CurrentItem={};n.EditTemplate=function(n){t.EditingTemplate=n;document.location.href="/#/mau-hoa-don/"+btoa(n.TEMPLATEPATH)};$("#frmUploadFileReport").fileupload({autoUpload:!1,add:function(r,u){var f,u,o;LoadingShow();f=new FormData;u=u.files[0];f.append("file0",u);f.append("currentItem",n.CurrentItem.ID);f.append("comTaxCode",n.CurrentItem.COMTAXCODE);o=e+"UploadFileReport";$.ajax({type:"POST",url:o,contentType:!1,processData:!1,data:f,success:function(r){i(function(){r.rs?(n.CurrentItem.ATTACHMENTFILELINK=r.id,t.ReloadReceipt(),alert("Thành công")):alert(r.msg);LoadingHide()},10)},error:function(){alert("Lỗi không thể tải lên file: "+u.name);LoadingHide()}})}});n.DownloadFileReport=function(n){var t=e+"DownloadFileReport",i={invoiceId:n.ID},r=$.fileDownload(t,{httpMethod:"POST",data:i})};n.RemoveFileReport=function(i){var u=e+"RemoveFileReport",f=JSON.stringify({invoice:i});LoadingShow();r.PostDataAjax(u,f,function(i){i?i.rs?(alert(i.msg),t.ReloadReceipt()):n.ErrorMessage=i.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SendEmail");LoadingHide()})};n.ExportExcel=function(){var t=getCookie("Novaon_ReceiptManagement"),i=e+"ExportExcell",r={form:n.Filter,currentPage:1,fieldsCookies:t};$.fileDownload(i,{httpMethod:"POST",data:r})};n.GetEmailHistory=function(t){n.ListEmailHistory=[];var i=e+"GetEmailHistoryByInvoiceId",u=JSON.stringify({id:t});LoadingShow();r.PostDataAjax(i,u,function(t){t?t.rs?n.ListEmailHistory=t.result:n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetEmailHistory");LoadingHide()})};LoadingHide();n.SetDatepikerFromTime=function(){$("#pk_fromtime").datepicker({dateFormat:"yy-mm-dd",maxDate:new Date});SetVietNameInterface($("#pk_fromtime"))};n.SetDatepikerToTime=function(){var t=n.FROMTIME;$("#pk_totime").datepicker("option","minDate",t);$("#pk_totime").datepicker({dateFormat:"yy-mm-dd",minDate:new Date(t)});SetVietNameInterface($("#pk_totime"))};n.column="NUMBER";n.reverse=!1;n.sortColumn=function(t){n.column=t;n.reverse?(n.reverse=!1,n.reverseclass="arrow-up_h"):(n.reverse=!0,n.reverseclass="arrow-down_h")};n.sortClass=function(t){return n.column==t?n.reverse?"arrow-down_h":"arrow-up_h":""};f.ReloadInvoice=function(){t.ReloadReceipt()}}]);app.controller("ModalReceiptController",["$scope","$rootScope","$timeout","$sce","CommonFactory","$filter","$http","$location",function(n,t,i,r,u,f,e,o){var h="/Receipt/",s;t.ModalReceipt=function(r,u,e,o,s){if(n.TYPECHANGE=u,n.Invoice={},n.Invoice.LISTPRODUCT=[],n.Invoice.INVOICETYPE=u,n.IsCopy=!1,n.ONLYTAXRATE=n.TaxRateList[0].value,n.Invoice.CURRENCY="VND",n.Invoice.EXCHANGERATE=1,$(".modal-receipt").modal("show"),u==1)n.Invoice.ID=0,n.Invoice.CUSPAYMENTMETHOD="TM/CK",i(function(){n.Invoice.FORMCODE=t.ListFormCode[0].FORMCODE;n.Invoice.SYMBOLCODE=t.ListSymbolCode[0].SYMBOLCODE;n.TAXRATE=t.ListSymbolCode[0].TAXRATE;n.Invoice.DISCOUNTTYPE="KHONG_CO_CHIET_KHAU"}),r?(angular.copy(r,n.Invoice),s&&(n.Invoice.INVOICESTATUS=1,n.Invoice.NUMBER=0,n.Invoice.ID=0,n.Invoice.INVOICETYPE=u,n.Invoice.REFERENCE=0,n.Invoice.EXCHANGERATE=n.Invoice.EXCHANGERATE.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),n.IsCopy=s)):n.Invoice.NUMBER=0,e&&o&&(n.Invoice.FORMCODE=e,n.Invoice.SYMBOLCODE=o,n.Invoice.NUMBER=0,n.Invoice.INVOICESTATUS=1,n.Invoice.INVOICETYPE=1,n.Invoice.ISINVOICEWAITING=!0);else if(u==2){var h=t.ListSymbolCode.filter(function(n){return n.SYMBOLCODE==r.SYMBOLCODE});n.TAXRATE=h[0].TAXRATE;r.EXCHANGERATE=r.EXCHANGERATE.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");(r.INVOICETYPE==5||r.INVOICETYPE==3||r.INVOICETYPE==6)&&(r.SIGNEDTIME=r.SIGNEDTIMETEMP);angular.copy(r,n.Invoice)}else u==5?(angular.copy(r,n.Invoice),n.Invoice.INVOICESTATUS=1,n.Invoice.NUMBER=0,n.Invoice.ID=0,n.Invoice.INVOICETYPE=u,n.Invoice.REFERENCE=r.ID,n.Invoice.NUMBERTEMP=r.NUMBER,n.Invoice.LISTPRODUCT=[]):u==6?(angular.copy(r,n.Invoice),n.Invoice.NUMBER=0,n.Invoice.ID=0,n.Invoice.INVOICESTATUS=1,n.Invoice.INVOICETYPE=u,n.Invoice.REFERENCE=r.ID,n.Invoice.NUMBERTEMP=r.NUMBER):u==7;n.Invoice.STRDUEDATE=f("dateFormat")(n.Invoice.DUEDATE,"dd/MM/yyyy");n.Invoice.STRINVOICEWAITINGTIME=f("dateFormat")(n.Invoice.INVOICEWAITINGTIME,"dd/MM/yyyy");ReadNumber(n.Invoice.TOTALPAYMENT)};n.AddReceipt=function(i){if(!n.Invoice.FORMCODE)return alert("Bạn cần chọn mẫu số."),!1;if(!n.Invoice.SYMBOLCODE)return alert("Bạn cần chọn ký hiệu."),!1;if(!n.Invoice.CUSID)return alert("Bạn cần nhập vào thông tin <b>Mã học sinh<\/b>."),!1;if(!n.Invoice.NOTE)return alert("Bạn cần nhập vào thông tin <b>Ghi chú<\/b>."),!1;if(!n.Invoice.CUSPAYMENTMETHOD)return alert("Vui lòng chọn hình thức thanh toán"),!1;if(n.Invoice.CUSEMAIL&&!validation.isEmailAddress(n.Invoice.CUSEMAIL)){alert("Vui lòng nhập đúng định dạng email");return}LoadingShow();var r=h+"AddReceipt",f=JSON.stringify({invoice:n.Invoice,type:i});u.PostDataAjax(r,f,function(n){n?n.rs?(toastr.options={timeOut:"2000"},toastr.success("Thêm mới thành công!"),$(".modal-receipt").modal("hide"),o.path().toString().includes("/bien-lai-thu-phi-le-phi")&&t.ReloadReceipt()):alert(n.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SaveAndSend");LoadingHide()})};n.UpdateReceipt=function(i){if(!n.Invoice.FORMCODE)return alert("Vui lòng chọn mẫu số hóa đơn"),$("select#form-code").focus(),!1;if(!n.Invoice.SYMBOLCODE)return alert("Vui lòng chọn mẫu số hóa đơn"),$("select#symbol-code").focus(),!1;if(!n.Invoice.CUSID)return alert("Bạn cần nhập vào thông tin <b>Mã học sinh<\/b>."),!1;if(!n.Invoice.NOTE)return alert("Bạn cần nhập vào thông tin <b>Ghi chú<\/b>."),!1;if(n.Invoice.CUSEMAIL&&!validation.isEmailAddress(n.Invoice.CUSEMAIL)){alert("Vui lòng nhập đúng định dạng email");return}if(!n.Invoice.CHANGEREASON&&n.Invoice.INVOICETYPE==5)return alert("Vui lòng nhập lý do điểu chỉnh"),!1;n.Invoice.EXCHANGERATE=n.Invoice.EXCHANGERATE.toString().replace(/\,/g,"");LoadingShow();var r=h+"UpdateReceipt",f=JSON.stringify({invoice:n.Invoice,type:i});u.PostDataAjax(r,f,function(n){n?n.rs?(toastr.options={timeOut:"2000"},toastr.success("Cập nhật thành công!"),$(".modal-receipt").modal("hide"),t.ReloadReceipt()):alert(n.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SaveAndSend");LoadingHide()})};n.SuggestCustomer=function(){var i=t.selectedCustomer;i&&(n.Invoice.CUSNAME=i.CUSNAME,n.Invoice.CUSADDRESS=i.CUSADDRESS,n.Invoice.CUSTAXCODE=i.CUSTAXCODE,n.Invoice.CUSID=i.CUSID,n.Invoice.CUSEMAIL=i.CUSEMAIL,n.Invoice.CUSBUYER=i.CUSBUYER)};n.ReadNumberToCurrencyWords=function(){var t=0,i,r;t=n.Invoice.TOTALPAYMENTRAW.toString()!="NaN"?n.Invoice.TOTALPAYMENTRAW:n.Invoice.TOTALPAYMENT;i=h+"ReadNumberToWords";r=JSON.stringify({kindOfMoney:n.Invoice.CURRENCY,number:t});u.PostDataAjax(i,r,function(t){t?t.rs?n.NumberToCurrencyWords=t.data:n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - ReadNumberToCurrencyWords")})};n.GetInvoice=function(){LoadingShow();var t=h+"GetInvoice",i=JSON.stringify({});LoadingShow();u.PostDataAjax(t,i,function(t){t?t.rs?n.ListInvoice=t.result:n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetInvoice");LoadingHide()})};n.SelectAll=function(){var t=n.ListInvoice.filter(function(t){return t.ISSELECTED==n.IsSelectAll});t.length>0&&t.forEach(function(t){t.ISSELECTED=!n.IsSelectAll})};n.SeleteRow=function(t){var i=n.ListInvoice.filter(function(n){return n.ISSELECTED==!0});t?n.IsSelectAll=!1:i.length==n.ListInvoice.length-1&&(n.IsSelectAll=!0)};n.oldTaxcode=null;n.LoadInfoByTaxcode=function(){if(n.Invoice.CUSTAXCODE!=n.oldTaxcode&&n.Invoice.CUSTAXCODE!=null&&n.Invoice.CUSTAXCODE!=""){var t="https://k8s.misa.com.vn/org-info/suggest?taxCode="+n.Invoice.CUSTAXCODE;$("#tempLoadTaxinfo").load(t,function(t){var r=JSON.parse(t);i(function(){r.data.companyName?(n.Invoice.CUSNAME=r.data.companyName,n.Invoice.CUSADDRESS=r.data.address):(alert("Không tìm thấy thông tin doanh nghiệp. Xin vui lòng kiểm tra lại mã số thuế nhập vào."),n.Invoice.CUSNAME=null,n.Invoice.CUSADDRESS=null)})})}else n.Invoice.CUSTAXCODE!=n.oldTaxcode&&(n.Invoice.CUSNAME=null,n.Invoice.CUSADDRESS=null)};n.TaxRateList=[{value:-1,name:"Không chịu thuế"},{value:0,name:"0%"},{value:5,name:"5%"},{value:10,name:"10%"}];n.ViewTaxcode=function(n){if(n){var t=new RegExp(/\d/,"gi"),i=new RegExp(/\S/,"gi");return n=n.replace(i,function(n){return n.match(t)?'<span class="taxcode-symbol">'+n+"<\/span>":'<span class="taxcode-space">'+n+"<\/span>"}),r.trustAsHtml(n)}};n.ChangeDiscountType=function(){n.Invoice.DISCOUNTTYPE=="KHONG_CO_CHIET_KHAU"&&n.Invoice.LISTPRODUCT.forEach(function(n){n.DISCOUNTRATE=0})};n.GetNumber=function(){n.FormNumber={};n.FormNumber.FORMCODE=n.Number.FORMCODE;n.FormNumber.SYMBOLCODE=n.Number.SYMBOLCODE;var t=h+"GetNumber",i=JSON.stringify({form:n.FormNumber});LoadingShow();u.PostDataAjax(t,i,function(t){if(t)if(t.rs){let i=t.result[0];n.Number.CURRENTNUMBER=i.CURRENTNUMBER;n.Number.FROMNUMBER=i.CURRENTNUMBER+1}else n.ErrorMessage=t.msg;else alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetNumberaa");LoadingHide()})};n.ExchangeRateFormat=function(){$("#exchangeRateInput").on("keyup",function(){if($(this).val()!="NaN"){var n=parseInt($(this).val().replace(/\D/g,""),10);$(this).val(n.toLocaleString().replace(".",","))}else $(this).val(1)})};n.SymbolCodeChange=function(i){n.GLOBALTAXRATE=0;n.TAXRATE=0;n.CalMoneyAfterChangeValue();var r=t.ListSymbolCode,u=r.filter(function(n){return n.SYMBOLCODE===i});n.TAXRATE=u[0].TAXRATE;n.ONLYTAXRATE=n.TaxRateList[0].value};s=new Date;n.CurrentDay=s.getDate();n.CurrentMonth=s.getMonth()+1;n.CurrentYear=s.getFullYear();n.CurrentDate=s.getDate()+"/"+(s.getMonth()+1)+"/"+s.getFullYear()}]);Number.prototype.formatMoney=function(n,t,i){var u=this,n=isNaN(n=Math.abs(n))?2:n,t=t==undefined?".":t,i=i==undefined?",":i,e=u<0?"-":"",f=String(parseInt(u=Math.abs(Number(u)||0).toFixed(n))),r=(r=f.length)>3?r%3:0;return e+(r?f.substr(0,r)+i:"")+f.substr(r).replace(/(\d{3})(?=\d)/g,"$1"+i)+(n?t+Math.abs(u-f).toFixed(n).slice(2):"")};app.controller("ModalMeterController",["$scope","$rootScope","$timeout","CommonFactory",function(n,t,i,r){var u="/Meter/";t.ModalMeter=function(i,r){t.Enterprise||t.GetEnterpriseInfo();n.TYPECHANGE=r;n.APARTMENTNO=n.ApartmentnoList[0].value;n.Meter={};r==1?(n.Meter={},typeof i=="string"&&(n.Meter.METERNAME=i)):r==2?angular.copy(i,n.Meter):r==3&&(angular.copy(i,n.Meter),n.Meter.ID=0)};t.ModalAddMeter=function(i){n.GetListProducts();n.Meter={};typeof i=="string"&&(n.Meter.METERNAME=i);n.Meter.CUSTAXCODE=t.Customercode};n.AddMeter=function(t){var i,f;if(!n.Meter.CUSTAXCODE)return alert("Bạn cần nhập MST của khách hàng."),!1;if(!n.Meter.METERNAME)return alert("Bạn cần nhập tên công tơ."),!1;if(!n.Meter.PRODUCTCODELIST)return alert("Bạn chưa chọn biểu giá điện."),!1;n.IsLoading=!0;i=u+"AddMeter";n.Meter.PRODUCTCODELIST=n.Meter.PRODUCTCODELIST.join(",");f=JSON.stringify({meter:n.Meter});LoadingShow();r.PostDataAjax(i,f,function(i){i?i.rs?t===1?(toastr.options={timeOut:"2000"},toastr.success("Thêm mới thành công!"),$(".modal-add-meter").modal("hide")):t==3?(toastr.options={timeOut:"2000"},toastr.success("Sao chép thành công!"),$(".modal-add-meter").modal("hide")):n.Meter.METERNAME=null:n.ErrorMessage=i.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - AddMeter");LoadingHide()})};n.GetListProducts=function(){LoadingShow();var u=JSON.stringify({comtaxcode:t.Enterprise.COMTAXCODE});r.PostDataAjax("/Product/GetListProductByComtaxCode",u,function(t){t?t.rs?($(".selectpicker").selectpicker({}),n.ListProducts=t.msg,i(function(){$(".selectpicker").selectpicker("refresh")},1e3)):n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetListProducts")});LoadingHide()};n.UpdateMeter=function(){if(!n.Meter.CUSTAXCODE)return alert("Bạn cần nhập MST của khách hàng."),!1;if(!n.Meter.METERNAME)return alert("Bạn cần nhập tên công tơ."),!1;var i=u+"UpdateMeter",f=JSON.stringify({meter:n.Meter});LoadingShow();r.PostDataAjax(i,f,function(i){i?i.rs?(toastr.options={timeOut:"2000"},toastr.success("Cập nhật thành công!"),$(".modal-add-meter").modal("hide"),t.ReloadMeter()):n.ErrorMessage=i.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - UpdateMeter");LoadingHide()})};n.ApartmentnoList=[{value:0,name:"Không chọn"},{value:1,name:"1"},{value:2,name:"2"}]}]);app.controller("MeterController",["$scope","$rootScope","$timeout","CommonFactory","persistObject",function(n,t,i,r){var u="/Meter/";LoadingShow();n.LoadCookie_Meter=function(){var t=getCookie("Novaon_MeterManagement");t?n.cookie=JSON.parse(t):(n.cookie={FieldID:!0,FieldCode:!0,FieldMeterName:!0,FieldCustaxCode:!0,FieldComtaxCode:!0,FieldProductCode:!0,FieldIsactive:!0,RowNum:10},setCookie("Novaon_MeterManagement",JSON.stringify(n.cookie),30))};n.Check=function(t,i){(n.cookie[i]=i=="RowNum"?t:!t,setCookie("Novaon_MeterManagement",JSON.stringify(n.cookie),30),i=="RowNum")&&n.GetMeter(n.currentpage)};n.Filter={KEYWORD:"",PRODUCTTYPE:0,CATEGORY:null};t.ReloadMeter=function(t){t==1&&(n.currentpage=t);n.GetMeter(n.currentpage)};n.ResetGetMeter=function(){n.LoadCookie_Meter();n.ListMeter=[]};n.GetMeter=function(t){n.ResetGetMeter();n.IsLoading=!0;t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;n.IsLoading=!0;var i=u+"GetMeter",f=JSON.stringify({form:n.Filter,currentPage:t,itemPerPage:n.cookie.RowNum});n.ListMeter=[];n.TotalPages=1;n.TotalRow=1;LoadingShow();r.PostDataAjax(i,f,function(t){t?t.rs?(n.ListMeter=t.result,n.TotalPages=t.TotalPages,n.TotalRow=t.TotalRow):n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - MeterController - GetMeter");LoadingHide()})};n.UpdateType=function(){var i,f,e,o;if(n.ChangeType){if(i=n.ListMeter.filter(function(n){return n.ISSELECTED==!0}),i.length==0){alert("Vui lòng chọn ít nhất 1 dòng");n.ChangeType=null;return}f=confirm("Chuyển sang loại "+n.ChangeType);f?(e=u+"ChangeProductType",o=JSON.stringify({meter:n.ListMeter,meterType:n.ChangeType}),LoadingShow(),r.PostDataAjax(e,o,function(i){i?i.rs?t.ReloadMeter():(n.ChangeType=null,alert(i.msg)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - MeterController - UpdateType")}),LoadingHide()):n.ChangeType=null}};n.ExportExcel=function(){var t,i,r,f;t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;i=u+"ExportExcell";r={keyword:n.Filter.KEYWORD,productType:n.Filter.PRODUCTTYPE,category:n.Filter.CATEGORY,currentPage:t,itemPerPage:n.cookie.RowNum};LoadingShow();f=$.fileDownload(i,{httpMethod:"POST",data:r});LoadingHide()};n.SelectAll=function(){var t=n.ListMeter.filter(function(t){return t.ISSELECTED==n.IsSelectAll});t.length>0&&t.forEach(function(t){t.ISSELECTED=!n.IsSelectAll})};n.SeleteRow=function(t){var i=n.ListMeter.filter(function(n){return n.ISSELECTED==!0});t?n.IsSelectAll=!1:i.length==n.ListMeter.length-1&&(n.IsSelectAll=!0)};n.ToggleShowMore=function(n){$(n).fadeToggle(300)};$(".dropdown-menu").find("form").click(function(n){n.stopPropagation()});n.RemoveMeter=function(i){var f=function(f){var e,o;if(!f)return!1;if(n.ListMeterChecked=[],i)n.ListMeterChecked.push(i.CODE);else{if(e=n.ListMeter.filter(function(n){return n.ISSELECTED==!0}),e&&e.length===0){alert("Bạn chưa chọn công tơ  cần xóa.");return}if(e&&Object.keys(e).length>0)for(o=0;o<e.length;o++)n.ListMeterChecked.push(e[o].CODE)}var s=n.ListMeterChecked.join(";"),h=u+"RemoveMeter",c=JSON.stringify({metercode:s});LoadingShow();r.PostDataAjax(h,c,function(n){n&&n.rs?(toastr.success(n.msg),t.ReloadMeter()):toastr.warning(n.msg);LoadingHide()})};confirm("Bạn có thực sự muốn xóa các công tơ đã chọn không?","Thông báo","Không","Có",f)}}]);app.controller("ModalMeterController",["$scope","$rootScope","$timeout","CommonFactory",function(n,t,i,r){var u="/Meter/";t.ModalMeter=function(i,r){t.Enterprise||t.GetEnterpriseInfo();n.TYPECHANGE=r;n.APARTMENTNO=n.ApartmentnoList[0].value;n.Meter={};r==1?(n.Meter={},typeof i=="string"&&(n.Meter.METERNAME=i)):r==2?angular.copy(i,n.Meter):r==3&&(angular.copy(i,n.Meter),n.Meter.ID=0)};t.ModalAddMeter=function(i){n.GetListProducts();n.Meter={};typeof i=="string"&&(n.Meter.METERNAME=i);n.Meter.CUSTAXCODE=t.Customercode};n.AddMeter=function(t){var i,f;if(!n.Meter.CUSTAXCODE)return alert("Bạn cần nhập MST của khách hàng."),!1;if(!n.Meter.METERNAME)return alert("Bạn cần nhập tên công tơ."),!1;if(!n.Meter.PRODUCTCODELIST)return alert("Bạn chưa chọn biểu giá điện."),!1;n.IsLoading=!0;i=u+"AddMeter";n.Meter.PRODUCTCODELIST=n.Meter.PRODUCTCODELIST.join(",");f=JSON.stringify({meter:n.Meter});LoadingShow();r.PostDataAjax(i,f,function(i){i?i.rs?t===1?(toastr.options={timeOut:"2000"},toastr.success("Thêm mới thành công!"),$(".modal-add-meter").modal("hide")):t==3?(toastr.options={timeOut:"2000"},toastr.success("Sao chép thành công!"),$(".modal-add-meter").modal("hide")):n.Meter.METERNAME=null:n.ErrorMessage=i.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - AddMeter");LoadingHide()})};n.GetListProducts=function(){LoadingShow();var u=JSON.stringify({comtaxcode:t.Enterprise.COMTAXCODE});r.PostDataAjax("/Product/GetListProductByComtaxCode",u,function(t){t?t.rs?($(".selectpicker").selectpicker({}),n.ListProducts=t.msg,i(function(){$(".selectpicker").selectpicker("refresh")},1e3)):n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetListProducts")});LoadingHide()};n.UpdateMeter=function(){if(!n.Meter.CUSTAXCODE)return alert("Bạn cần nhập MST của khách hàng."),!1;if(!n.Meter.METERNAME)return alert("Bạn cần nhập tên công tơ."),!1;var i=u+"UpdateMeter",f=JSON.stringify({meter:n.Meter});LoadingShow();r.PostDataAjax(i,f,function(i){i?i.rs?(toastr.options={timeOut:"2000"},toastr.success("Cập nhật thành công!"),$(".modal-add-meter").modal("hide"),t.ReloadMeter()):n.ErrorMessage=i.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - UpdateMeter");LoadingHide()})};n.ApartmentnoList=[{value:0,name:"Không chọn"},{value:1,name:"1"},{value:2,name:"2"}]}]);app.controller("ModalImportMeterController",["$scope","$rootScope","$timeout","CommonFactory",function(n,t,i,r){var u="/Meter/";t.Enterprise||t.GetEnterpriseInfo();angular.element(function(){n.Import={};n.ListMap={};n.Import.HeaderRow=1;n.Import.ShowSelectSheetAndHeader=!1});n.ShowStepThree=function(){n.stepOne=!1;n.stepTwo=!1;n.stepThree=!0};n.ResetAllStep=function(){n.stepOne=!0;n.stepTwo=!1;n.stepThree=!1;n.ListData=null;n.IsDiffent=!0};t.ModalImportMeter=function(){};n.ImportMeterFromExcel=function(){$("#fileUploadMeter").trigger("click")};$("#frmImportMeter").fileupload({autoUpload:!1,add:function(t,r){var e,f,o;if(!r.files[0].type.match("image.*")){if(e=CheckFile(r.files),!e)return!1;LoadingShow();f=new FormData;f.append("file0",r.files[0]);o=u+"ReadFileExcel";$.ajax({type:"POST",url:o,contentType:!1,processData:!1,data:f,success:function(t){i(function(){if(t.rs){n.Import.FileName=t.fileName;n.Import.ListSheets=JSON.parse(t.listSheet);n.Import.SelectedSheet=[n.Import.ListSheets[0]];var i=$("#ddlSheet");i.attr("value",n.Import.SelectedSheet.Index);n.Import.UploadMessage=t.reponseText;n.Import.ShowSelectSheetAndHeader=!0}else alert(t.msg);LoadingHide()})},error:function(){alert("Lỗi không thể đọc file excel.");LoadingHide()}})}}});n.ImportExcelMappingData=function(){if(n.listColumnError=[],!n.Import.FileName)return alert("Bạn chưa chọn file."),!1;if(!n.Import.SelectedSheet)return alert("Bạn chưa chọn sheet dữ liệu."),!1;if(!n.Import.HeaderRow)return alert("Bạn chưa chọn thứ tự dòng tiêu đề."),!1;var t=u+"MappingColumnExcel",f=JSON.stringify({selectedSheet:n.Import.SelectedSheet===undefined?0:n.Import.SelectedSheet[0].Index,headerRow:n.Import.HeaderRow});LoadingShow();r.PostDataAjax(t,f,function(t){t?t.rs?(n.ListData=t.data,i(function(){$(".selectpicker").selectpicker("refresh")},100),n.stepOne=!1,n.stepTwo=!0,n.ClientData=t.clientData,n.lstYourField=t.lstYourField):(n.ErrorMessage=t.msg,alert(t.msg)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SaveInvoiceList");LoadingHide()})};n.ImportExcelPreviewData=function(){var f=JSON.stringify(n.ListMap),t=n.ListData.filter(function(n){return n.YOURFIELD===null&&n.Required===!0}),e,r;if(t&&Object.keys(t).length>0&&$(t).each(function(t,i){n.ListMap[i.MYFIELD]||n.listColumnError.push(i.MYFIELD)}),n.listColumnError.length>0)return!1;e=JSON.stringify(n.ClientData);r=u+"PreviewMeterData";successCallback=function(t){n.ImportMeters=t.ListMeters;i(function(){n.stepThree=!0;n.stepTwo=!1},100)};AjaxRequest(r,{listMap:f},"POST",!0,"json",successCallback)};n.count=1;n.SaveMeterList=function(){n.ImportMeters||alert("Bạn chưa tải file lên. Vui lòng tải chọn file tải lên.");var t=u+"ImportDataMeter";successCallback=function(t){n.count==1&&(toastr.success(t.msg),i(function(){location.reload(!0)},4e3));n.count++};AjaxRequest(t,{},"POST",!0,"json",successCallback)}}]);app.controller("SettingTemplateController",["$scope","$rootScope","$routeParams","$timeout","CommonFactory","$sce",function(n,t,i,r,u,f){var c="/SettingTemplate/",e,s,h,o;LoadingShow();n.InvoiceType={value:"1",Options:[{value:"1",text:"Mẫu một thuế suất"},{value:"2",text:"Mẫu nhiều thuế suất"},{value:"3",text:"Hóa đơn bán hàng"},{value:"4",text:"Hóa đơn tiền điện"},{value:"5",text:"Hóa đơn tiền nước"},{value:"6",text:"Hóa đơn trường học"}]};e=0;t.Enterprise&&(e=t.Enterprise.USINGINVOICETYPE);s="1";h=[{value:"1",text:"Khổ giấy A4"},{value:"2",text:"Khổ giấy A5"}];(e===1||e===4)&&(s="2",h=[{value:"2",text:"Khổ giấy A5"}]);n.SizePaper={value:s,Options:h};o=function(){LoadingShow();r(function(){var n=$(".html-view-content").find("style").text();n!=null&&n!=""?$.parsecss(n,function(n){r(function(){var i=$("#form_invoice_template").text(),u=$("#symbol_invoice_template").text(),r=i.split("/");t.template={fontSize:"16px",fontFamily:"Times New Roman",SYMBOLCODE:u,FORM:r[0]+"/",CODE:r[1],FORMCODE:i,logo:"",bg:"",status:4,borderRadius:"0px",borderWidth:"0px",style:n};LoadingHide()})}):(console.log("Load repeat..."),o())},300)};n.$watch("template.style",function(){if(t.template){var n=getCSS(t.template.style);$(".html-view-content").find("style").text(n)}},!0);n.ApplyInvoiceType=function(i){o();$(".close-details").click();var r=c+"LoadTemplate",e=JSON.stringify({tempid:i});LoadingShow();$(".modal-invoice-template-change").modal("show");u.PostDataAjax(r,e,function(i){i?i.rs?(t.htmlResult=f.trustAsHtml(i.res),o()):(n.ErrorMessage=i.msg,alert(n.ErrorMessage)):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - MeterController - GetMeter");LoadingHide()})};n.SaveTemplate=function(i){var r,f,e;LoadingShow();var o=$("div.logo.highlight-logo"),s=o.attr("style"),h=parseCSSText(s);t.template.style[".fix-logo-pos"]=h.style;r={};t.EditingTemplate&&(r.FORMCODE=t.EditingTemplate.FORMCODE,r.SYMBOLCODE=t.EditingTemplate.SYMBOLCODE,r.FROMNUMBER=t.EditingTemplate.FROMNUMBER,r.TONUMBER=t.EditingTemplate.TONUMBER);n.SizePaper.value==="2"&&(t.template.style.body["background-size"]="70%",t.template.style.body.height="720px");t.template.CSS=getCSS(t.template.style);t.template.TAXRATE=n.InvoiceType.value;f=c+"SaveTemplate";e=JSON.stringify({objNumberBO:t.template,templateFile:i,editingTemplate:r});u.PostDataAjax(f,e,function(n){n?(n.rs?typeof callback=="function"?callback(n):alert("Lưu thành công!"):alert(n.msg),LoadingHide()):(alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetInvoice"),LoadingHide())})};n.uploadFile=function(i){var f,u,o,e;for(n.isLoading=!0,f=i.target.files,u=0;u<f.length;u++)o=f[u],e=new FileReader,e.onload=function(i){r(function(){t.template.logo=i.target.result;n.ChangeLogo(t.template.logo);setResizable();reszieableLogo()},100)},e.readAsDataURL(o)};n.uploadBackground=function(i){var f,u,o,e;for(n.isLoading=!0,f=i.target.files,u=0;u<f.length;u++)o=f[u],e=new FileReader,e.onload=function(i){r(function(){t.template.bg=i.target.result;n.SetBackground(t.template.bg,"auto")},100)},e.readAsDataURL(o)};n.ChangeFontSize=function(){t.template.style["body, table, .bg"]["font-size"]=t.template.fontSize};n.ChangeFontFamily=function(){t.template.style["body, table, .bg"]["font-family"]=t.template.fontFamily};n.ChangeColor=function(n){t.template.style["body, table, .bg"].color=n+" !important"};n.SetBorderColor=function(n){t.template.style["#layer1"]["border-color"]=n;t.template.borderWidth==="0px"&&(t.template.borderWidth="3px",t.template.style["#layer1"]["border-width"]=t.template.borderWidth)};n.SetBorderRadius=function(){t.template.style["#layer1"]["border-radius"]=t.template.borderRadius};n.SetBorderWidth=function(){t.template.style["#layer1"]["border-width"]=t.template.borderWidth;t.template.style["#layer1"]["border-color"]==="#fff"&&(t.template.style["#layer1"]["border-color"]="#000")};n.SetBorderPattern=function(n){t.template.style["#layer1"]["background-image"]=n!=null&&n!=""?"url('"+n+"')":"none"};n.ChangeSerialNo=function(){$("#symbol_invoice_template").html(t.template.SYMBOLCODE)};n.ChangeForm=function(){t.template.FORMCODE=t.template.CODE.length==1?t.template.FORM+"00"+t.template.CODE:t.template.CODE.length==2?t.template.FORM+"0"+t.template.CODE:t.template.FORM+t.template.CODE;$("#form_invoice_template").html(t.template.FORMCODE)};n.ShowAgainCode=function(){t.template.CODE.length==1?t.template.CODE="00"+t.template.CODE:t.template.CODE.length==2&&(t.template.CODE="0"+t.template.CODE)};n.ChangeLogo=function(i){i!=null&&i!=""?(t.template.style[".logo"]["background-image"]="url('"+i+"')",t.template.style[".logo"].display="block",t.template.style[".logo"].position="relative",$(".logo").addClass("highlight-logo")):n.RemoveLogo()};n.RemoveLogo=function(){t.template.logo=null;t.template.style[".logo"]["background-image"]="none";t.template.style[".logo"].display="none";$('[type="file"]').val("");$(".logo").removeClass("highlight-logo")};n.SetBackground=function(i,r){i===""?(t.template.style["#layer1"]["background-image"]="none",t.template.bg=null,$('[type="file"]').val("")):t.template.style["#layer1"]["background-image"]="url('"+i+"')";n.template.style.body["background-size"]=r!=null?r:"100% 100%"};n.LoadSizePaper=function(){parseInt(n.SizePaper.value)==1?($("#div-template-a4")[0].setAttribute("style","display:block;"),$("#div-template-a5")[0].setAttribute("style","display:none;")):($("#div-template-a4")[0].setAttribute("style","display:none;"),$("#div-template-a5")[0].setAttribute("style","display:block;"))};n.ChangeQRCode=function(){var n=$(".qrcode");n.toggle()};$('[data-toggle="tooltip"]').tooltip({content:function(){return $(this).prop("title")},position:{my:"center top+15",at:"left bottom"}});LoadingHide()}]);POSITION_LOGO={Left:1,Right:2};app.controller("LogController",["$scope","$rootScope","$timeout","CommonFactory","persistObject",function(n,t,i,r){var u="/Log/";LoadingShow();n.LoadCookie_Log=function(){var t=getCookie("Novaon_LogManagement");t?n.cookie=JSON.parse(t):(n.cookie={FieldID:!0,FieldUserName:!0,FieldActionName:!0,FieldObjectName:!0,FieldIpAddress:!0,FieldDescription:!0,FieldLogTime:!0,RowNum:10},setCookie("Novaon_LogManagement",JSON.stringify(n.cookie),30))};n.Check=function(t,i){(n.cookie[i]=i=="RowNum"?t:!t,setCookie("Novaon_LogManagement",JSON.stringify(n.cookie),30),i=="RowNum")&&n.GetLog(n.currentpage)};t.ReloadLog=function(t){t==1&&(n.currentpage=t);n.GetLog(n.currentpage)};n.ResetGetLog=function(){n.LoadCookie_Log();n.ListLog=[]};n.Filter={KEYWORD:""};n.GetLog=function(t){n.ResetGetLog();n.IsLoading=!0;t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;n.IsLoading=!0;var i=u+"GetLogs",f=JSON.stringify({keyword:n.Filter.KEYWORD,currentPage:t,itemPerPage:n.cookie.RowNum});n.ListLog=[];n.TotalPages=1;n.TotalRow=1;LoadingShow();r.PostDataAjax(i,f,function(t){t?t.rs?(n.ListLog=t.result,n.TotalPages=t.TotalPages,n.TotalRow=t.TotalRow):n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - LogController - GetLog");LoadingHide()})};n.SelectAll=function(){var t=n.ListLog.filter(function(t){return t.ISSELECTED==n.IsSelectAll});t.length>0&&t.forEach(function(t){t.ISSELECTED=!n.IsSelectAll})};n.SeleteRow=function(t){var i=n.ListLog.filter(function(n){return n.ISSELECTED==!0});t?n.IsSelectAll=!1:i.length==n.ListLog.length-1&&(n.IsSelectAll=!0)};n.ToggleShowMore=function(n){$(n).fadeToggle(300)};n.ExportExcel=function(){var t,i,r,f;t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;i=u+"ExportExcell";r={keyword:n.Filter.KEYWORD,currentPage:t,itemPerPage:n.cookie.RowNum};LoadingShow();f=$.fileDownload(i,{httpMethod:"POST",data:r});LoadingHide()}}]);app.controller("CurrencyUnitController",["$scope","$rootScope","$timeout","CommonFactory","persistObject",function(n,t,i,r){var u="/CurrencyUnit/";n.Filter={KEYWORD:"",PRODUCTTYPE:0,CATEGORY:null};n.LoadCookie_Currency=function(){var t=getCookie("Novaon_CurrencyUnitManagement");t?n.cookie=JSON.parse(t):(n.cookie={FieldID:!0,FieldCurrencyUnit:!0,FieldIsActived:!0,RowNum:10},setCookie("Novaon_CurrencyUnitManagement",JSON.stringify(n.cookie),30))};n.Check=function(t,i){(n.cookie[i]=i=="RowNum"?t:!t,setCookie("Novaon_CurrencyUnitManagement",JSON.stringify(n.cookie),30),i=="RowNum")&&n.GetCurrencyUnit(n.currentpage)};t.ReloadCurrencyUnit=function(t){t==1&&(n.currentpage=t);n.GetCurrencyUnit(n.currentpage)};n.ResetGetCurrencyUnit=function(){n.LoadCookie_Currency();n.ListCurrencyUnit=[]};n.GetCurrencyUnit=function(t){n.ResetGetCurrencyUnit();n.IsLoading=!0;t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;var i=u+"GetCurrencyUnit",f=JSON.stringify({keyword:n.Filter.KEYWORD,pagesize:n.cookie.RowNum,currentpage:n.currentpage});LoadingShow();r.PostDataAjax(i,f,function(t){t?t.rs?(n.ListCurrencyUnit=t.result,n.TotalPages=t.TotalPages,n.TotalRow=t.TotalRow):n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetCategory");LoadingHide()});n.IsLoading=!1};n.SelectAll=function(){var t=n.ListCurrencyUnit.filter(function(t){return t.ISSELECTED==n.IsSelectAll});t.length>0&&t.forEach(function(t){t.ISSELECTED=!n.IsSelectAll})};n.SeleteRow=function(t){var i=n.ListCurrencyUnit.filter(function(n){return n.ISSELECTED==!0});t?n.IsSelectAll=!1:i.length==n.ListCurrencyUnit.length-1&&(n.IsSelectAll=!0)};n.RemoveCurrencyUnit=function(i){var f=function(f){var o,e;if(!f)return!1;if(n.ListCurrencyChecked=[],n.ListCurrencyActive=[],n.count=0,i){if(i.ISACTIVED==!0)return toastr.warning("Không được phép xóa khi đang ở trạng thái hoạt động"),!1;n.ListCurrencyChecked.push(i.ID);n.count=1}else{if(o=n.ListCurrencyUnit.filter(function(n){return n.ISSELECTED==!0}),o&&o.length===0){toastr.warning("Bạn chưa chọn tiền thanh toán cần xóa.");return}if(o&&Object.keys(o).length>0){for(e=0;e<o.length;e++)n.ListCurrencyChecked.push(o[e].ID),n.ListCurrencyActive.push(o[e].ISACTIVED);for(e=0;e<n.ListCurrencyActive.length;e++)n.ListCurrencyActive[e]===!1&&n.count++}}var s=n.ListCurrencyChecked.join(";"),h=u+"RemoveCurrencyUnit",c=JSON.stringify({id:s,count:n.count});LoadingShow();r.PostDataAjax(h,c,function(n){n&&n.rs?(toastr.success(n.msg),t.ReloadCurrencyUnit(1)):toastr.warning(n.msg);LoadingHide()})};confirm("Bạn có thực sự muốn xóa các tiền thanh toán đã chọn không?","Thông báo","Không","Có",f)};n.ExportExcell=function(){var t,i,r,f;t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;i=u+"ExportExcell";r={keyword:n.Filter.KEYWORD,pagesize:n.cookie.RowNum,currentpage:n.currentpage};LoadingShow();f=$.fileDownload(i,{httpMethod:"POST",data:r});LoadingHide()}}]);app.controller("ModalCurrencyUnitController",["$scope","$rootScope","$timeout","CommonFactory",function(n,t,i,r){var u="/CurrencyUnit/";n.currency={};t.ModalCurrency=function(t){angular.copy(t,n.currency);t===""&&(n.currency.ISACTIVED=!0)};n.AddCurrencyUnit=function(){if(!n.currency.CURRENCYUNIT)return alert("Vui lòng nhập vào tên tiền thanh toán"),!1;if(n.currency.CURRENCYUNIT.length>=512)return toastr.warning("Tên tiền thanh toán độ dài không quá 512 ký tự"),!1;n.IsLoading=!0;var i=u+"SaveCurrencyUnit",f=JSON.stringify({currency:n.currency});r.PostDataAjax(i,f,function(n){n?n.rs?(toastr.success("Cập nhật thành công"),$(".modal-currencyunit").modal("hide"),t.ReloadCurrencyUnit(1)):toastr.warning(n.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SaveCurrencyUnit")});n.IsLoading=!1};t.UpdateCurencyUnit=function(n){var f,e;let i="";if(n.COMTAXCODE=="1")return toastr.warning("Bạn không được phép thay đổi trạng thái này"),!1;f=u+"SaveCurrencyUnit";n.ISACTIVED==!0?(n.ISACTIVED=!1,i="Ngừng kích hoạt thành công"):(n.ISACTIVED=!0,i="Kích hoạt thành công");e=JSON.stringify({currency:n});r.PostDataAjax(f,e,function(n){n?n.rs?(toastr.success(i),t.ReloadCurrencyUnit(1)):toastr.warning(n.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SaveCurrencyUnit")})}}]);app.controller("PaymentMethodController",["$scope","$rootScope","$timeout","CommonFactory","persistObject",function(n,t,i,r){var u="/PaymentMethod/";n.Filter={KEYWORD:"",PRODUCTTYPE:0,CATEGORY:null};n.LoadCookie_Payment=function(){var t=getCookie("Novaon_PaymentManagement");t?n.cookie=JSON.parse(t):(n.cookie={FieldID:!0,FieldPaymentMethod:!0,FieldIsActived:!0,RowNum:10},setCookie("Novaon_PaymentManagement",JSON.stringify(n.cookie),30))};n.Check=function(t,i){(n.cookie[i]=i=="RowNum"?t:!t,setCookie("Novaon_PaymentManagement",JSON.stringify(n.cookie),30),i=="RowNum")&&n.GetPaymentMethod(n.currentpage)};t.ReloadPayment=function(t){t==1&&(n.currentpage=t);n.GetPaymentMethod(n.currentpage)};n.ResetGetPayment=function(){n.LoadCookie_Payment();n.ListPayment=[]};n.GetPaymentMethod=function(t){n.ResetGetPayment();n.IsLoading=!0;t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;var i=u+"GetPaymentMethod",f=JSON.stringify({keyword:n.Filter.KEYWORD,pagesize:n.cookie.RowNum,currentpage:n.currentpage});LoadingShow();r.PostDataAjax(i,f,function(t){t?t.rs?(n.ListPayment=t.result,n.TotalPages=t.TotalPages,n.TotalRow=t.TotalRow):n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetPaymentMethod");LoadingHide()});n.IsLoading=!1};n.SelectAll=function(){var t=n.ListPayment.filter(function(t){return t.ISSELECTED==n.IsSelectAll});t.length>0&&t.forEach(function(t){t.ISSELECTED=!n.IsSelectAll})};n.SeleteRow=function(t){var i=n.ListPayment.filter(function(n){return n.ISSELECTED==!0});t?n.IsSelectAll=!1:i.length==n.ListPayment.length-1&&(n.IsSelectAll=!0)};n.ExportExcell=function(){var t,i,r,f;t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;i=u+"ExportExcell";r={keyword:n.Filter.KEYWORD,pagesize:n.cookie.RowNum,currentpage:n.currentpage};LoadingShow();f=$.fileDownload(i,{httpMethod:"POST",data:r});LoadingHide()};n.RemovePaymentMethod=function(i){var f=function(f){var o,e;if(!f)return!1;if(n.count=0,n.ListPaymentChecked=[],n.ListPaymentActive=[],i){if(i.ISACTIVED==!0)return toastr.warning("Không được xóa khi đang ở trạng thái hoạt động"),!1;n.ListPaymentChecked.push(i.ID);n.count=1}else{if(o=n.ListPayment.filter(function(n){return n.ISSELECTED==!0}),o&&o.length===0){toastr.warning("Bạn chưa chọn HTTT cần xóa.");return}if(o&&Object.keys(o).length>0){for(e=0;e<o.length;e++)n.ListPaymentChecked.push(o[e].ID),n.ListPaymentActive.push(o[e].ISACTIVED);for(e=0;e<n.ListPaymentActive.length;e++)n.ListPaymentActive[e]===!1&&n.count++}}var s=n.ListPaymentChecked.join(";"),h=u+"RemovePaymentMethod",c=JSON.stringify({id:s,count:n.count});LoadingShow();r.PostDataAjax(h,c,function(n){n&&n.rs?(toastr.success(n.msg),t.ReloadPayment()):toastr.warning(n.msg);LoadingHide()})};confirm("Bạn có thực sự muốn xóa các HTTT đã chọn không?","Thông báo","Không","Có",f)}}]);app.controller("ModalPaymentMethodController",["$scope","$rootScope","$timeout","CommonFactory",function(n,t,i,r){var u="/PaymentMethod/";n.payment={};t.ModalPayment=function(t){angular.copy(t,n.payment);t===""&&(n.payment.ISACTIVED=!0)};n.SaveAndClosePayment=function(){if(!n.payment.PAYMENTMETHOD)return alert("Vui lòng nhập vào tên hình thức thanh toán"),!1;if(n.payment.PAYMENTMETHOD.length>=512)return toastr.warning("Tên HTTT độ dài không quá 512 ký tự"),!1;var i=u+"SavePaymentMethod",f=JSON.stringify({payment:n.payment});r.PostDataAjax(i,f,function(n){n?n.rs?(toastr.success("Cập nhật thành công"),$(".modal-payment").modal("hide"),t.ReloadPayment(1)):toastr.warning(n.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SavePaymentMethod")})};t.UpdatePaymentMethod=function(n){var f,e;let i="";if(n.COMTAXCODE=="1")return toastr.warning("Bạn không được phép thay đổi trạng thái này"),!1;f=u+"SavePaymentMethod";n.ISACTIVED==!0?(n.ISACTIVED=!1,i="Ngừng kích hoạt thành công"):(n.ISACTIVED=!0,i="Kích hoạt thành công");e=JSON.stringify({payment:n});r.PostDataAjax(f,e,function(n){n?n.rs?(toastr.success(i),t.ReloadPayment(1)):toastr.warning(n.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SavePaymentMethod")})}}]);app.controller("QuantityUnitController",["$scope","$rootScope","$timeout","CommonFactory","persistObject",function(n,t,i,r){var u="/QuantityUnit/";n.Filter={KEYWORD:"",PRODUCTTYPE:0,CATEGORY:null};n.LoadCookie_QuantityUnit=function(){var t=getCookie("Novaon_QuantityUnitManagement");t?n.cookie=JSON.parse(t):(n.cookie={FieldID:!0,FieldQuantityUnit:!0,RowNum:10},setCookie("Novaon_QuantityUnitManagement",JSON.stringify(n.cookie),30))};n.Check=function(t,i){(n.cookie[i]=i=="RowNum"?t:!t,setCookie("Novaon_QuantityUnitManagement",JSON.stringify(n.cookie),30),i=="RowNum")&&n.GetQuantityUnit(n.currentpage)};t.ReloadQuantityUnit=function(t){t==1&&(n.currentpage=t);n.GetQuantityUnit(n.currentpage)};n.ResetGetQuantityUnit=function(){n.LoadCookie_QuantityUnit();n.ListQuantityUnit=[]};n.GetQuantityUnit=function(t){n.ResetGetQuantityUnit();n.IsLoading=!0;t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;var i=u+"GetQuantityUnit",f=JSON.stringify({keyword:n.Filter.KEYWORD,pagesize:n.cookie.RowNum,currentpage:n.currentpage});LoadingShow();r.PostDataAjax(i,f,function(t){t?t.rs?(n.ListQuantityUnit=t.result,n.TotalPages=t.TotalPages,n.TotalRow=t.TotalRow):n.ErrorMessage=t.msg:alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - GetQuantityUnit");LoadingHide()});n.IsLoading=!1};n.SelectAll=function(){var t=n.ListQuantityUnit.filter(function(t){return t.ISSELECTED==n.IsSelectAll});t.length>0&&t.forEach(function(t){t.ISSELECTED=!n.IsSelectAll})};n.SeleteRow=function(t){var i=n.ListQuantityUnit.filter(function(n){return n.ISSELECTED==!0});t?n.IsSelectAll=!1:i.length==n.ListQuantityUnit.length-1&&(n.IsSelectAll=!0)};n.RemoveQuantityUnit=function(i){var f=function(f){var o,e;if(!f)return!1;if(n.count=0,n.ListQuantityChecked=[],n.ListQuantityActive=[],n.ListComtaxcode=[],i){if(i.ISACTIVED==!0){toastr.warning("Không được phép xóa trạng thái đang hoạt động");return}n.ListQuantityChecked.push(i.ID);n.count=1}else{if(o=n.ListQuantityUnit.filter(function(n){return n.ISSELECTED==!0}),o&&o.length===0){toastr.warning("Bạn chưa chọn đơn vị tính cần xóa.");return}if(o&&Object.keys(o).length>0){for(e=0;e<o.length;e++)n.ListQuantityChecked.push(o[e].ID),n.ListQuantityActive.push(o[e].ISACTIVED);for(e=0;e<n.ListQuantityActive.length;e++)n.ListQuantityActive[e]===!1&&n.count++}}var s=n.ListQuantityChecked.join(";"),h=u+"RemoveQuantityUnit",c=JSON.stringify({id:s,count:n.count});LoadingShow();r.PostDataAjax(h,c,function(n){n&&n.rs?(toastr.success(n.msg),t.ReloadQuantityUnit()):toastr.warning(n.msg);LoadingHide()})};confirm("Bạn có thực sự muốn xóa các đơn vị tính đã chọn không?","Thông báo","Không","Có",f)};n.ExportExcell=function(){var t,i,r,f;t||(t=1);t>n.TotalPages&&(t=n.TotalPages);n.currentpage=t;i=u+"ExportExcell";r={keyword:n.Filter.KEYWORD,pagesize:n.cookie.RowNum,currentpage:n.currentpage};LoadingShow();f=$.fileDownload(i,{httpMethod:"POST",data:r});LoadingHide()}}]);app.controller("ModalQuantityUnitController",["$scope","$rootScope","$timeout","CommonFactory",function(n,t,i,r){var u="/QuantityUnit/";n.quantityunit={};t.ModalQuantityUnit=function(t){angular.copy(t,n.quantityunit);t===""&&(n.quantityunit.ISACTIVED=!0)};n.AddQuantityUnit=function(){if(!n.quantityunit.QUANTITYUNIT)return alert("Vui lòng nhập vào tên đơn vị tính"),!1;if(n.quantityunit.QUANTITYUNIT.length>=512)return toastr.warning("Tên đơn vị tính độ dài không quá 512 ký tự"),!1;var i=u+"SaveQuantityUnit",f=JSON.stringify({quantityunit:n.quantityunit});r.PostDataAjax(i,f,function(n){n?n.rs?(toastr.success("Cập nhật thành công"),$(".modal-quantityunit").modal("hide"),t.ReloadQuantityUnit(1)):toastr.warning(n.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SaveQuantityUnit")})};t.UpdateQuantity=function(n){var f,e;let i="";if(n.COMTAXCODE=="1")return toastr.warning("Bạn không được phép thay đổi trạng thái này"),!1;f=u+"SaveQuantityUnit";n.ISACTIVED==!0?(n.ISACTIVED=!1,i="Ngừng kích hoạt thành công"):(n.ISACTIVED=!0,i="Kích hoạt thành công");e=JSON.stringify({quantityunit:n});r.PostDataAjax(f,e,function(n){n?n.rs?(toastr.success(i),t.ReloadQuantityUnit(1)):toastr.warning(n.msg):alert("Không nhận được phản hồi từ máy chủ, vui lòng thử lại (js) - SaveQuantityUnit")})}}]);